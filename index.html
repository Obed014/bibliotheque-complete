<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SystÃ¨me de BibliothÃ¨que Professionnel</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
:root {
  --primary:#2c3e50; --accent:#c0392b; --accent2:#e67e22;
  --light:#f8f4ef; --border:#e8e0d5; --text:#2c3e50; --muted:#7f8c8d;
  --shadow:0 4px 24px rgba(44,62,80,.10); --shadow-lg:0 12px 40px rgba(44,62,80,.18);
  --r:14px; --rs:8px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--light);min-height:100vh;color:var(--text)}
/* â”€â”€ Layout â”€â”€ */
.shell{display:flex;min-height:100vh}
.sidebar{width:260px;background:var(--primary);color:#fff;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100}
.sb-logo{padding:28px 24px 18px;border-bottom:1px solid rgba(255,255,255,.1)}
.sb-logo-img{width:52px;height:52px;border-radius:50%;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:26px;margin-bottom:10px;border:2px solid rgba(255,255,255,.2);object-fit:cover}
.sb-name{font-family:'DM Serif Display',serif;font-size:1.3em;line-height:1.2}
.sb-sub{font-size:.76em;opacity:.55;margin-top:3px}
.sb-nav{flex:1;padding:14px 0;overflow-y:auto}
.sb-nav button{display:flex;align-items:center;gap:13px;width:100%;padding:12px 24px;background:none;border:none;color:rgba(255,255,255,.7);font-size:.95em;font-weight:500;cursor:pointer;transition:all .2s;text-align:left;font-family:inherit;border-left:3px solid transparent}
.sb-nav button:hover{background:rgba(255,255,255,.08);color:#fff}
.sb-nav button.active{background:rgba(192,57,43,.22);color:#fff;border-left-color:var(--accent);font-weight:600}
.nav-icon{font-size:1.2em;width:24px;text-align:center}
.nav-badge{margin-left:auto;background:rgba(255,255,255,.15);border-radius:20px;padding:2px 8px;font-size:.76em;font-weight:700}
.sb-foot{padding:16px 20px;border-top:1px solid rgba(255,255,255,.1);display:flex;gap:7px;flex-wrap:wrap}
.sb-foot button{flex:1;min-width:60px;padding:8px 6px;border:1px solid rgba(255,255,255,.22);background:transparent;color:rgba(255,255,255,.78);border-radius:7px;font-size:.78em;cursor:pointer;font-family:inherit;transition:all .2s;text-align:center}
.sb-foot button:hover{background:rgba(255,255,255,.12);color:#fff}
.sb-foot .btn-zotero{background:rgba(206,43,55,.25);border-color:rgba(206,43,55,.5);color:#ffb3b3;width:100%;flex-basis:100%;margin-top:2px}
.sb-foot .btn-zotero:hover{background:rgba(206,43,55,.45);color:#fff}
.main{flex:1;margin-left:260px;padding:34px 34px 60px;max-width:calc(100vw - 260px)}
/* â”€â”€ Page header â”€â”€ */
.ph{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:12px}
.pt{font-family:'DM Serif Display',serif;font-size:2em;color:var(--primary)}
/* â”€â”€ Stats â”€â”€ */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:16px;margin-bottom:32px}
.sc{background:#fff;border-radius:var(--r);padding:22px;box-shadow:var(--shadow);border:1px solid var(--border);position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
.sc.blue::before{background:#3498db}.sc.green::before{background:#27ae60}
.sc.purple::before{background:#8e44ad}.sc.orange::before{background:var(--accent2)}
.sc.red::before{background:var(--accent)}
.sn{font-size:2.7em;font-weight:700;color:var(--primary);line-height:1;margin-bottom:5px}
.sl{font-size:.84em;color:var(--muted);font-weight:500}
/* â”€â”€ Buttons â”€â”€ */
.btn{padding:10px 20px;border:none;border-radius:var(--rs);font-size:.92em;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:7px;font-family:inherit}
.btn:active{transform:scale(.97)}
.btn-p{background:var(--accent);color:#fff;box-shadow:0 3px 10px rgba(192,57,43,.3)}.btn-p:hover{background:#a93226}
.btn-s{background:#27ae60;color:#fff}.btn-s:hover{background:#219a52}
.btn-d{background:#e74c3c;color:#fff}
.btn-2{background:#ecf0f1;color:var(--primary);border:1px solid var(--border)}.btn-2:hover{background:#dde4e6}
.btn-g{background:transparent;color:var(--muted);border:1px solid var(--border)}.btn-g:hover{background:var(--light);color:var(--primary)}
.btn-sm{padding:6px 13px;font-size:.82em}
/* â”€â”€ Search / Filter â”€â”€ */
.sw{position:relative;margin-bottom:18px}
.si{position:absolute;left:13px;top:50%;transform:translateY(-50%);pointer-events:none}
.sbar{width:100%;padding:11px 15px 11px 40px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:.95em;background:#fff;font-family:inherit;color:var(--text);transition:border-color .2s}
.sbar:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(192,57,43,.09)}
.fbar{display:flex;gap:11px;margin-bottom:18px;flex-wrap:wrap;align-items:center}
.fsel{padding:10px 13px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:.92em;background:#fff;cursor:pointer;font-family:inherit;color:var(--text)}
.fsel:focus{outline:none;border-color:var(--accent)}
/* â”€â”€ Cards â”€â”€ */
.grid{display:grid;gap:15px}
.card{background:#fff;border:1.5px solid var(--border);border-radius:var(--r);padding:20px;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.card:hover{box-shadow:var(--shadow);border-color:#c8bfb5}
.card.late{border-color:#f5c6cb;background:#fff9f9}
.ct{font-size:1.1em;font-weight:700;color:var(--primary);margin-bottom:3px}
.cs{color:var(--muted);font-size:.91em;margin-bottom:3px}
.cm{display:flex;gap:7px;flex-wrap:wrap;margin-top:11px}
.ca{display:flex;gap:7px;flex-wrap:wrap;margin-top:13px;padding-top:13px;border-top:1px solid var(--border)}
/* â”€â”€ Badges â”€â”€ */
.b{display:inline-block;padding:4px 11px;border-radius:20px;font-size:.79em;font-weight:600}
.bg{background:#d5f5e3;color:#1e8449}.br{background:#fadbd8;color:#922b21}
.bp{background:#e8daef;color:#76448a}.bb{background:#d6eaf8;color:#1a5276}
.bo{background:#fdebd0;color:#a04000}.bk{background:#ecf0f1;color:#5d6d7e}
/* â”€â”€ Modal â”€â”€ */
.ov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;animation:fi .15s;backdrop-filter:blur(4px)}
@keyframes fi{from{opacity:0}to{opacity:1}}
.mc{background:#fff;border-radius:18px;padding:34px;max-width:620px;width:92%;max-height:90vh;overflow-y:auto;animation:su .2s;box-shadow:var(--shadow-lg)}
.mc.wide{max-width:760px}
@keyframes su{from{transform:translateY(28px);opacity:0}to{transform:translateY(0);opacity:1}}
.mh{display:flex;justify-content:space-between;align-items:center;margin-bottom:26px}
.mt{font-family:'DM Serif Display',serif;font-size:1.65em;color:var(--primary)}
.xb{background:var(--light);border:none;font-size:1.25em;cursor:pointer;color:var(--muted);width:34px;height:34px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s}
.xb:hover{background:var(--border);color:var(--primary)}
/* â”€â”€ Forms â”€â”€ */
.fg{margin-bottom:16px}
.fl{display:block;font-weight:600;color:var(--text);margin-bottom:5px;font-size:.91em}
.fi,.ft{width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:.94em;transition:border-color .2s;font-family:inherit;color:var(--text);background:#fff}
.fi:focus,.ft:focus,.fsel:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(192,57,43,.08)}
.ft{resize:vertical;min-height:85px}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:13px}
.fac{display:flex;gap:11px;margin-top:26px}
/* â”€â”€ Photo upload â”€â”€ */
.pu{border:2px dashed var(--border);border-radius:var(--r);padding:22px;text-align:center;cursor:pointer;transition:all .2s}
.pu:hover{border-color:var(--accent);background:#fef9f8}
.pp{width:115px;height:115px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);margin:14px auto;display:block}
/* â”€â”€ Scanner â”€â”€ */
.scan-box{background:var(--primary);padding:26px;border-radius:var(--r);color:#fff;margin-bottom:26px}
.scan-in{width:100%;padding:15px 19px;border:none;border-radius:var(--rs);font-size:1.08em;font-weight:500;font-family:inherit}
.scan-st{margin-top:13px;padding:11px 17px;background:rgba(255,255,255,.15);border-radius:var(--rs);font-size:.97em}
/* â”€â”€ Category grid â”€â”€ */
.cg{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:13px;margin-bottom:30px}
.cc{background:#fff;border:1.5px solid var(--border);border-radius:var(--rs);padding:17px;text-align:center;cursor:pointer;transition:all .2s}
.cc:hover{border-color:var(--accent);box-shadow:var(--shadow)}
.cn{font-size:2.1em;font-weight:700;color:var(--accent)}
.cl{font-size:.83em;color:var(--muted);margin-top:4px;font-weight:500}
/* â”€â”€ Alerts â”€â”€ */
.al{padding:13px 17px;border-radius:var(--rs);margin-bottom:16px;display:flex;align-items:center;gap:11px;font-size:.94em;flex-wrap:wrap}
.al-w{background:#fef9e7;color:#7d6608;border:1px solid #f9e79f}
.al-s{background:#eafaf1;color:#1e8449;border:1px solid #a9dfbf}
.al-i{background:#eaf2ff;color:#1a5276;border:1px solid #a9cce3}
/* â”€â”€ Empty â”€â”€ */
.empty{text-align:center;padding:65px 20px;color:var(--muted)}
.empty-i{font-size:3.8em;margin-bottom:14px;opacity:.38}
/* â”€â”€ Settings section â”€â”€ */
.ss{background:#fff;border:1.5px solid var(--border);border-radius:var(--r);padding:22px;margin-bottom:18px}
.ss h3{font-size:1.03em;font-weight:700;color:var(--primary);margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:9px}
/* â”€â”€ QR / Avatar â”€â”€ */
.qr{width:98px;height:98px;border-radius:9px;flex-shrink:0}
.av{width:62px;height:62px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0;font-size:27px;display:flex;align-items:center;justify-content:center;background:#ecf0f1}
/* â”€â”€ Toasts â”€â”€ */
.tc{position:fixed;bottom:26px;right:26px;display:flex;flex-direction:column;gap:9px;z-index:9999;pointer-events:none}
.toast{background:var(--primary);color:#fff;padding:12px 18px;border-radius:var(--rs);box-shadow:var(--shadow-lg);font-size:.93em;font-weight:500;animation:ti .22s;min-width:210px;display:flex;align-items:center;gap:9px}
.toast.ok{background:#27ae60}.toast.err{background:var(--accent)}.toast.warn{background:var(--accent2)}
@keyframes ti{from{transform:translateX(55px);opacity:0}to{transform:translateX(0);opacity:1}}
/* â”€â”€ Zotero â”€â”€ */
.zdrop{border:2.5px dashed #a9cce3;border-radius:var(--r);padding:30px;text-align:center;cursor:pointer;background:#f8fbff;transition:border-color .2s;margin-bottom:16px}
.zdrop:hover{border-color:var(--accent)}
.zlist{max-height:330px;overflow-y:auto;border:1.5px solid var(--border);border-radius:var(--rs);margin-bottom:18px}
.zrow{display:flex;align-items:start;gap:13px;padding:12px 15px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.zrow:last-child{border-bottom:none}
.zrow:hover,.zrow.sel{background:#f0f7ff}
/* â”€â”€ Responsive â”€â”€ */
@media(max-width:768px){
  .sidebar{width:100%;height:auto;position:relative}
  .main{margin-left:0;padding:18px;max-width:100%}
  .fgrid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš™ï¸  CONFIGURATION SUPABASE
//  1. Allez sur supabase.com â†’ votre projet â†’ Settings â†’ API
//  2. Copiez "Project URL" et la clÃ© "anon / public" (commence par eyJ...)
//  3. Collez-les ci-dessous
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL = 'https://kokwzdfbypjvvqduuovk.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtva3d6ZGZieXBqdnZxZHV1b3ZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MDI1NTYsImV4cCI6MjA4NzQ3ODU1Nn0.fhPdFPa3Ap6SM6RK5bAs46bIBko3t-tBFm2w_fnKMn4';

const CATS = ['Fiction','Science','Histoire','Biographie','Enfants','Religion','Technologie','Art','Cuisine','Autre'];
const USE_SB = !!(SB_URL && SB_KEY && SB_KEY.startsWith('eyJ'));

// â”€â”€ Helpers localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gd(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch{ return []; } }
function sd(k,v){ localStorage.setItem(k,JSON.stringify(v)); }
function gsettings(){ try{ return JSON.parse(localStorage.getItem('lib_cfg')||'{}'); }catch{ return {}; } }
function gid(){ return Date.now()+Math.floor(Math.random()*9999); }
function today(){ return new Date().toISOString().split('T')[0]; }
function dlBlob(blob,name){ const u=URL.createObjectURL(blob),a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u); }

// â”€â”€ Supabase REST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sb(table, method='GET', body=null, qs=''){
  const url=`${SB_URL}/rest/v1/${table}${qs}`;
  const h={'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':'return=representation'};
  const r=await fetch(url,{method,headers:h,body:body?JSON.stringify(body):null});
  if(!r.ok){ const e=await r.text(); throw new Error(e); }
  const t=await r.text(); return t?JSON.parse(t):[];
}

// â”€â”€ Mappers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const toM = r=>({id:r.id,memberCode:r.member_code,name:r.name,email:r.email,phone:r.phone||'',address:r.address||'',dateOfBirth:r.date_of_birth||'',idNumber:r.id_number||'',photo:r.photo||'',joinDate:r.join_date});
const fromM = m=>{
  const o={member_code:m.memberCode,name:m.name,email:m.email};
  if(m.phone!==undefined) o.phone=m.phone||null;
  if(m.address!==undefined) o.address=m.address||null;
  if(m.photo!==undefined) o.photo=m.photo||null;
  if(m.dateOfBirth!==undefined) o.date_of_birth=m.dateOfBirth||null;
  if(m.idNumber!==undefined) o.id_number=m.idNumber||null;
  return o;
};
const toB = r=>({id:r.id,barcode:r.barcode,title:r.title,author:r.author,isbn:r.isbn||'',year:r.year||'',category:r.category||'Autre',publisher:r.publisher||'',shelf:r.shelf||'',copies:r.copies,available:r.available,description:r.description||'',addedDate:r.added_date});
const fromB = b=>({barcode:b.barcode,title:b.title,author:b.author,isbn:b.isbn||null,year:b.year||null,category:b.category,publisher:b.publisher||null,shelf:b.shelf||null,copies:b.copies,available:b.available,description:b.description||null});
const toL = r=>({id:r.id,bookId:r.book_id,memberId:r.member_id,loanDate:r.loan_date,dueDate:r.due_date,returnDate:r.return_date||null,daysLate:r.days_late||0,lateFee:r.late_fee||0});

// â”€â”€ DB layer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DB = {
  async getMembers(){
    if(!USE_SB) return gd('lib_members');
    return (await sb('members','GET',null,'?order=join_date.desc')).map(toM);
  },
  async getBooks(){
    if(!USE_SB) return gd('lib_books');
    return (await sb('books','GET',null,'?order=added_date.desc')).map(toB);
  },
  async getLoans(activeOnly=true){
    if(!USE_SB){
      const all=gd('lib_loans');
      return activeOnly ? all.filter(l=>!l.returnDate) : all;
    }
    const qs=activeOnly?'?return_date=is.null&order=loan_date.desc':'?order=loan_date.desc';
    return (await sb('loans','GET',null,qs)).map(toL);
  },
  async addMember(m){
    if(!USE_SB){ sd('lib_members',[...gd('lib_members'),m]); return m; }
    const r=await sb('members','POST',fromM(m));
    return toM(Array.isArray(r)?r[0]:r);
  },
  async updateMember(id,m){
    if(!USE_SB){ sd('lib_members',gd('lib_members').map(x=>x.id===id?{...x,...m}:x)); return; }
    await sb('members','PATCH',fromM(m),`?id=eq.${id}`);
  },
  async deleteMember(id){
    if(!USE_SB){ sd('lib_members',gd('lib_members').filter(x=>x.id!==id)); return; }
    await sb('members','DELETE',null,`?id=eq.${id}`);
  },
  async addBook(b){
    if(!USE_SB){ sd('lib_books',[...gd('lib_books'),b]); return b; }
    const r=await sb('books','POST',fromB(b));
    return toB(Array.isArray(r)?r[0]:r);
  },
  async updateBook(id,b){
    if(!USE_SB){ sd('lib_books',gd('lib_books').map(x=>x.id===id?{...x,...b}:x)); return; }
    await sb('books','PATCH',fromB(b),`?id=eq.${id}`);
  },
  async deleteBook(id){
    if(!USE_SB){ sd('lib_books',gd('lib_books').filter(x=>x.id!==id)); return; }
    await sb('books','DELETE',null,`?id=eq.${id}`);
  },
  async setAvail(id,delta){
    if(!USE_SB){
      const all=gd('lib_books'),b=all.find(x=>x.id===id);
      if(b){b.available=Math.min(b.copies,Math.max(0,b.available+delta));sd('lib_books',all);}
      return;
    }
    const rows=await sb('books','GET',null,`?id=eq.${id}&select=available,copies`);
    if(rows.length) await sb('books','PATCH',{available:Math.min(rows[0].copies,Math.max(0,rows[0].available+delta))},`?id=eq.${id}`);
  },
  async addLoan(l){
    if(!USE_SB){ sd('lib_loans',[...gd('lib_loans'),l]); return l; }
    const r=await sb('loans','POST',{book_id:l.bookId,member_id:l.memberId,loan_date:l.loanDate,due_date:l.dueDate});
    return toL(Array.isArray(r)?r[0]:r);
  },
  async returnLoan(id,daysLate,lateFee){
    if(!USE_SB){ sd('lib_loans',gd('lib_loans').map(l=>l.id===id?{...l,returnDate:new Date().toISOString(),daysLate,lateFee}:l)); return; }
    await sb('loans','PATCH',{return_date:new Date().toISOString(),days_late:daysLate,late_fee:lateFee},`?id=eq.${id}`);
  },
  async bulkAddBooks(arr){
    if(!USE_SB){ sd('lib_books',[...gd('lib_books'),...arr]); return arr; }
    const r=await sb('books','POST',arr.map(fromB));
    return (Array.isArray(r)?r:[r]).map(toB);
  }
};

// â”€â”€ Zotero parsers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseBib(txt){
  // Parse BibTeX by splitting on lines â€” avoids { } in regex which breaks Babel
  const res=[], lines=txt.split('\n'), cm={book:'Autre',article:'Science',inproceedings:'Science',phdthesis:'Science',mastersthesis:'Science',techreport:'Technologie',manual:'Technologie'};
  let cur=null;
  for(const raw of lines){
    const line=raw.trim();
    if(/^@\w+\s*\x7B/.test(line)){
      const t=(line.match(/^@(\w+)/)||[])[1]||'misc';
      cur={type:t.toLowerCase(),fields:{}};
      res.push(cur);
    } else if(cur && line.includes('=')){
      const eq=line.indexOf('=');
      const key=line.slice(0,eq).trim().toLowerCase();
      let val=line.slice(eq+1).trim();
      if(val.charAt(0)==='\x7B') val=val.slice(1);
      if(val.slice(-2)==='\x7D,') val=val.slice(0,-2);
      else if(val.slice(-1)===',') val=val.slice(0,-1);
      else if(val.slice(-1)==='\x7D') val=val.slice(0,-1);
      if(key && val) cur.fields[key]=(cur.fields[key]?cur.fields[key]+' ':'')+val.replace(/\s+/g,' ').trim();
    }
  }
  return res.filter(e=>e.fields.title).map(e=>{
    const f=e.fields;
    return {title:f.title||'',author:(f.author||f.editor||'').replace(/ and /gi,', '),isbn:f.isbn||f.isbn13||'',publisher:f.publisher||'',year:f.year||'',description:f.abstract||'',category:cm[e.type]||'Autre',shelf:'',copies:1};
  });
}
function parseRIS(txt){
  const res=[];
  txt.split(/\nER\s*-/).forEach(block=>{
    const f={};
    block.split('\n').forEach(line=>{const m=line.match(/^([A-Z][A-Z0-9])\s+-\s+(.+)$/);if(m){if(!f[m[1]])f[m[1]]=[];f[m[1]].push(m[2].trim());}});
    const title=(f['TI']||f['T1']||f['BT']||[''])[0];if(!title)return;
    const ty=(f['TY']||['BOOK'])[0];
    const cm={BOOK:'Autre',JOUR:'Science',CONF:'Science',THES:'Science',RPRT:'Technologie',COMP:'Technologie'};
    res.push({title,author:(f['AU']||f['A1']||[]).join(', '),year:((f['PY']||f['Y1']||[''])[0]).substring(0,4),isbn:(f['SN']||[''])[0],publisher:(f['PB']||[''])[0],description:(f['AB']||f['N2']||[''])[0],category:cm[ty]||'Autre',shelf:'',copies:1});
  });
  return res;
}
function parseCSV(txt){
  function pl(line){const res=[];let cur='',q=false;for(let i=0;i<line.length;i++){const c=line[i];if(c==='"'&&line[i+1]==='"'){cur+='"';i++;}else if(c==='"'){q=!q;}else if(c===','&&!q){res.push(cur);cur='';}else{cur+=c;}}res.push(cur);return res;}
  const lines=txt.split('\n').filter(l=>l.trim());if(lines.length<2)return[];
  const hdrs=pl(lines[0]).map(h=>h.trim().toLowerCase());
  const col=(...ns)=>{for(const n of ns){const i=hdrs.indexOf(n);if(i!==-1)return i;}return -1;};
  const res=[];
  for(let i=1;i<lines.length;i++){
    const v=pl(lines[i]);
    const g=(...ns)=>{const i=col(...ns);return i!==-1?(v[i]||'').trim():'';};
    const title=g('title');if(!title)continue;
    const ty=g('item type','type','itemtype').toLowerCase().replace(/\s/g,'');
    const cm={book:'Autre',journalarticle:'Science',conferencepaper:'Science',thesis:'Science',report:'Technologie',computerprogram:'Technologie',artwork:'Art'};
    res.push({title,author:g('author','authors'),year:g('publication year','year','date').substring(0,4),isbn:g('isbn','isbn/issn'),publisher:g('publisher'),description:g('abstract note','abstract'),category:cm[ty]||'Autre',shelf:'',copies:1});
  }
  return res;
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Toasts({list}){
  return <div className="tc">{list.map(t=><div key={t.id} className={`toast ${t.cls}`}><span>{t.icon}</span><span>{t.msg}</span></div>)}</div>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App(){
  const [tab,setTab]=useState('dashboard');
  const [members,setMembers]=useState([]);
  const [books,setBooks]=useState([]);
  const [loans,setLoans]=useState([]);
  const [history,setHistory]=useState([]);
  const [loading,setLoading]=useState(true);
  const [modal,setModal]=useState(null);
  const [search,setSearch]=useState('');
  const [catF,setCatF]=useState('all');
  const [scanVal,setScanVal]=useState('');
  const [scanSt,setScanSt]=useState('');
  const [scanItem,setScanItem]=useState(null);
  const [toasts,setToasts]=useState([]);
  const [cfg,setCfg]=useState({libraryName:'Ma BibliothÃ¨que',libraryLogo:'',loanDays:14,feePerDay:10});
  // forms
  const [mf,setMf]=useState({name:'',email:'',phone:'',address:'',dateOfBirth:'',idNumber:'',photo:''});
  const [bf,setBf]=useState({title:'',author:'',isbn:'',year:'',category:'Fiction',publisher:'',shelf:'',copies:1,description:''});
  const [editM,setEditM]=useState(null);
  const [editB,setEditB]=useState(null);
  // zotero
  const [zp,setZp]=useState([]);
  const [zst,setZst]=useState('');
  // refs
  const scanRef=useRef(),logoRef=useRef(),photoRef=useRef(),importRef=useRef(),zRef=useRef();

  // â”€â”€ Init â”€â”€
  useEffect(()=>{
    const s=gsettings(); if(s&&s.libraryName) setCfg(prev=>({...prev,...s}));
    reload();
  },[]);
  useEffect(()=>{ if(tab==='scanner'&&scanRef.current) scanRef.current.focus(); },[tab]);

  async function reload(){
    setLoading(true);
    try{
      const[m,b,l,h]=await Promise.all([DB.getMembers(),DB.getBooks(),DB.getLoans(true),DB.getLoans(false)]);
      setMembers(m);setBooks(b);setLoans(l);setHistory(h);
    }catch(e){ toast(e.message,'err','âŒ'); }
    finally{ setLoading(false); }
  }

  // â”€â”€ Toast â”€â”€
  function toast(msg,cls='ok',icon='âœ…'){
    const id=gid();
    setToasts(p=>[...p,{id,msg,cls,icon}]);
    setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),3500);
  }

  const close=()=>setModal(null);

  // â”€â”€ Settings â”€â”€
  function saveCfg(s){ setCfg(s); localStorage.setItem('lib_cfg',JSON.stringify(s)); toast('ParamÃ¨tres sauvegardÃ©s !'); close(); }

  // â”€â”€ Members â”€â”€
  async function saveMember(){
    if(!mf.name||!mf.email){ toast('Nom et email requis','err','âš ï¸'); return; }
    try{
      if(editM){ await DB.updateMember(editM.id,mf); toast('Membre mis Ã  jour !'); }
      else{
        const all=await DB.getMembers();
        const maxN=all.reduce((mx,m)=>Math.max(mx,parseInt((m.memberCode||'').replace('MBR-','')||0)),0);
        await DB.addMember({...mf,id:gid(),memberCode:`MBR-${String(maxN+1).padStart(4,'0')}`,joinDate:new Date().toISOString()});
        toast('Membre ajoutÃ© !');
      }
      setMf({name:'',email:'',phone:'',address:'',dateOfBirth:'',idNumber:'',photo:''});
      setEditM(null); close(); reload();
    }catch(e){ toast(e.message,'err','âŒ'); }
  }
  async function delMember(id){
    if(!confirm('Supprimer ce membre ?')) return;
    if(loans.some(l=>l.memberId===id)){ toast('Membre avec prÃªts actifs','err','âŒ'); return; }
    try{ await DB.deleteMember(id); toast('Membre supprimÃ©'); reload(); }
    catch(e){ toast(e.message,'err','âŒ'); }
  }
  function openEditM(m){ setMf({...m}); setEditM(m); setModal('member'); }

  // â”€â”€ Books â”€â”€
  async function saveBook(){
    if(!bf.title||!bf.author){ toast('Titre et auteur requis','err','âš ï¸'); return; }
    try{
      const copies=parseInt(bf.copies)||1;
      if(editB){ await DB.updateBook(editB.id,{...bf,copies}); toast('Livre mis Ã  jour !'); }
      else{
        const all=await DB.getBooks();
        const maxN=all.reduce((mx,b)=>Math.max(mx,parseInt((b.barcode||'').replace('BOOK-','')||0)),0);
        await DB.addBook({...bf,copies,available:copies,id:gid(),barcode:`BOOK-${String(maxN+1).padStart(4,'0')}`,addedDate:new Date().toISOString()});
        toast('Livre ajoutÃ© !');
      }
      setBf({title:'',author:'',isbn:'',year:'',category:'Fiction',publisher:'',shelf:'',copies:1,description:''});
      setEditB(null); close(); reload();
    }catch(e){ toast(e.message,'err','âŒ'); }
  }
  async function delBook(id){
    if(!confirm('Supprimer ce livre ?')) return;
    if(loans.some(l=>l.bookId===id)){ toast('Livre actuellement prÃªtÃ©','err','âŒ'); return; }
    try{ await DB.deleteBook(id); toast('Livre supprimÃ©'); reload(); }
    catch(e){ toast(e.message,'err','âŒ'); }
  }
  function openEditB(b){ setBf({...b}); setEditB(b); setModal('book'); }

  // â”€â”€ Loans â”€â”€
  async function createLoan(bookId,memberId){
    const bk=books.find(b=>b.id===bookId);
    if(!bk||bk.available<=0){ toast('Livre non disponible','err','âŒ'); return; }
    try{
      const due=new Date(); due.setDate(due.getDate()+(cfg.loanDays||14));
      await DB.addLoan({id:gid(),bookId,memberId,loanDate:new Date().toISOString(),dueDate:due.toISOString(),returnDate:null});
      await DB.setAvail(bookId,-1);
      toast('PrÃªt crÃ©Ã© !'); setScanVal(''); setScanSt('âœ… PrÃªt enregistrÃ© !');
      setTimeout(()=>setScanSt(''),3000); reload();
    }catch(e){ toast(e.message,'err','âŒ'); }
  }
  async function returnLoan(loanId){
    const loan=loans.find(l=>l.id===loanId); if(!loan) return;
    const now=new Date(),due=new Date(loan.dueDate);
    const daysLate=Math.max(0,Math.ceil((now-due)/(86400000)));
    const lateFee=daysLate*(cfg.feePerDay||10);
    try{
      await DB.returnLoan(loanId,daysLate,lateFee);
      await DB.setAvail(loan.bookId,+1);
      if(daysLate>0) toast(`${daysLate}j retard â€” ${lateFee} HTG`,'warn','âš ï¸');
      else toast('Retour enregistrÃ© !');
      reload();
    }catch(e){ toast(e.message,'err','âŒ'); }
  }

  // â”€â”€ Scanner â”€â”€
  function handleScan(e){
    if(e.key!=='Enter'||!scanVal.trim()) return;
    const code=scanVal.trim().toUpperCase();
    if(code.startsWith('MBR-')){
      const m=members.find(x=>x.memberCode===code);
      if(m){ setScanItem({type:'member',data:m}); setScanSt(`âœ… Membre: ${m.name}`); }
      else setScanSt('âŒ Membre non trouvÃ©');
    } else {
      const b=books.find(x=>x.barcode===code||x.isbn===code||(x.isbn||'').replace(/-/g,'')===code);
      if(b){
        if(scanItem&&scanItem.type==='member'){ createLoan(b.id,scanItem.data.id); setScanItem(null); }
        else{ setScanItem({type:'book',data:b}); setScanSt(`âœ… Livre: ${b.title}`); }
      } else setScanSt('âŒ Code non trouvÃ©');
    }
    setScanVal('');
  }

  // â”€â”€ Export â”€â”€
  async function exportCSV(){
    const bom='\ufeff';
    let csv=bom+'Type,Code,Nom/Titre,Email/Auteur,TÃ©l/ISBN,Statut,Date\n';
    members.forEach(m=>{ csv+=`Membre,"${m.memberCode}","${m.name}","${m.email}","${m.phone||''}",Actif,${new Date(m.joinDate).toLocaleDateString('fr-FR')}\n`; });
    books.forEach(b=>{ csv+=`Livre,"${b.barcode}","${b.title}","${b.author}","${b.isbn||''}","${b.available}/${b.copies}",${new Date(b.addedDate).toLocaleDateString('fr-FR')}\n`; });
    history.forEach(l=>{
      const bk=books.find(x=>x.id===l.bookId),mb=members.find(x=>x.id===l.memberId);
      csv+=`PrÃªt,"${l.id}","${bk?.title||''}","${mb?.name||''}","${new Date(l.dueDate).toLocaleDateString('fr-FR')}","${l.returnDate?'RetournÃ©':'En cours'}",${new Date(l.loanDate).toLocaleDateString('fr-FR')}\n`;
    });
    dlBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}),`bibliotheque-${today()}.csv`);
    toast('Export CSV tÃ©lÃ©chargÃ© !');
  }
  async function exportJSON(){
    const data={members,books,loans:history,settings:cfg,exportDate:new Date().toISOString()};
    dlBlob(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),`backup-${today()}.json`);
    toast('Sauvegarde JSON tÃ©lÃ©chargÃ©e !');
  }
  function importJSON(e){
    const file=e.target.files[0]; if(!file) return;
    const r=new FileReader();
    r.onload=ev=>{ try{
      const d=JSON.parse(ev.target.result);
      if(d.members) sd('lib_members',d.members);
      if(d.books) sd('lib_books',d.books);
      if(d.loans) sd('lib_loans',d.loans);
      if(d.settings) localStorage.setItem('lib_cfg',JSON.stringify(d.settings));
      reload(); toast('DonnÃ©es importÃ©es !');
    }catch{ toast('Fichier invalide','err','âŒ'); } };
    r.readAsText(file,'UTF-8'); e.target.value='';
  }

  // â”€â”€ Zotero â”€â”€
  function handleZFile(e){
    const file=e.target.files[0]; if(!file) return;
    setZst('Analyse en cours...'); setZp([]);
    const r=new FileReader();
    r.onload=ev=>{
      const txt=ev.target.result,ext=file.name.split('.').pop().toLowerCase();
      let parsed=[];
      if(ext==='bib') parsed=parseBib(txt);
      else if(ext==='ris') parsed=parseRIS(txt);
      else if(ext==='csv') parsed=parseCSV(txt);
      else{ setZst('âŒ Format non supportÃ© (.bib, .ris, .csv)'); return; }
      if(!parsed.length) setZst('âŒ Aucune rÃ©fÃ©rence trouvÃ©e.');
      else{ setZp(parsed.map((b,i)=>({...b,_s:true,_i:i}))); setZst(`âœ… ${parsed.length} rÃ©fÃ©rence(s) trouvÃ©e(s)`); }
    };
    r.readAsText(file,'UTF-8'); e.target.value='';
  }
  async function doZotero(){
    const toImport=zp.filter(b=>b._s);
    if(!toImport.length){ toast('SÃ©lectionnez au moins un livre','err','âš ï¸'); return; }
    try{
      const all=await DB.getBooks();
      let maxN=all.reduce((mx,b)=>Math.max(mx,parseInt((b.barcode||'').replace('BOOK-','')||0)),0);
      let skip=0; const nb=[];
      toImport.forEach(b=>{
        if(all.find(x=>x.title?.toLowerCase()===b.title?.toLowerCase()&&x.author?.toLowerCase()===b.author?.toLowerCase())){ skip++; return; }
        maxN++;
        nb.push({title:b.title,author:b.author,isbn:b.isbn,publisher:b.publisher,year:b.year,category:b.category,description:b.description,shelf:b.shelf||'',copies:1,available:1,id:gid(),barcode:`BOOK-${String(maxN).padStart(4,'0')}`,addedDate:new Date().toISOString()});
      });
      if(nb.length) await DB.bulkAddBooks(nb);
      reload(); setZp([]); setZst(''); close();
      toast(skip>0?`${nb.length} importÃ©(s), ${skip} doublon(s) ignorÃ©(s)`:`${nb.length} livre(s) importÃ©(s) !`, skip>0?'warn':'ok', 'ğŸ“š');
    }catch(e){ toast(e.message,'err','âŒ'); }
  }

  // â”€â”€ Print card â”€â”€
  function printCard(member){
    const qr=`https://api.qrserver.com/v1/create-qr-code/?size=130x130&data=${encodeURIComponent(member.memberCode)}`;
    const bar=`https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(member.memberCode)}&code=Code128&dpi=200`;
    const html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
<style>
*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#e8e8e8;display:flex;justify-content:center;padding:28px}
@media print{body{background:#e8e8e8!important;padding:0}}
</style></head><body>
<div style="width:420px;background:linear-gradient(135deg,#2c3e50,#34495e);border-radius:18px;overflow:hidden;color:white;box-shadow:0 12px 40px rgba(0,0,0,.35)">
  <div style="background:rgba(255,255,255,.13);padding:20px 26px;display:flex;align-items:center;gap:16px;border-bottom:1px solid rgba(255,255,255,.1)">
    ${cfg.libraryLogo?`<img src="${cfg.libraryLogo}" style="width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.4)">`:`<div style="width:52px;height:52px;border-radius:50%;background:rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-size:26px">ğŸ“š</div>`}
    <div><div style="font-size:19px;font-weight:bold">${cfg.libraryName}</div><div style="font-size:11px;opacity:.65;margin-top:2px">CARTE DE MEMBRE</div></div>
  </div>
  <div style="padding:22px 26px">
    <div style="display:flex;gap:18px;align-items:center;margin-bottom:20px">
      ${member.photo?`<img src="${member.photo}" style="width:100px;height:100px;border-radius:50%;border:4px solid white;object-fit:cover;flex-shrink:0">`:`<div style="width:100px;height:100px;border-radius:50%;border:4px solid white;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:44px;flex-shrink:0">ğŸ‘¤</div>`}
      <div style="flex:1;background:white;border-radius:10px;padding:10px;text-align:center">
        <img src="${qr}" style="width:110px;height:110px;display:block;margin:0 auto">
        <div style="font-size:10px;color:#666;margin-top:5px">Scan rapide</div>
      </div>
    </div>
    <div style="background:rgba(255,255,255,.15);border-radius:10px;padding:14px 16px;margin-bottom:16px">
      <div style="font-size:14px;margin:6px 0"><b>Nom:</b> ${member.name}</div>
      <div style="font-size:14px;margin:6px 0"><b>Email:</b> ${member.email}</div>
      ${member.phone?`<div style="font-size:14px;margin:6px 0"><b>TÃ©l:</b> ${member.phone}</div>`:''}
      ${member.idNumber?`<div style="font-size:14px;margin:6px 0"><b>ID:</b> ${member.idNumber}</div>`:''}
      <div style="font-size:14px;margin:6px 0"><b>Depuis:</b> ${new Date(member.joinDate).toLocaleDateString('fr-FR')}</div>
    </div>
    <div style="text-align:center;font-size:18px;font-weight:bold;letter-spacing:4px;padding:12px;background:rgba(192,57,43,.55);border-radius:9px;margin-bottom:14px">${member.memberCode}</div>
    <div style="background:white;border-radius:9px;padding:12px;text-align:center">
      <img src="${bar}" style="height:55px;max-width:100%">
      <div style="font-size:10px;color:#555;margin-top:5px;letter-spacing:2px">${member.memberCode}</div>
    </div>
  </div>
</div>
</body></html>`;
    let iframe=document.getElementById('_pf');
    if(!iframe){ iframe=document.createElement('iframe'); iframe.id='_pf'; iframe.style.cssText='position:fixed;top:-9999px;left:-9999px;width:600px;height:800px;border:none'; document.body.appendChild(iframe); }
    iframe.onload=()=>{
      const imgs=iframe.contentDocument.querySelectorAll('img');
      let done=0;
      const tryPrint=()=>{ if(++done>=imgs.length) setTimeout(()=>iframe.contentWindow.print(),200); };
      if(!imgs.length) setTimeout(()=>iframe.contentWindow.print(),200);
      else imgs.forEach(img=>{ if(img.complete)tryPrint(); else{img.onload=tryPrint;img.onerror=tryPrint;} });
    };
    iframe.srcdoc=html;
  }

  // â”€â”€ Computed â”€â”€
  const fMembers=members.filter(m=>(m.name||'').toLowerCase().includes(search.toLowerCase())||(m.email||'').toLowerCase().includes(search.toLowerCase())||(m.memberCode||'').toLowerCase().includes(search.toLowerCase()));
  const fBooks=books.filter(b=>{
    const ms=(b.title||'').toLowerCase().includes(search.toLowerCase())||(b.author||'').toLowerCase().includes(search.toLowerCase())||(b.isbn||'').toLowerCase().includes(search.toLowerCase())||(b.barcode||'').toLowerCase().includes(search.toLowerCase());
    return ms&&(catF==='all'||b.category===catF);
  });
  const cStats=CATS.reduce((a,c)=>({...a,[c]:books.filter(b=>b.category===c).length}),{});
  const overdue=loans.filter(l=>new Date(l.dueDate)<new Date());

  // â”€â”€ Loading screen â”€â”€
  if(loading) return(
    <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100vh',gap:18,background:'var(--light)'}}>
      <div style={{fontSize:'3em'}}>ğŸ“š</div>
      <div style={{fontSize:'1.05em',color:'var(--muted)',fontWeight:500}}>Chargement{USE_SB?' depuis Supabase':''}â€¦</div>
    </div>
  );

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  return(
  <div className="shell">
    <Toasts list={toasts}/>

    {/* â”€â”€ Sidebar â”€â”€ */}
    <aside className="sidebar">
      <div className="sb-logo">
        {cfg.libraryLogo?<img src={cfg.libraryLogo} className="sb-logo-img" style={{display:'block'}} alt=""/>:<div className="sb-logo-img">ğŸ“š</div>}
        <div className="sb-name">{cfg.libraryName}</div>
        <div className="sb-sub">{USE_SB?'ğŸŸ¢ Cloud Supabase':'ğŸŸ¡ Local'}</div>
      </div>
      <nav className="sb-nav">
        {[{k:'dashboard',i:'ğŸ“Š',l:'Tableau de bord'},{k:'scanner',i:'ğŸ”',l:'Scanner USB'},{k:'members',i:'ğŸ‘¥',l:'Membres',n:members.length},{k:'books',i:'ğŸ“š',l:'Livres',n:books.length},{k:'loans',i:'ğŸ“–',l:'PrÃªts actifs',n:loans.length},{k:'history',i:'ğŸ—‚ï¸',l:'Historique',n:history.length}].map(item=>(
          <button key={item.k} className={tab===item.k?'active':''} onClick={()=>{setTab(item.k);setSearch('');setCatF('all');}}>
            <span className="nav-icon">{item.i}</span><span>{item.l}</span>
            {item.n!==undefined&&<span className="nav-badge">{item.n}</span>}
          </button>
        ))}
      </nav>
      <div className="sb-foot">
        <button onClick={exportCSV}>ğŸ“Š CSV</button>
        <button onClick={exportJSON}>ğŸ’¾ Backup</button>
        <input type="file" accept=".json" ref={importRef} style={{display:'none'}} onChange={importJSON}/>
        <button onClick={()=>importRef.current.click()}>ğŸ“¥ Import</button>
        <button onClick={()=>setModal('settings')} style={{width:'100%',flexBasis:'100%',marginTop:2}}>âš™ï¸ ParamÃ¨tres</button>
        <button className="btn-zotero" onClick={()=>{setZp([]);setZst('');setModal('zotero');}}>ğŸ“¥ Importer depuis Zotero</button>
      </div>
    </aside>

    {/* â”€â”€ Main â”€â”€ */}
    <main className="main">

      {/* DASHBOARD */}
      {tab==='dashboard'&&(
        <div>
          <div className="ph"><h1 className="pt">Tableau de bord</h1><button className="btn btn-2" onClick={reload}>ğŸ”„ Actualiser</button></div>
          {overdue.length>0&&<div className="al al-w">âš ï¸ <strong>{overdue.length} prÃªt(s) en retard</strong></div>}
          <div className="stats">
            <div className="sc blue"><div className="sn">{members.length}</div><div className="sl">Membres</div></div>
            <div className="sc green"><div className="sn">{books.length}</div><div className="sl">Livres</div></div>
            <div className="sc purple"><div className="sn">{loans.length}</div><div className="sl">PrÃªts actifs</div></div>
            <div className="sc orange"><div className="sn">{books.reduce((s,b)=>s+(b.available||0),0)}</div><div className="sl">Disponibles</div></div>
            <div className="sc red"><div className="sn">{overdue.length}</div><div className="sl">En retard</div></div>
            <div className="sc blue"><div className="sn">{history.length}</div><div className="sl">Total prÃªts</div></div>
          </div>
          <h2 style={{fontFamily:"'DM Serif Display',serif",fontSize:'1.45em',marginBottom:16,color:'var(--primary)'}}>Par catÃ©gorie</h2>
          <div className="cg">
            {CATS.map(c=><div key={c} className="cc" onClick={()=>{setTab('books');setCatF(c);}}><div className="cn">{cStats[c]||0}</div><div className="cl">{c}</div></div>)}
          </div>
          {overdue.length>0&&<>
            <h2 style={{fontFamily:"'DM Serif Display',serif",fontSize:'1.45em',marginBottom:16,color:'var(--primary)'}}>âš ï¸ Retards</h2>
            <div className="grid">
              {overdue.map(loan=>{
                const mb=members.find(m=>m.id===loan.memberId),bk=books.find(b=>b.id===loan.bookId);
                const dl=Math.ceil((new Date()-new Date(loan.dueDate))/86400000);
                return(<div key={loan.id} className="card late">
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:14}}>
                    <div><div className="ct">{bk?.title||'?'}</div><div className="cs">ğŸ‘¤ {mb?.name} â€” {mb?.email}</div>
                    <div style={{color:'var(--accent)',fontWeight:700,marginTop:6}}>âš ï¸ {dl}j retard â€” {dl*(cfg.feePerDay||10)} HTG</div></div>
                    <button className="btn btn-s btn-sm" onClick={()=>returnLoan(loan.id)}>âœ“ Retourner</button>
                  </div>
                </div>);
              })}
            </div>
          </>}
        </div>
      )}

      {/* SCANNER */}
      {tab==='scanner'&&(
        <div>
          <div className="ph"><h1 className="pt">Scanner USB</h1></div>
          <div className="scan-box">
            <h2 style={{fontSize:'1.35em',marginBottom:10}}>ğŸ” Zone de scan</h2>
            <p style={{opacity:.75,marginBottom:16,fontSize:'.94em'}}>Scannez la carte membre puis le livre pour crÃ©er un prÃªt</p>
            <input ref={scanRef} type="text" className="scan-in" value={scanVal} onChange={e=>setScanVal(e.target.value)} onKeyPress={handleScan} placeholder="Pointez votre scanner ici..." autoFocus/>
            {scanSt&&<div className="scan-st">{scanSt}</div>}
          </div>
          {scanItem&&<div className="al al-s">
            {scanItem.type==='member'?<><strong>ğŸ‘¤ {scanItem.data.name}</strong> â€” Scannez maintenant le livre</>:<><strong>ğŸ“š {scanItem.data.title}</strong> â€” Scannez la carte membre</>}
            <button className="btn btn-2 btn-sm" style={{marginLeft:'auto'}} onClick={()=>setScanItem(null)}>Annuler</button>
          </div>}
          <div style={{background:'#fff',border:'1.5px solid var(--border)',borderRadius:'var(--r)',padding:22}}>
            <h3 style={{fontWeight:700,marginBottom:13}}>ğŸ’¡ PrÃªt manuel</h3>
            <div style={{display:'flex',gap:11,flexWrap:'wrap',alignItems:'center'}}>
              <select className="fsel" id="man-m" style={{flex:1}}>
                <option value="">SÃ©lectionner un membre</option>
                {members.map(m=><option key={m.id} value={m.id}>{m.name} ({m.memberCode})</option>)}
              </select>
              <select className="fsel" id="man-b" style={{flex:1}}>
                <option value="">SÃ©lectionner un livre disponible</option>
                {books.filter(b=>b.available>0).map(b=><option key={b.id} value={b.id}>{b.title} ({b.available} dispo)</option>)}
              </select>
              <button className="btn btn-p" onClick={()=>{
                const mId=parseInt(document.getElementById('man-m').value);
                const bId=parseInt(document.getElementById('man-b').value);
                if(!mId||!bId){toast('SÃ©lectionnez un membre et un livre','err','âš ï¸');return;}
                createLoan(bId,mId);
              }}>ğŸ“– CrÃ©er le prÃªt</button>
            </div>
          </div>
        </div>
      )}

      {/* MEMBERS */}
      {tab==='members'&&(
        <div>
          <div className="ph">
            <h1 className="pt">Membres</h1>
            <button className="btn btn-p" onClick={()=>{setMf({name:'',email:'',phone:'',address:'',dateOfBirth:'',idNumber:'',photo:''});setEditM(null);setModal('member');}}>â• Nouveau membre</button>
          </div>
          <div className="sw"><span className="si">ğŸ”</span><input type="text" className="sbar" placeholder="Rechercher nom, email, code..." value={search} onChange={e=>setSearch(e.target.value)}/></div>
          {fMembers.length===0?<div className="empty"><div className="empty-i">ğŸ‘¥</div><div>Aucun membre</div></div>:
          <div className="grid">
            {fMembers.map(m=>{
              const ml=loans.filter(l=>l.memberId===m.id);
              return(<div key={m.id} className="card">
                <div style={{display:'flex',justifyContent:'space-between',gap:18}}>
                  <div style={{display:'flex',gap:16,alignItems:'center',flex:1}}>
                    {m.photo?<img src={m.photo} className="av" style={{display:'block'}} alt=""/>:<div className="av">ğŸ‘¤</div>}
                    <div style={{flex:1}}>
                      <div className="ct">{m.name}</div>
                      <div className="cs">ğŸ“§ {m.email}</div>
                      {m.phone&&<div className="cs">ğŸ“ {m.phone}</div>}
                      <div className="cm">
                        <span className="b bp">{m.memberCode}</span>
                        {ml.length>0&&<span className="b bb">{ml.length} prÃªt(s)</span>}
                      </div>
                    </div>
                  </div>
                  <img src={`https://api.qrserver.com/v1/create-qr-code/?size=98x98&data=${encodeURIComponent(m.memberCode)}`} className="qr" alt="QR"/>
                </div>
                <div className="ca">
                  <button className="btn btn-p btn-sm" onClick={()=>printCard(m)}>ğŸ–¨ï¸ Carte</button>
                  <button className="btn btn-2 btn-sm" onClick={()=>openEditM(m)}>âœï¸ Modifier</button>
                  <button className="btn btn-g btn-sm" style={{marginLeft:'auto',color:'var(--accent)'}} onClick={()=>delMember(m.id)}>ğŸ—‘ï¸</button>
                </div>
              </div>);
            })}
          </div>}
        </div>
      )}

      {/* BOOKS */}
      {tab==='books'&&(
        <div>
          <div className="ph">
            <h1 className="pt">Livres</h1>
            <div style={{display:'flex',gap:9}}>
              <button className="btn btn-2" onClick={()=>{setZp([]);setZst('');setModal('zotero');}}>ğŸ“¥ Zotero</button>
              <button className="btn btn-p" onClick={()=>{setBf({title:'',author:'',isbn:'',year:'',category:'Fiction',publisher:'',shelf:'',copies:1,description:''});setEditB(null);setModal('book');}}>â• Nouveau livre</button>
            </div>
          </div>
          <div className="fbar">
            <div className="sw" style={{flex:1,marginBottom:0}}>
              <span className="si">ğŸ”</span>
              <input type="text" className="sbar" style={{marginBottom:0}} placeholder="Titre, auteur, ISBN..." value={search} onChange={e=>setSearch(e.target.value)}/>
            </div>
            <select className="fsel" value={catF} onChange={e=>setCatF(e.target.value)}>
              <option value="all">ğŸ·ï¸ Toutes catÃ©gories</option>
              {CATS.map(c=><option key={c} value={c}>{c} ({cStats[c]||0})</option>)}
            </select>
          </div>
          {fBooks.length===0?<div className="empty"><div className="empty-i">ğŸ“š</div><div>Aucun livre</div></div>:
          <div className="grid">
            {fBooks.map(bk=>(
              <div key={bk.id} className="card">
                <div style={{display:'flex',justifyContent:'space-between',gap:18}}>
                  <div style={{flex:1}}>
                    <div className="ct">{bk.title}</div>
                    <div className="cs">âœï¸ {bk.author}{bk.year?` â€” ${bk.year}`:''}</div>
                    {bk.isbn&&<div className="cs" style={{fontSize:'.81em'}}>ISBN: {bk.isbn}</div>}
                    <div className="cm">
                      {bk.category&&<span className="b bb">{bk.category}</span>}
                      {bk.shelf&&<span className="b bo">ğŸ“ {bk.shelf}</span>}
                      <span className={`b ${bk.available>0?'bg':'br'}`}>{bk.available}/{bk.copies} dispo</span>
                      <span className="b bk">{bk.barcode}</span>
                    </div>
                    {bk.description&&<div style={{fontSize:'.87em',color:'var(--muted)',marginTop:8,lineHeight:1.5}}>{bk.description.substring(0,120)}{bk.description.length>120?'â€¦':''}</div>}
                  </div>
                  <img src={`https://api.qrserver.com/v1/create-qr-code/?size=98x98&data=${encodeURIComponent(bk.barcode)}`} className="qr" alt="QR"/>
                </div>
                <div className="ca">
                  {bk.available>0&&members.length>0&&(
                    <select className="fsel" style={{flex:1}} onChange={e=>{if(e.target.value){createLoan(bk.id,parseInt(e.target.value));e.target.value=''}}}>
                      <option value="">ğŸ“– PrÃªter Ã ...</option>
                      {members.map(m=><option key={m.id} value={m.id}>{m.name}</option>)}
                    </select>
                  )}
                  <button className="btn btn-2 btn-sm" onClick={()=>openEditB(bk)}>âœï¸ Modifier</button>
                  <button className="btn btn-g btn-sm" style={{color:'var(--accent)'}} onClick={()=>delBook(bk.id)}>ğŸ—‘ï¸</button>
                </div>
              </div>
            ))}
          </div>}
        </div>
      )}

      {/* LOANS */}
      {tab==='loans'&&(
        <div>
          <div className="ph">
            <h1 className="pt">PrÃªts actifs</h1>
            {overdue.length>0&&<span className="b br" style={{fontSize:'1em'}}>âš ï¸ {overdue.length} en retard</span>}
          </div>
          {loans.length===0?<div className="empty"><div className="empty-i">ğŸ“–</div><div>Aucun prÃªt actif</div></div>:
          <div className="grid">
            {loans.map(loan=>{
              const mb=members.find(m=>m.id===loan.memberId),bk=books.find(b=>b.id===loan.bookId);
              const dud=Math.ceil((new Date(loan.dueDate)-new Date())/86400000);
              const late=dud<0;
              return(<div key={loan.id} className={`card${late?' late':''}`}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'start',gap:14}}>
                  <div style={{flex:1}}>
                    <div className="ct">{bk?.title||'?'}</div>
                    <div className="cs">ğŸ‘¤ {mb?.name||'?'} â€” {mb?.email}</div>
                    <div className="cs">ğŸ“… PrÃªt: {new Date(loan.loanDate).toLocaleDateString('fr-FR')}</div>
                    <div style={{marginTop:7,fontWeight:700,color:late?'var(--accent)':'#27ae60'}}>
                      {late?`âš ï¸ ${Math.abs(dud)}j retard â€” ${Math.abs(dud)*(cfg.feePerDay||10)} HTG`:`âœ… Retour: ${new Date(loan.dueDate).toLocaleDateString('fr-FR')} (${dud}j)`}
                    </div>
                  </div>
                  <button className="btn btn-s" onClick={()=>returnLoan(loan.id)}>âœ“ Retourner</button>
                </div>
              </div>);
            })}
          </div>}
        </div>
      )}

      {/* HISTORY */}
      {tab==='history'&&(
        <div>
          <div className="ph"><h1 className="pt">Historique</h1><button className="btn btn-2" onClick={exportCSV}>ğŸ“Š CSV</button></div>
          {history.length===0?<div className="empty"><div className="empty-i">ğŸ—‚ï¸</div><div>Aucun historique</div></div>:
          <div className="grid">
            {[...history].reverse().map(loan=>{
              const mb=members.find(m=>m.id===loan.memberId),bk=books.find(b=>b.id===loan.bookId);
              return(<div key={loan.id} className="card">
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:14}}>
                  <div>
                    <div className="ct" style={{fontSize:'1em'}}>{bk?.title||'?'}</div>
                    <div className="cs">ğŸ‘¤ {mb?.name||'?'}</div>
                    <div className="cs">ğŸ“… {new Date(loan.loanDate).toLocaleDateString('fr-FR')}{loan.returnDate?` â†’ ${new Date(loan.returnDate).toLocaleDateString('fr-FR')}`:''}</div>
                    {loan.daysLate>0&&<div style={{fontSize:'.84em',color:'var(--accent)',fontWeight:600}}>{loan.daysLate}j retard â€” {loan.lateFee} HTG</div>}
                  </div>
                  <span className={`b ${loan.returnDate?'bg':'bb'}`}>{loan.returnDate?'âœ“ RetournÃ©':'ğŸ“– En cours'}</span>
                </div>
              </div>);
            })}
          </div>}
        </div>
      )}

    </main>

    {/* â•â•â•â• MODALS â•â•â•â• */}

    {/* Settings */}
    {modal==='settings'&&(
      <div className="ov" onClick={close}>
        <div className="mc" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">âš™ï¸ ParamÃ¨tres</h2><button className="xb" onClick={close}>Ã—</button></div>
          <div className="ss">
            <h3>ğŸ›ï¸ BibliothÃ¨que</h3>
            <div className="fg"><label className="fl">Nom</label><input className="fi" value={cfg.libraryName} onChange={e=>setCfg({...cfg,libraryName:e.target.value})}/></div>
            <div className="fg"><label className="fl">Logo</label>
              <input ref={logoRef} type="file" accept="image/*" style={{display:'none'}} onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onloadend=()=>setCfg(s=>({...s,libraryLogo:r.result}));r.readAsDataURL(f);}}/>
              <button className="btn btn-2" style={{width:'100%'}} onClick={()=>logoRef.current.click()}>ğŸ“· Choisir logo</button>
              {cfg.libraryLogo&&<img src={cfg.libraryLogo} style={{width:76,height:76,borderRadius:'50%',objectFit:'cover',marginTop:11,border:'3px solid var(--accent)'}} alt=""/>}
            </div>
          </div>
          <div className="ss">
            <h3>ğŸ“– RÃ¨gles de prÃªt</h3>
            <div className="fgrid">
              <div className="fg"><label className="fl">DurÃ©e (jours)</label><input className="fi" type="number" min="1" value={cfg.loanDays||14} onChange={e=>setCfg({...cfg,loanDays:parseInt(e.target.value)})}/></div>
              <div className="fg"><label className="fl">PÃ©nalitÃ©/jour (HTG)</label><input className="fi" type="number" min="0" value={cfg.feePerDay||10} onChange={e=>setCfg({...cfg,feePerDay:parseInt(e.target.value)})}/></div>
            </div>
          </div>
          <div className="ss">
            <h3>â˜ï¸ Base de donnÃ©es</h3>
            <div style={{padding:'11px 14px',background:USE_SB?'#eafaf1':'#fef9e7',border:`1px solid ${USE_SB?'#a9dfbf':'#f9e79f'}`,borderRadius:'var(--rs)',marginBottom:14,fontSize:'.9em'}}>
              {USE_SB?<span>ğŸŸ¢ <strong>Supabase connectÃ©</strong> â€” donnÃ©es stockÃ©es dans le cloud</span>:<span>ğŸŸ¡ <strong>Mode hors-ligne</strong> â€” ajoutez la clÃ© <code>SB_KEY</code> dans le fichier HTML</span>}
            </div>
            <div style={{display:'flex',gap:9,flexWrap:'wrap'}}>
              <button className="btn btn-2" onClick={exportJSON}>ğŸ’¾ Sauvegarder JSON</button>
              <button className="btn btn-2" onClick={()=>importRef.current.click()}>ğŸ“¥ Restaurer</button>
              <button className="btn btn-d btn-sm" style={{marginLeft:'auto'}} onClick={()=>{if(confirm('Supprimer TOUTES les donnÃ©es ?')){['lib_members','lib_books','lib_loans'].forEach(k=>localStorage.removeItem(k));reload();close();toast('DonnÃ©es effacÃ©es','warn','ğŸ—‘ï¸');}}}>ğŸ—‘ï¸ Tout effacer</button>
            </div>
          </div>
          <div className="fac">
            <button className="btn btn-p" style={{flex:1}} onClick={()=>saveCfg(cfg)}>ğŸ’¾ Sauvegarder</button>
            <button className="btn btn-2" onClick={close}>Annuler</button>
          </div>
        </div>
      </div>
    )}

    {/* Member form */}
    {modal==='member'&&(
      <div className="ov" onClick={close}>
        <div className="mc" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">{editM?'âœï¸ Modifier membre':'â• Nouveau membre'}</h2><button className="xb" onClick={close}>Ã—</button></div>
          <div className="fg"><label className="fl">Photo</label>
            <input ref={photoRef} type="file" accept="image/*" style={{display:'none'}} onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onloadend=()=>setMf(prev=>({...prev,photo:r.result}));r.readAsDataURL(f);}}/>
            <div className="pu" onClick={()=>photoRef.current.click()}>
              {mf.photo?<img src={mf.photo} className="pp" alt=""/>:<><div style={{fontSize:'2.3em',marginBottom:8}}>ğŸ“·</div><div style={{color:'var(--muted)',fontSize:'.89em'}}>Cliquez pour ajouter une photo</div></>}
            </div>
          </div>
          <div className="fg"><label className="fl">Nom complet *</label><input className="fi" value={mf.name} onChange={e=>setMf({...mf,name:e.target.value})} placeholder="Jean Dupont"/></div>
          <div className="fg"><label className="fl">Email *</label><input className="fi" type="email" value={mf.email} onChange={e=>setMf({...mf,email:e.target.value})} placeholder="jean@email.com"/></div>
          <div className="fg"><label className="fl">TÃ©lÃ©phone</label><input className="fi" type="tel" value={mf.phone} onChange={e=>setMf({...mf,phone:e.target.value})} placeholder="+509 1234 5678"/></div>
          <div className="fg"><label className="fl">Adresse</label><textarea className="ft" value={mf.address} onChange={e=>setMf({...mf,address:e.target.value})} placeholder="123 Rue Example"/></div>
          <div className="fgrid">
            <div className="fg"><label className="fl">Date de naissance</label><input className="fi" type="date" value={mf.dateOfBirth} onChange={e=>setMf({...mf,dateOfBirth:e.target.value})}/></div>
            <div className="fg"><label className="fl">NÂ° d'identitÃ©</label><input className="fi" value={mf.idNumber} onChange={e=>setMf({...mf,idNumber:e.target.value})} placeholder="CIN/NIF"/></div>
          </div>
          <div className="fac">
            <button className="btn btn-p" style={{flex:1}} onClick={saveMember}>âœ“ Enregistrer</button>
            <button className="btn btn-2" onClick={close}>Annuler</button>
          </div>
        </div>
      </div>
    )}

    {/* Book form */}
    {modal==='book'&&(
      <div className="ov" onClick={close}>
        <div className="mc" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">{editB?'âœï¸ Modifier livre':'â• Nouveau livre'}</h2><button className="xb" onClick={close}>Ã—</button></div>
          <div className="fg"><label className="fl">Titre *</label><input className="fi" value={bf.title} onChange={e=>setBf({...bf,title:e.target.value})} placeholder="Titre du livre"/></div>
          <div className="fg"><label className="fl">Auteur *</label><input className="fi" value={bf.author} onChange={e=>setBf({...bf,author:e.target.value})} placeholder="Nom de l'auteur"/></div>
          <div className="fg"><label className="fl">ISBN</label><input className="fi" value={bf.isbn} onChange={e=>setBf({...bf,isbn:e.target.value})} placeholder="978-XXXXXXXXXX"/></div>
          <div className="fgrid">
            <div className="fg"><label className="fl">AnnÃ©e</label><input className="fi" value={bf.year} onChange={e=>setBf({...bf,year:e.target.value})} placeholder="2024"/></div>
            <div className="fg"><label className="fl">CatÃ©gorie</label>
              <select className="fsel" style={{width:'100%'}} value={bf.category} onChange={e=>setBf({...bf,category:e.target.value})}>
                {CATS.map(c=><option key={c} value={c}>{c}</option>)}
              </select>
            </div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">Cote</label><input className="fi" value={bf.shelf} onChange={e=>setBf({...bf,shelf:e.target.value})} placeholder="A-12"/></div>
            <div className="fg"><label className="fl">Exemplaires</label><input className="fi" type="number" min="1" value={bf.copies} onChange={e=>setBf({...bf,copies:e.target.value})}/></div>
          </div>
          <div className="fg"><label className="fl">Ã‰diteur</label><input className="fi" value={bf.publisher} onChange={e=>setBf({...bf,publisher:e.target.value})} placeholder="Ã‰diteur"/></div>
          <div className="fg"><label className="fl">Description</label><textarea className="ft" value={bf.description} onChange={e=>setBf({...bf,description:e.target.value})} placeholder="RÃ©sumÃ©"/></div>
          <div className="fac">
            <button className="btn btn-p" style={{flex:1}} onClick={saveBook}>âœ“ Enregistrer</button>
            <button className="btn btn-2" onClick={close}>Annuler</button>
          </div>
        </div>
      </div>
    )}

    {/* Zotero */}
    {modal==='zotero'&&(
      <div className="ov" onClick={()=>{close();setZp([]);setZst('');}}>
        <div className="mc wide" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">ğŸ“¥ Importer depuis Zotero</h2><button className="xb" onClick={()=>{close();setZp([]);setZst('');}}>Ã—</button></div>
          <div className="al al-i" style={{flexDirection:'column',alignItems:'start',gap:8}}>
            <div style={{fontWeight:700}}>ğŸ“‹ Comment exporter depuis Zotero :</div>
            <ol style={{paddingLeft:20,fontSize:'.89em',lineHeight:2.1}}>
              <li>Ouvrez Zotero, sÃ©lectionnez vos rÃ©fÃ©rences (<strong>Ctrl+A</strong> pour tout)</li>
              <li>Clic droit â†’ <strong>Exporter les Ã©lÃ©mentsâ€¦</strong></li>
              <li>Choisissez <strong>BibTeX</strong>, <strong>RIS</strong> ou <strong>CSV</strong></li>
              <li>Importez le fichier ici</li>
            </ol>
            <div style={{display:'flex',gap:7,flexWrap:'wrap',marginTop:4}}>
              {['âœ… BibTeX .bib','âœ… RIS .ris','âœ… CSV .csv'].map(t=><span key={t} style={{background:'#d6eaf8',color:'#1a5276',padding:'3px 11px',borderRadius:20,fontSize:'.8em',fontWeight:600}}>{t}</span>)}
            </div>
          </div>
          <input ref={zRef} type="file" accept=".bib,.ris,.csv" style={{display:'none'}} onChange={handleZFile}/>
          <div className="zdrop" onClick={()=>zRef.current.click()}>
            <div style={{fontSize:'2.8em',marginBottom:9}}>ğŸ“‚</div>
            <div style={{fontWeight:700,color:'var(--primary)',marginBottom:4}}>Cliquez pour choisir un fichier Zotero</div>
            <div style={{fontSize:'.84em',color:'var(--muted)'}}>Formats : .bib Â· .ris Â· .csv</div>
          </div>
          {zst&&<div className={`al ${zst.startsWith('âŒ')?'al-w':'al-s'}`}>{zst}</div>}
          {zp.length>0&&<>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:11}}>
              <div style={{fontWeight:700}}>{zp.filter(b=>b._s).length} / {zp.length} sÃ©lectionnÃ©e(s)</div>
              <div style={{display:'flex',gap:7}}>
                <button className="btn btn-2 btn-sm" onClick={()=>setZp(p=>p.map(b=>({...b,_s:true})))}>Tout</button>
                <button className="btn btn-g btn-sm" onClick={()=>setZp(p=>p.map(b=>({...b,_s:false})))}>Aucun</button>
              </div>
            </div>
            <div className="zlist">
              {zp.map((bk,i)=>(
                <div key={i} className={`zrow${bk._s?' sel':''}`} onClick={()=>setZp(p=>p.map((b,j)=>j===i?{...b,_s:!b._s}:b))}>
                  <input type="checkbox" checked={bk._s} onChange={()=>{}} onClick={e=>e.stopPropagation()} style={{width:16,height:16,marginTop:3,accentColor:'var(--accent)',flexShrink:0,cursor:'pointer'}}/>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontWeight:600,color:'var(--primary)',fontSize:'.94em',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{bk.title}</div>
                    <div style={{fontSize:'.82em',color:'var(--muted)',marginTop:2}}>{bk.author||'â€”'}{bk.year?` Â· ${bk.year}`:''}{bk.publisher?` Â· ${bk.publisher}`:''}</div>
                    <div style={{marginTop:4,display:'flex',gap:5,flexWrap:'wrap'}}>
                      <span className="b bb" style={{fontSize:'.74em'}}>{bk.category}</span>
                      {bk.isbn&&<span className="b bk" style={{fontSize:'.74em'}}>ISBN: {bk.isbn}</span>}
                    </div>
                  </div>
                  <select className="fsel" style={{width:125,padding:'5px 9px',fontSize:'.81em',flexShrink:0}} value={bk.category} onClick={e=>e.stopPropagation()} onChange={e=>setZp(p=>p.map((b,j)=>j===i?{...b,category:e.target.value}:b))}>
                    {CATS.map(c=><option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
              ))}
            </div>
            <div className="fac">
              <button className="btn btn-p" style={{flex:1}} onClick={doZotero}>ğŸ“¥ Importer {zp.filter(b=>b._s).length} livre(s)</button>
              <button className="btn btn-2" onClick={()=>{setZp([]);setZst('');}}>Annuler</button>
            </div>
          </>}
        </div>
      </div>
    )}

  </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
