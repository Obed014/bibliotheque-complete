<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bibliothèque</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;1,9..144,300&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
/* ══ THEMES ══════════════════════════════════════════ */
:root,
[data-theme="light"] {
  --bg:      #f7f8fa;
  --bg2:     #ffffff;
  --bg3:     #f1f3f6;
  --surf:    rgba(0,0,0,.03);
  --surf2:   rgba(0,0,0,.055);
  --border:  rgba(0,0,0,.09);
  --border2: rgba(0,0,0,.14);
  --accent:  #2563eb;
  --accent2: #1d4ed8;
  --accent-t:rgba(37,99,235,.1);
  --accent-t2:rgba(37,99,235,.18);
  --red:     #dc2626;
  --green:   #16a34a;
  --orange:  #ea580c;
  --purple:  #7c3aed;
  --blue:    #2563eb;
  --text:    #111827;
  --text2:   #4b5563;
  --text3:   #9ca3af;
  --shadow:  0 1px 4px rgba(0,0,0,.08),0 4px 16px rgba(0,0,0,.06);
  --shadow-lg:0 8px 32px rgba(0,0,0,.12);
  --r:       12px;
  --rs:      8px;
  --sb-bg:   #111827;
  --sb-text: rgba(255,255,255,.75);
  --sb-text2:rgba(255,255,255,.45);
  --sb-border:rgba(255,255,255,.08);
  --sb-active-bg:rgba(255,255,255,.1);
  --sb-active:rgba(255,255,255,.95);
  --sb-accent:#60a5fa;
}

[data-theme="blue"] {
  --bg:      #0f1d35;
  --bg2:     #162440;
  --bg3:     #1e2f50;
  --surf:    rgba(255,255,255,.04);
  --surf2:   rgba(255,255,255,.07);
  --border:  rgba(255,255,255,.08);
  --border2: rgba(255,255,255,.14);
  --accent:  #60a5fa;
  --accent2: #93c5fd;
  --accent-t:rgba(96,165,250,.12);
  --accent-t2:rgba(96,165,250,.2);
  --red:     #f87171;
  --green:   #4ade80;
  --orange:  #fb923c;
  --purple:  #a78bfa;
  --blue:    #60a5fa;
  --text:    #f0f4ff;
  --text2:   #94a3b8;
  --text3:   #475569;
  --shadow:  0 4px 20px rgba(0,0,0,.4);
  --shadow-lg:0 12px 40px rgba(0,0,0,.5);
  --r:       12px;
  --rs:      8px;
  --sb-bg:   #0a1628;
  --sb-text: rgba(255,255,255,.75);
  --sb-text2:rgba(255,255,255,.4);
  --sb-border:rgba(255,255,255,.06);
  --sb-active-bg:rgba(96,165,250,.12);
  --sb-active:#93c5fd;
  --sb-accent:#60a5fa;
}

[data-theme="green"] {
  --bg:      #f0faf4;
  --bg2:     #ffffff;
  --bg3:     #e8f5ee;
  --surf:    rgba(0,0,0,.03);
  --surf2:   rgba(0,0,0,.05);
  --border:  rgba(0,0,0,.09);
  --border2: rgba(0,0,0,.14);
  --accent:  #16a34a;
  --accent2: #15803d;
  --accent-t:rgba(22,163,74,.1);
  --accent-t2:rgba(22,163,74,.18);
  --red:     #dc2626;
  --green:   #16a34a;
  --orange:  #ea580c;
  --purple:  #7c3aed;
  --blue:    #2563eb;
  --text:    #14532d;
  --text2:   #4b5563;
  --text3:   #9ca3af;
  --shadow:  0 1px 4px rgba(0,0,0,.07),0 4px 16px rgba(0,0,0,.05);
  --shadow-lg:0 8px 32px rgba(0,0,0,.1);
  --r:       12px;
  --rs:      8px;
  --sb-bg:   #14532d;
  --sb-text: rgba(255,255,255,.8);
  --sb-text2:rgba(255,255,255,.45);
  --sb-border:rgba(255,255,255,.08);
  --sb-active-bg:rgba(255,255,255,.12);
  --sb-active:rgba(255,255,255,.95);
  --sb-accent:#4ade80;
}

[data-theme="dark"] {
  --bg:      #0d0f14;
  --bg2:     #13161e;
  --bg3:     #1a1f2c;
  --surf:    rgba(255,255,255,.04);
  --surf2:   rgba(255,255,255,.07);
  --border:  rgba(255,255,255,.08);
  --border2: rgba(255,255,255,.14);
  --accent:  #c9a84c;
  --accent2: #e8c97a;
  --accent-t:rgba(201,168,76,.12);
  --accent-t2:rgba(201,168,76,.2);
  --red:     #f87171;
  --green:   #4ade80;
  --orange:  #fb923c;
  --purple:  #a78bfa;
  --blue:    #60a5fa;
  --text:    #f0f4ff;
  --text2:   #94a3b8;
  --text3:   #475569;
  --shadow:  0 4px 20px rgba(0,0,0,.5);
  --shadow-lg:0 12px 40px rgba(0,0,0,.6);
  --r:       12px;
  --rs:      8px;
  --sb-bg:   #0a0c11;
  --sb-text: rgba(255,255,255,.72);
  --sb-text2:rgba(255,255,255,.38);
  --sb-border:rgba(255,255,255,.06);
  --sb-active-bg:rgba(201,168,76,.1);
  --sb-active:#e8c97a;
  --sb-accent:#c9a84c;
}

/* ══ RESET ═══════════════════════════════════════════ */
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{
  font-family:'Plus Jakarta Sans',sans-serif;
  background:var(--bg);color:var(--text);
  min-height:100vh;transition:background .25s,color .25s;
}

/* ══ ANIMATIONS ══════════════════════════════════════ */
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes toastIn{from{transform:translateX(60px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

.au{animation:fadeUp .3s ease both}
.au2{animation:fadeUp .3s .06s ease both}
.au3{animation:fadeUp .3s .12s ease both}
.au4{animation:fadeUp .3s .18s ease both}

/* ══ LOGIN ═══════════════════════════════════════════ */
.login-wrap{
  min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:var(--bg);padding:20px;
}
.login-box{
  width:100%;max-width:400px;
  background:var(--bg2);border:1px solid var(--border2);
  border-radius:20px;padding:44px 36px;
  box-shadow:var(--shadow-lg);animation:fadeUp .4s ease;
}
.login-icon{
  width:56px;height:56px;border-radius:14px;
  background:var(--accent-t2);border:1px solid var(--accent-t2);
  display:flex;align-items:center;justify-content:center;
  margin:0 auto 22px;color:var(--accent);
}
.login-title{font-family:'Fraunces',serif;font-size:1.75em;text-align:center;color:var(--text);margin-bottom:5px}
.login-sub{font-size:.83em;color:var(--text3);text-align:center;margin-bottom:28px}
.login-tabs{display:flex;gap:6px;background:var(--surf2);border-radius:var(--rs);padding:4px;margin-bottom:24px}
.login-tab{flex:1;padding:8px;border:none;background:none;color:var(--text3);font-size:.84em;font-weight:600;cursor:pointer;border-radius:6px;font-family:inherit;transition:all .2s}
.login-tab.active{background:var(--bg2);color:var(--accent);box-shadow:var(--shadow)}
.login-err{background:rgba(220,38,38,.08);border:1px solid rgba(220,38,38,.2);color:var(--red);padding:10px 14px;border-radius:var(--rs);font-size:.83em;margin-bottom:14px;text-align:center}

/* ══ SHELL ════════════════════════════════════════════ */
.shell{display:flex;min-height:100vh}

/* ══ SIDEBAR ══════════════════════════════════════════ */
.sidebar{
  width:252px;background:var(--sb-bg);
  display:flex;flex-direction:column;
  position:fixed;height:100vh;z-index:100;
  transition:background .25s;
}
.sb-head{
  padding:22px 18px 16px;
  border-bottom:1px solid var(--sb-border);
}
.sb-logo-row{display:flex;align-items:center;gap:11px}
.sb-logo{
  width:38px;height:38px;border-radius:10px;
  background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);
  display:flex;align-items:center;justify-content:center;
  color:var(--sb-accent);flex-shrink:0;object-fit:cover;
}
.sb-libname{font-family:'Fraunces',serif;font-size:1em;font-weight:500;color:var(--sb-active);line-height:1.2}
.sb-status{display:inline-flex;align-items:center;gap:5px;font-size:.67em;color:var(--sb-text2);margin-top:2px}
.sb-status-dot{width:5px;height:5px;border-radius:50%;background:#4ade80;flex-shrink:0;animation:pulse 2s infinite}
.sb-status-dot.off{background:#fb923c;animation:none}

.sb-nav{flex:1;padding:10px 8px;overflow-y:auto}
.sb-nav::-webkit-scrollbar{width:2px}
.sb-nav::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
.sb-sec{font-size:.62em;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--sb-text2);padding:12px 10px 5px}

.nbtn{
  display:flex;align-items:center;gap:9px;width:100%;
  padding:8px 10px;background:none;border:none;
  color:var(--sb-text);font-size:.85em;font-weight:500;
  cursor:pointer;transition:all .15s;text-align:left;
  font-family:inherit;border-radius:var(--rs);margin-bottom:1px;
}
.nbtn:hover{background:var(--sb-active-bg);color:var(--sb-active)}
.nbtn.active{background:var(--sb-active-bg);color:var(--sb-accent);font-weight:600}
.nbtn .ni{width:18px;height:18px;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.nbtn .nl{flex:1}
.nbadge{
  background:rgba(255,255,255,.07);border-radius:20px;
  padding:2px 7px;font-size:.69em;font-weight:700;
  color:var(--sb-text2);
}
.nbtn.active .nbadge{background:var(--accent-t);color:var(--sb-accent)}

.sb-foot{padding:12px 12px 18px;border-top:1px solid var(--sb-border);display:flex;flex-direction:column;gap:6px}
.sb-foot-row{display:flex;gap:5px}
.sfbtn{
  flex:1;padding:7px 5px;
  border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);
  color:var(--sb-text);border-radius:var(--rs);
  font-size:.74em;cursor:pointer;font-family:inherit;
  transition:all .16s;text-align:center;font-weight:500;
  display:flex;align-items:center;justify-content:center;gap:5px;
}
.sfbtn:hover{background:rgba(255,255,255,.1);color:var(--sb-active)}
.sfbtn.zotero{
  background:var(--accent-t);border-color:rgba(255,255,255,.08);
  color:var(--sb-accent);
}
.sfbtn.zotero:hover{background:var(--accent-t2)}
.sfbtn.logout{background:rgba(220,38,38,.08);border-color:rgba(220,38,38,.15);color:#f87171}
.sfbtn.logout:hover{background:rgba(220,38,38,.15)}
.sb-user{font-size:.68em;color:var(--sb-text2);text-align:center;padding:2px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ══ MAIN ═════════════════════════════════════════════ */
.main{flex:1;margin-left:252px;padding:30px 30px 60px;max-width:calc(100vw - 252px)}

/* ══ PAGE HEADER ══════════════════════════════════════ */
.ph{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.pt{font-family:'Fraunces',serif;font-size:1.8em;font-weight:500;color:var(--text)}

/* ══ STATS ════════════════════════════════════════════ */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:12px;margin-bottom:26px}
.sc{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);padding:18px;
  position:relative;overflow:hidden;
  transition:all .2s;
}
.sc:hover{box-shadow:var(--shadow);border-color:var(--border2)}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--r) var(--r) 0 0}
.sc.c-blue::before{background:var(--blue)}
.sc.c-green::before{background:var(--green)}
.sc.c-purple::before{background:var(--purple)}
.sc.c-orange::before{background:var(--orange)}
.sc.c-red::before{background:var(--red)}
.sc.c-accent::before{background:var(--accent)}
.sn{font-size:2.3em;font-weight:700;color:var(--text);line-height:1;margin-bottom:4px;font-family:'Fraunces',serif}
.sl{font-size:.76em;color:var(--text3);font-weight:500}

/* ══ BUTTONS ══════════════════════════════════════════ */
.btn{
  padding:9px 18px;border:none;border-radius:var(--rs);
  font-size:.86em;font-weight:600;cursor:pointer;
  transition:all .16s;display:inline-flex;align-items:center;gap:6px;
  font-family:inherit;
}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 2px 8px color-mix(in srgb,var(--accent) 40%,transparent)}
.btn-primary:hover{background:var(--accent2);box-shadow:0 4px 14px color-mix(in srgb,var(--accent) 35%,transparent)}
.btn-success{background:var(--accent-t);color:var(--green);border:1px solid rgba(22,163,74,.2)}
.btn-success:hover{background:rgba(22,163,74,.18)}
.btn-danger{background:rgba(220,38,38,.08);color:var(--red);border:1px solid rgba(220,38,38,.18)}
.btn-danger:hover{background:rgba(220,38,38,.15)}
.btn-secondary{background:var(--surf2);color:var(--text2);border:1px solid var(--border2)}
.btn-secondary:hover{background:var(--bg3);color:var(--text)}
.btn-ghost{background:transparent;color:var(--text3);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surf);color:var(--text2)}
.btn-email{background:rgba(37,99,235,.08);color:var(--blue);border:1px solid rgba(37,99,235,.18)}
.btn-email:hover{background:rgba(37,99,235,.15)}
.btn-sm{padding:6px 12px;font-size:.79em}

/* ══ SEARCH / FILTER ══════════════════════════════════ */
.sw{position:relative;margin-bottom:14px}
.sw-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none}
.sbar{
  width:100%;padding:9px 13px 9px 36px;
  border:1px solid var(--border);border-radius:var(--rs);
  font-size:.88em;background:var(--bg2);color:var(--text);
  font-family:inherit;transition:border-color .18s,box-shadow .18s;
}
.sbar:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-t)}
.fbar{display:flex;gap:9px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.fsel{
  padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);
  font-size:.84em;background:var(--bg2);color:var(--text2);
  cursor:pointer;font-family:inherit;transition:border-color .18s;
}
.fsel:focus{outline:none;border-color:var(--accent)}

/* ══ CARDS ════════════════════════════════════════════ */
.grid{display:grid;gap:12px}
.card{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);padding:18px;
  transition:all .18s;
}
.card:hover{border-color:var(--border2);box-shadow:var(--shadow)}
.card.late{border-color:rgba(220,38,38,.25);background:rgba(220,38,38,.02)}
.ct{font-size:1.02em;font-weight:700;color:var(--text);margin-bottom:3px}
.cs{color:var(--text3);font-size:.83em;margin-bottom:2px;line-height:1.5}
.cm{display:flex;gap:5px;flex-wrap:wrap;margin-top:9px}
.ca{display:flex;gap:7px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}

/* ══ BADGES ═══════════════════════════════════════════ */
.b{display:inline-flex;align-items:center;padding:2px 9px;border-radius:20px;font-size:.72em;font-weight:600}
.bg{background:rgba(22,163,74,.1);color:var(--green)}
.br{background:rgba(220,38,38,.1);color:var(--red)}
.bp{background:rgba(124,58,237,.1);color:var(--purple)}
.bb{background:rgba(37,99,235,.1);color:var(--blue)}
.bo{background:rgba(234,88,12,.1);color:var(--orange)}
.bk{background:var(--surf2);color:var(--text3)}
.ba{background:var(--accent-t);color:var(--accent)}

/* ══ MODAL ════════════════════════════════════════════ */
.ov{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.5);backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;
  z-index:1000;animation:fadeIn .15s;
}
.mc{
  background:var(--bg2);border:1px solid var(--border2);
  border-radius:18px;padding:30px;
  max-width:580px;width:93%;max-height:90vh;overflow-y:auto;
  animation:fadeUp .2s ease;box-shadow:var(--shadow-lg);
}
.mc.wide{max-width:720px}
.mc::-webkit-scrollbar{width:3px}
.mc::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.mh{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px}
.mt{font-family:'Fraunces',serif;font-size:1.4em;font-weight:500;color:var(--text)}
.xb{
  background:var(--surf2);border:none;cursor:pointer;
  color:var(--text3);width:30px;height:30px;
  display:flex;align-items:center;justify-content:center;
  border-radius:50%;transition:all .16s;
}
.xb:hover{background:var(--bg3);color:var(--text)}

/* ══ FORMS ════════════════════════════════════════════ */
.fg{margin-bottom:14px}
.fl{display:block;font-weight:600;color:var(--text3);margin-bottom:4px;font-size:.78em;letter-spacing:.03em;text-transform:uppercase}
.fi,.ft{
  width:100%;padding:9px 12px;
  border:1px solid var(--border);border-radius:var(--rs);
  font-size:.88em;background:var(--bg3);color:var(--text);
  font-family:inherit;transition:border-color .18s,box-shadow .18s;
}
.fi:focus,.ft:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-t)}
.ft{resize:vertical;min-height:78px}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:11px}
.fac{display:flex;gap:9px;margin-top:22px}

/* ══ PHOTO UPLOAD ═════════════════════════════════════ */
.pu{
  border:2px dashed var(--border2);border-radius:var(--r);
  padding:20px;text-align:center;cursor:pointer;
  transition:all .2s;background:var(--surf);
}
.pu:hover{border-color:var(--accent);background:var(--accent-t)}
.pp{width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);margin:10px auto;display:block}

/* ══ SCANNER ══════════════════════════════════════════ */
.scan-box{
  background:var(--bg2);border:1px solid var(--border2);
  padding:22px;border-radius:var(--r);margin-bottom:22px;
  box-shadow:var(--shadow);
}
.scan-in{
  width:100%;padding:12px 16px;
  border:1.5px solid var(--border2);border-radius:var(--rs);
  font-size:1em;font-weight:500;font-family:inherit;
  background:var(--bg3);color:var(--text);
  transition:border-color .2s,box-shadow .2s;
}
.scan-in:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-t)}
.scan-st{margin-top:11px;padding:9px 14px;background:var(--surf2);border-radius:var(--rs);font-size:.87em;border:1px solid var(--border)}

/* ══ CAT GRID ═════════════════════════════════════════ */
.cg{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:11px;margin-bottom:26px}
.cc{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);padding:16px;text-align:center;cursor:pointer;
  transition:all .18s;
}
.cc:hover{border-color:var(--accent);box-shadow:var(--shadow);transform:translateY(-2px)}
.cn{font-size:2em;font-weight:700;color:var(--accent);font-family:'Fraunces',serif}
.cl{font-size:.73em;color:var(--text3);margin-top:3px;font-weight:500;text-transform:uppercase;letter-spacing:.04em}

/* ══ ALERTS ═══════════════════════════════════════════ */
.al{padding:11px 15px;border-radius:var(--rs);margin-bottom:12px;display:flex;align-items:center;gap:10px;font-size:.85em;flex-wrap:wrap}
.al-w{background:rgba(234,88,12,.08);color:var(--orange);border:1px solid rgba(234,88,12,.18)}
.al-s{background:rgba(22,163,74,.08);color:var(--green);border:1px solid rgba(22,163,74,.18)}
.al-i{background:var(--accent-t);color:var(--accent);border:1px solid var(--accent-t2)}
.al-e{background:rgba(220,38,38,.08);color:var(--red);border:1px solid rgba(220,38,38,.18)}

/* ══ EMPTY ════════════════════════════════════════════ */
.empty{text-align:center;padding:56px 20px;color:var(--text3)}
.empty-i{margin-bottom:12px;opacity:.3;display:flex;justify-content:center}

/* ══ SETTINGS SECTION ════════════════════════════════ */
.ss{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:14px}
.ss h3{font-size:.78em;font-weight:700;color:var(--text2);margin-bottom:13px;text-transform:uppercase;letter-spacing:.07em;padding-bottom:8px;border-bottom:1px solid var(--border)}

/* ══ QR / AVATAR ══════════════════════════════════════ */
.qr{width:82px;height:82px;border-radius:var(--rs);flex-shrink:0;background:white;padding:3px;border:1px solid var(--border)}
.av{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid var(--border2);flex-shrink:0;display:flex;align-items:center;justify-content:center;background:var(--bg3);color:var(--text3)}

/* ══ TOAST ════════════════════════════════════════════ */
.tc{position:fixed;bottom:22px;right:22px;display:flex;flex-direction:column;gap:7px;z-index:9999;pointer-events:none}
.toast{
  background:var(--bg2);color:var(--text);border:1px solid var(--border2);
  padding:11px 16px;border-radius:var(--rs);
  box-shadow:var(--shadow-lg);font-size:.85em;font-weight:500;
  animation:toastIn .2s ease;min-width:200px;
  display:flex;align-items:center;gap:8px;
}
.toast.ok{border-left:3px solid var(--green)}
.toast.err{border-left:3px solid var(--red)}
.toast.warn{border-left:3px solid var(--orange)}

/* ══ ZOTERO ═══════════════════════════════════════════ */
.zdrop{
  border:2px dashed var(--border2);border-radius:var(--r);
  padding:26px;text-align:center;cursor:pointer;
  background:var(--surf);transition:all .2s;margin-bottom:14px;
}
.zdrop:hover{border-color:var(--accent);background:var(--accent-t)}
.zlist{max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--rs);margin-bottom:14px}
.zlist::-webkit-scrollbar{width:3px}
.zlist::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.zrow{display:flex;align-items:start;gap:11px;padding:11px 13px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .13s}
.zrow:last-child{border-bottom:none}
.zrow:hover,.zrow.sel{background:var(--accent-t)}

/* ══ DIVIDER / SPINNER ════════════════════════════════ */
.divider{height:1px;background:var(--border);margin:18px 0}
.spinner{width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .65s linear infinite;flex-shrink:0}

/* ══ THEME SWATCHES ═══════════════════════════════════ */
.theme-swatches{display:flex;gap:9px;flex-wrap:wrap}
.theme-swatch{
  cursor:pointer;border-radius:var(--rs);padding:9px 13px;
  display:flex;align-items:center;gap:7px;
  transition:all .18s;border:2px solid transparent;
  font-size:.82em;font-weight:600;
}

.selected-card{outline:2px solid var(--accent)!important;background:var(--accent-t)!important}
.selected-card:hover{background:var(--accent-t)!important}
kbd{font-family:monospace;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:.85em}

/* ══ RESPONSIVE ═══════════════════════════════════════ */
@media(max-width:768px){
  .sidebar{width:100%;height:auto;position:relative}
  .main{margin-left:0;padding:16px;max-width:100%}
  .fgrid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

const { useState, useEffect, useRef } = React;

// ══ LUCIDE SVG ICONS (inline, no dependency) ══════════
const Icon = ({ name, size=16, color='currentColor', strokeWidth=1.75 }) => {
  const paths = {
    home: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M9 22V12h6v10",
    users: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M23 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75",
    book: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20 M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z",
    'book-open': "M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z",
    scan: "M3 7V5a2 2 0 0 1 2-2h2 M17 3h2a2 2 0 0 1 2 2v2 M21 17v2a2 2 0 0 1-2 2h-2 M7 21H5a2 2 0 0 1-2-2v-2",
    history: "M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8 M3 3v5h5 M12 7v5l4 2",
    settings: "M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z",
    download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3",
    upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M17 8l-5-5-5 5 M12 3v12",
    save: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z M17 21v-8H7v8 M7 3v5h8",
    'log-out': "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9",
    printer: "M6 9V2h12v7 M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2 M6 14h12v8H6z",
    pencil: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z",
    trash: "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2",
    plus: "M12 5v14 M5 12h14",
    search: "M11 17a6 6 0 1 0 0-12 6 6 0 0 0 0 12z M21 21l-4.35-4.35",
    'bar-chart': "M18 20V10 M12 20V4 M6 20v-6",
    mail: "M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z M22 6l-10 7L2 6",
    refresh: "M23 4v6h-6 M1 20v-6h6 M3.51 9a9 9 0 0 1 14.85-3.36L23 10 M1 14l4.64 4.36A9 9 0 0 0 20.49 15",
    alert: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01",
    check: "M20 6L9 17l-5-5",
    x: "M18 6L6 18 M6 6l12 12",
    user: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z",
    'book-marked': "M4 19.5A2.5 2.5 0 0 1 6.5 17H20 M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z M9 2v7l2.5-1.5L14 9V2",
    library: "M2 5a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5z M9 5a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2V5z M16 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",
    camera: "M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z",
    grid: "M3 3h7v7H3z M14 3h7v7h-7z M3 14h7v7H3z M14 14h7v7h-7z",
    filter: "M22 3H2l8 9.46V19l4 2v-8.54L22 3z",
    cloud: "M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z",
    palette: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.55 0 1-.45 1-1 0-.27-.1-.52-.26-.72-.17-.2-.26-.45-.26-.72 0-.55.45-1 1-1h1.18c3.17 0 5.34-2.17 5.34-5.34C20.99 5.58 16.97 2 12 2zM7 13c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm2-4c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm6 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm2 4c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z",
    'chevron-right': "M9 18l6-6-6-6",
    dot: "M12 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0-4 0",
  };
  const d = paths[name] || paths['dot'];
  return (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round">
      {d.split(' M').map((seg,i) => <path key={i} d={i===0?seg:'M'+seg}/>)}
    </svg>
  );
};

// ══ CONFIG ════════════════════════════════════════════
const SB_URL = 'https://kokwzdfbypjvvqduuovk.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtva3d6ZGZieXBqdnZxZHV1b3ZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MDI1NTYsImV4cCI6MjA4NzQ3ODU1Nn0.fhPdFPa3Ap6SM6RK5bAs46bIBko3t-tBFm2w_fnKMn4';
const CATS = ['Fiction','Science','Histoire','Biographie','Enfants','Religion','Technologie','Art','Cuisine','Autre'];
const USE_SB = !!(SB_URL && SB_KEY && SB_KEY.startsWith('eyJ'));

// ══ HELPERS ═══════════════════════════════════════════
function gd(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch{ return []; } }
function sd(k,v){ localStorage.setItem(k,JSON.stringify(v)); }
function gsettings(){ try{ return JSON.parse(localStorage.getItem('lib_cfg')||'{}'); }catch{ return {}; } }
function gid(){ return Date.now()+Math.floor(Math.random()*9999); }
function today(){ return new Date().toISOString().split('T')[0]; }
function dlBlob(blob,name){ const u=URL.createObjectURL(blob),a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u); }

// ══ SUPABASE REST ══════════════════════════════════════
async function sb(table, method='GET', body=null, qs='', token=null){
  const url=`${SB_URL}/rest/v1/${table}${qs}`;
  const h={'apikey':SB_KEY,'Authorization':`Bearer ${token||SB_KEY}`,'Content-Type':'application/json','Prefer':'return=representation'};
  const r=await fetch(url,{method,headers:h,body:body?JSON.stringify(body):null});
  if(!r.ok){ const e=await r.text(); throw new Error(e); }
  const t=await r.text(); return t?JSON.parse(t):[];
}

// ══ SUPABASE AUTH ══════════════════════════════════════
async function sbSignIn(email,password){
  const r=await fetch(`${SB_URL}/auth/v1/token?grant_type=password`,{method:'POST',headers:{'apikey':SB_KEY,'Content-Type':'application/json'},body:JSON.stringify({email,password})});
  if(!r.ok){ const e=await r.json(); throw new Error(e.error_description||e.msg||'Erreur de connexion'); }
  return r.json();
}
async function sbSignUp(email,password){
  const r=await fetch(`${SB_URL}/auth/v1/signup`,{method:'POST',headers:{'apikey':SB_KEY,'Content-Type':'application/json'},body:JSON.stringify({email,password})});
  if(!r.ok){ const e=await r.json(); throw new Error(e.error_description||e.msg||'Erreur inscription'); }
  return r.json();
}
async function sbSignOut(token){
  await fetch(`${SB_URL}/auth/v1/logout`,{method:'POST',headers:{'apikey':SB_KEY,'Authorization':`Bearer ${token}`}});
}
function getStoredSession(){ try{ return JSON.parse(localStorage.getItem('lib_session')||'null'); }catch{ return null; } }

// ── Role management ────────────────────────────────────
const ROLES = { admin: 'Administrateur', librarian: 'Bibliothécaire', readonly: 'Lecture seule' };

// Emails administrateurs — ajoutez les vôtres ici
const ADMIN_EMAILS = ['obedsanon@gmail.com'];

function getEmailFromSession(session){
  // Try session.user.email first
  if(session?.user?.email) return session.user.email;
  // Fallback: decode JWT token to get email
  try{
    const token = session?.access_token;
    if(!token) return null;
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.email || payload.sub_email || null;
  }catch(e){ return null; }
}

async function getUserRole(userId, userEmail){
  // 1. Check hardcoded admin emails first (always works)
  if(userEmail && ADMIN_EMAILS.includes(userEmail.toLowerCase())) return 'admin';
  // 2. Then try database
  try{
    const url=`${SB_URL}/rest/v1/user_roles?user_id=eq.${userId}&select=role`;
    const r=await fetch(url,{headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`}});
    if(!r.ok) return 'readonly';
    const rows=await r.json();
    return rows.length ? rows[0].role : 'readonly';
  }catch(e){ return 'readonly'; }
}
async function getTeamMembers(){
  try{
    const url=`${SB_URL}/rest/v1/user_roles?order=created_at.desc&select=*`;
    const r=await fetch(url,{headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`}});
    if(!r.ok) return [];
    return r.json();
  }catch(e){ return []; }
}
async function setUserRole(userId, role){
  try{ await sb('user_roles','DELETE',null,`?user_id=eq.${userId}`); }catch(e){}
  await sb('user_roles','POST',{user_id:userId, role});
}
async function removeUserRole(userId){
  await sb('user_roles','DELETE',null,`?user_id=eq.${userId}`);
}
// Invite via Supabase admin invite (needs service role — show instructions instead)
async function inviteUser(email, token){
  // We use the magic link / signup approach — just return the signup URL
  return `${SB_URL}/auth/v1/signup`;
}

function storeSession(s){ localStorage.setItem('lib_session',JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem('lib_session'); }

// ══ MAPPERS ════════════════════════════════════════════
const toM = r=>({id:r.id,memberCode:r.member_code,name:r.name,email:r.email,phone:r.phone||'',address:r.address||'',dateOfBirth:r.date_of_birth||'',idNumber:r.id_number||'',photo:r.photo||'',joinDate:r.join_date});
const fromM = m=>{
  const o={member_code:m.memberCode,name:m.name,email:m.email};
  if(m.phone!==undefined) o.phone=m.phone||null;
  if(m.address!==undefined) o.address=m.address||null;
  if(m.photo!==undefined) o.photo=m.photo||null;
  if(m.dateOfBirth!==undefined) o.date_of_birth=m.dateOfBirth||null;
  if(m.idNumber!==undefined) o.id_number=m.idNumber||null;
  return o;
};
const toB = r=>({id:r.id,barcode:r.barcode,title:r.title,author:r.author,isbn:r.isbn||'',year:r.year||'',category:r.category||'Autre',publisher:r.publisher||'',shelf:r.shelf||'',copies:r.copies,available:r.available,description:r.description||'',addedDate:r.added_date});
const fromB = b=>({barcode:b.barcode,title:b.title,author:b.author,isbn:b.isbn||null,year:b.year||null,category:b.category,publisher:b.publisher||null,shelf:b.shelf||null,copies:b.copies,available:b.available,description:b.description||null});
const toL = r=>({id:r.id,bookId:r.book_id,memberId:r.member_id,loanDate:r.loan_date,dueDate:r.due_date,returnDate:r.return_date||null,daysLate:r.days_late||0,lateFee:r.late_fee||0});

// ══ DB LAYER ═══════════════════════════════════════════
const DB = {
  async getMembers(){
    if(!USE_SB) return gd('lib_members');
    return (await sb('members','GET',null,'?order=join_date.desc')).map(toM);
  },
  async getBooks(){
    if(!USE_SB) return gd('lib_books');
    return (await sb('books','GET',null,'?order=added_date.desc')).map(toB);
  },
  async getLoans(activeOnly=true){
    if(!USE_SB){ const all=gd('lib_loans'); return activeOnly?all.filter(l=>!l.returnDate):all; }
    const qs=activeOnly?'?return_date=is.null&order=loan_date.desc':'?order=loan_date.desc';
    return (await sb('loans','GET',null,qs)).map(toL);
  },
  async addMember(m){
    if(!USE_SB){ sd('lib_members',[...gd('lib_members'),m]); return m; }
    const r=await sb('members','POST',fromM(m)); return toM(Array.isArray(r)?r[0]:r);
  },
  async updateMember(id,m){
    if(!USE_SB){ sd('lib_members',gd('lib_members').map(x=>x.id===id?{...x,...m}:x)); return; }
    await sb('members','PATCH',fromM(m),`?id=eq.${id}`);
  },
  async deleteMember(id){
    if(!USE_SB){ sd('lib_members',gd('lib_members').filter(x=>x.id!==id)); return; }
    await sb('members','DELETE',null,`?id=eq.${id}`);
  },
  async addBook(b){
    if(!USE_SB){ sd('lib_books',[...gd('lib_books'),b]); return b; }
    const r=await sb('books','POST',fromB(b)); return toB(Array.isArray(r)?r[0]:r);
  },
  async updateBook(id,b){
    if(!USE_SB){ sd('lib_books',gd('lib_books').map(x=>x.id===id?{...x,...b}:x)); return; }
    await sb('books','PATCH',fromB(b),`?id=eq.${id}`);
  },
  async deleteBook(id){
    if(!USE_SB){ sd('lib_books',gd('lib_books').filter(x=>x.id!==id)); return; }
    await sb('books','DELETE',null,`?id=eq.${id}`);
  },
  async setAvail(id,delta){
    if(!USE_SB){
      const all=gd('lib_books'),b=all.find(x=>x.id===id);
      if(b){b.available=Math.min(b.copies,Math.max(0,b.available+delta));sd('lib_books',all);}
      return;
    }
    const rows=await sb('books','GET',null,`?id=eq.${id}&select=available,copies`);
    if(rows.length) await sb('books','PATCH',{available:Math.min(rows[0].copies,Math.max(0,rows[0].available+delta))},`?id=eq.${id}`);
  },
  async addLoan(l){
    if(!USE_SB){ sd('lib_loans',[...gd('lib_loans'),l]); return l; }
    const r=await sb('loans','POST',{book_id:l.bookId,member_id:l.memberId,loan_date:l.loanDate,due_date:l.dueDate});
    return toL(Array.isArray(r)?r[0]:r);
  },
  async returnLoan(id,daysLate,lateFee){
    if(!USE_SB){ sd('lib_loans',gd('lib_loans').map(l=>l.id===id?{...l,returnDate:new Date().toISOString(),daysLate,lateFee}:l)); return; }
    await sb('loans','PATCH',{return_date:new Date().toISOString(),days_late:daysLate,late_fee:lateFee},`?id=eq.${id}`);
  },
  async bulkAddBooks(arr){
    if(!USE_SB){ sd('lib_books',[...gd('lib_books'),...arr]); return arr; }
    const r=await sb('books','POST',arr.map(fromB));
    return (Array.isArray(r)?r:[r]).map(toB);
  },
  async renewLoan(id, newDueDate){
    if(!USE_SB){ sd('lib_loans',gd('lib_loans').map(l=>l.id===id?{...l,dueDate:newDueDate}:l)); return; }
    await sb('loans','PATCH',{due_date:newDueDate},`?id=eq.${id}`);
  },
  async payFine(loanId){
    if(!USE_SB){ sd('lib_loans',gd('lib_loans').map(l=>l.id===loanId?{...l,finePaid:true,finePaidDate:new Date().toISOString()}:l)); return; }
    await sb('loans','PATCH',{fine_paid:true,fine_paid_date:new Date().toISOString()},`?id=eq.${loanId}`);
  },
  async getReservations(){
    if(!USE_SB) return gd('lib_reservations');
    try{ return (await sb('reservations','GET',null,'?order=created_at.desc')).map(r=>({id:r.id,bookId:r.book_id,memberId:r.member_id,createdAt:r.created_at})); }
    catch(e){ return gd('lib_reservations'); }
  },
  async addReservation(bookId,memberId){
    const res={id:gid(),bookId,memberId,createdAt:new Date().toISOString()};
    if(!USE_SB){ sd('lib_reservations',[...gd('lib_reservations'),res]); return res; }
    try{ const r=await sb('reservations','POST',{book_id:bookId,member_id:memberId}); return Array.isArray(r)?r[0]:r; }
    catch(e){ sd('lib_reservations',[...gd('lib_reservations'),res]); return res; }
  },
  async cancelReservation(id){
    if(!USE_SB){ sd('lib_reservations',gd('lib_reservations').filter(r=>r.id!==id)); return; }
    try{ await sb('reservations','DELETE',null,`?id=eq.${id}`); }
    catch(e){ sd('lib_reservations',gd('lib_reservations').filter(r=>r.id!==id)); }
  },
  async addLoanNote(id, note){
    if(!USE_SB){ sd('lib_loans',gd('lib_loans').map(l=>l.id===id?{...l,note}:l)); return; }
    await sb('loans','PATCH',{note},`?id=eq.${id}`);
  },
  async setAvailManual(id, available, status){
    if(!USE_SB){ sd('lib_books',gd('lib_books').map(b=>b.id===id?{...b,available,status}:b)); return; }
    await sb('books','PATCH',{available,status},`?id=eq.${id}`);
  },
  async deleteManyBooks(ids){
    if(!USE_SB){ sd('lib_books',gd('lib_books').filter(b=>!ids.includes(b.id))); return; }
    await sb('books','DELETE',null,`?id=in.(${ids.join(',')})`);
  }
};

// ══ PARSERS ════════════════════════════════════════════
function parseBib(txt){
  const res=[],lines=txt.split('\n');
  const cm={book:'Autre',article:'Science',inproceedings:'Science',phdthesis:'Science',mastersthesis:'Science',techreport:'Technologie',manual:'Technologie'};
  let cur=null;
  for(const raw of lines){
    const line=raw.trim();
    if(/^@\w+\s*\x7B/.test(line)){
      const t=(line.match(/^@(\w+)/)||[])[1]||'misc';
      cur={type:t.toLowerCase(),fields:{}};res.push(cur);
    } else if(cur&&line.includes('=')){
      const eq=line.indexOf('=');const key=line.slice(0,eq).trim().toLowerCase();
      let val=line.slice(eq+1).trim();
      if(val.charAt(0)==='\x7B') val=val.slice(1);
      if(val.slice(-2)==='\x7D,') val=val.slice(0,-2);
      else if(val.slice(-1)===',') val=val.slice(0,-1);
      else if(val.slice(-1)==='\x7D') val=val.slice(0,-1);
      if(key&&val) cur.fields[key]=(cur.fields[key]?cur.fields[key]+' ':'')+val.replace(/\s+/g,' ').trim();
    }
  }
  return res.filter(e=>e.fields.title).map(e=>{
    const f=e.fields;
    return {title:f.title||'',author:(f.author||f.editor||'').replace(/ and /gi,', '),isbn:f.isbn||f.isbn13||'',publisher:f.publisher||'',year:f.year||'',description:f.abstract||'',category:cm[e.type]||'Autre',shelf:'',copies:1};
  });
}
function parseRIS(txt){
  const res=[];
  txt.split(/\nER\s*-/).forEach(block=>{
    const f={};
    block.split('\n').forEach(line=>{const m=line.match(/^([A-Z][A-Z0-9])\s+-\s+(.+)$/);if(m){if(!f[m[1]])f[m[1]]=[];f[m[1]].push(m[2].trim());}});
    const title=(f['TI']||f['T1']||f['BT']||[''])[0];if(!title)return;
    const ty=(f['TY']||['BOOK'])[0];
    const cm={BOOK:'Autre',JOUR:'Science',CONF:'Science',THES:'Science',RPRT:'Technologie',COMP:'Technologie'};
    res.push({title,author:(f['AU']||f['A1']||[]).join(', '),year:((f['PY']||f['Y1']||[''])[0]).substring(0,4),isbn:(f['SN']||[''])[0],publisher:(f['PB']||[''])[0],description:(f['AB']||f['N2']||[''])[0],category:cm[ty]||'Autre',shelf:'',copies:1});
  });
  return res;
}
function parseCSV(txt){
  function pl(line){const res=[];let cur='',q=false;for(let i=0;i<line.length;i++){const c=line[i];if(c==='"'&&line[i+1]==='"'){cur+='"';i++;}else if(c==='"'){q=!q;}else if(c===','&&!q){res.push(cur);cur='';}else{cur+=c;}}res.push(cur);return res;}
  const lines=txt.split('\n').filter(l=>l.trim());if(lines.length<2)return[];
  const hdrs=pl(lines[0]).map(h=>h.trim().toLowerCase());
  const col=(...ns)=>{for(const n of ns){const i=hdrs.indexOf(n);if(i!==-1)return i;}return -1;};
  const res=[];
  for(let i=1;i<lines.length;i++){
    const v=pl(lines[i]);const g=(...ns)=>{const idx=col(...ns);return idx!==-1?(v[idx]||'').trim():'';};
    const title=g('title');if(!title)continue;
    const ty=g('item type','type','itemtype').toLowerCase().replace(/\s/g,'');
    const cm={book:'Autre',journalarticle:'Science',conferencepaper:'Science',thesis:'Science',report:'Technologie',computerprogram:'Technologie',artwork:'Art'};
    res.push({title,author:g('author','authors'),year:g('publication year','year','date').substring(0,4),isbn:g('isbn','isbn/issn'),publisher:g('publisher'),description:g('abstract note','abstract'),category:cm[ty]||'Autre',shelf:'',copies:1});
  }
  return res;
}

// ══ TOAST ══════════════════════════════════════════════
function Toasts({list}){
  return <div className="tc">{list.map(t=><div key={t.id} className={`toast ${t.cls}`}><Icon name={t.cls==='ok'?'check':t.cls==='err'?'x':'alert'} size={14} color="currentColor"/><span>{t.msg}</span></div>)}</div>;
}

// ══ LOGIN ══════════════════════════════════════════════
function Login({onLogin}){
  const [mode,setMode]=useState('login');
  const [email,setEmail]=useState('');
  const [pwd,setPwd]=useState('');
  const [loading,setLoading]=useState(false);
  const [err,setErr]=useState('');

  async function handle(){
    if(!email||!pwd){setErr('Email et mot de passe requis');return;}
    setLoading(true);setErr('');
    try{
      let data;
      if(mode==='login') data=await sbSignIn(email,pwd);
      else data=await sbSignUp(email,pwd);
      if(data.access_token){ storeSession(data); onLogin(data); }
      else if(mode==='register'){ setErr('Compte créé ! Vérifiez votre email puis connectez-vous.'); setMode('login'); }
    }catch(e){ setErr(e.message); }
    finally{ setLoading(false); }
  }

  return(
    <div className="login-wrap">
      <div className="login-box">
        <div className="login-icon"><Icon name="library" size={26}/></div>
        <div className="login-title">Bibliothèque</div>
        <div className="login-sub">Système de gestion professionnel</div>
        <div className="login-tabs">
          <button className={`login-tab${mode==='login'?' active':''}`} onClick={()=>{setMode('login');setErr('');}}>Connexion</button>
          <button className={`login-tab${mode==='register'?' active':''}`} onClick={()=>{setMode('register');setErr('');}}>Inscription</button>
        </div>
        {err&&<div className="login-err">{err}</div>}
        <div className="fg"><label className="fl">Email</label><input className="fi" type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="admin@bibliotheque.com" onKeyPress={e=>e.key==='Enter'&&handle()}/></div>
        <div className="fg"><label className="fl">Mot de passe</label><input className="fi" type="password" value={pwd} onChange={e=>setPwd(e.target.value)} placeholder="••••••••" onKeyPress={e=>e.key==='Enter'&&handle()}/></div>
        <button className="btn btn-primary" style={{width:'100%',justifyContent:'center',marginTop:6,padding:'12px'}} onClick={handle} disabled={loading}>
          {loading?<span className="spinner"/>:<><Icon name={mode==='login'?'log-out':'user'} size={15}/>{mode==='login'?'Se connecter':'Créer le compte'}</>}
        </button>
      </div>
    </div>
  );
}

// ══ APP ════════════════════════════════════════════════
function App(){
  const [session,setSession]=useState(null);
  const [authReady,setAuthReady]=useState(false);
  const [tab,setTab]=useState('dashboard');
  const [members,setMembers]=useState([]);
  const [books,setBooks]=useState([]);
  const [loans,setLoans]=useState([]);
  const [history,setHistory]=useState([]);
  const [loading,setLoading]=useState(true);
  const [modal,setModal]=useState(null);
  const [search,setSearch]=useState('');
  const [catF,setCatF]=useState('all');
  const [scanVal,setScanVal]=useState('');
  const [scanSt,setScanSt]=useState('');
  const [scanItem,setScanItem]=useState(null);
  const [toasts,setToasts]=useState([]);
  const [cfg,setCfg]=useState({libraryName:'Ma Bibliothèque',libraryLogo:'',loanDays:14,feePerDay:10});
  const [mf,setMf]=useState({name:'',email:'',phone:'',address:'',dateOfBirth:'',idNumber:'',photo:''});
  const [bf,setBf]=useState({title:'',author:'',isbn:'',year:'',category:'Fiction',publisher:'',shelf:'',copies:1,description:''});
  const [editM,setEditM]=useState(null);
  const [editB,setEditB]=useState(null);
  const [zp,setZp]=useState([]);
  const [zst,setZst]=useState('');
  const [emailSending,setEmailSending]=useState(false);
  const [theme,setTheme]=useState(()=>localStorage.getItem('lib_theme')||'light');
  const [userRole,setUserRole]=useState('readonly');
  const [teamMembers,setTeamMembers]=useState([]);
  const [histSearch,setHistSearch]=useState('');
  const [reservations,setReservations]=useState([]);
  const [selectedMember,setSelectedMember]=useState(null);
  const [selectedBook,setSelectedBook]=useState(null);
  const [renewLoanId,setRenewLoanId]=useState(null);
  const [selectedBooks,setSelectedBooks]=useState(new Set());
  const [selectMode,setSelectMode]=useState(false);
  const [globalSearch,setGlobalSearch]=useState('');
  const [showGlobalSearch,setShowGlobalSearch]=useState(false);
  const [dashWidgets,setDashWidgets]=useState(()=>JSON.parse(localStorage.getItem('lib_widgets')||'["stats","overdue","categories","topbooks"]'));
  const [isbnLoading,setIsbnLoading]=useState(false);
  const [noteModal,setNoteModal]=useState(null);

  const scanRef=useRef(),logoRef=useRef(),photoRef=useRef(),importRef=useRef(),zRef=useRef();

  useEffect(()=>{
    document.documentElement.setAttribute('data-theme',theme);
    localStorage.setItem('lib_theme',theme);
  },[theme]);

  // ── Keyboard shortcuts ──────────────────────────────
  useEffect(()=>{
    const handler=(e)=>{
      if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT') return;
      if(e.key==='/'){ e.preventDefault(); setShowGlobalSearch(s=>!s); return; }
      if(e.key==='Escape'){ setShowGlobalSearch(false); setSelectMode(false); return; }
      if(!session) return;
      if(e.key==='m'||e.key==='M') setTab('members');
      if(e.key==='l'||e.key==='L') setTab('loans');
      if(e.key==='b'||e.key==='B') setTab('books');
      if(e.key==='d'||e.key==='D') setTab('dashboard');
      if(e.key==='h'||e.key==='H') setTab('history');
      if(e.key==='n'||e.key==='N'){
        if(tab==='books'&&canEdit) setBf({title:'',author:'',isbn:'',year:'',category:'Fiction',publisher:'',shelf:'',copies:1,description:''})||setModal('book');
        if(tab==='members'&&canEdit) setMf({name:'',email:'',phone:'',address:'',dateOfBirth:'',idNumber:'',photo:''})||setModal('member');
      }
    };
    window.addEventListener('keydown',handler);
    return()=>window.removeEventListener('keydown',handler);
  },[session,tab,canEdit]);

  useEffect(()=>{
    const stored=getStoredSession();
    if(stored&&stored.access_token){
      setSession(stored);
      // Immediately check role from stored session
      const email = getEmailFromSession(stored);
      const uid = stored.user?.id;
      if(uid||email){
        getUserRole(uid, email).then(r=>setUserRole(r));
      }
    }
    setAuthReady(true);
    const s=gsettings(); if(s&&s.libraryName) setCfg(prev=>({...prev,...s}));
  },[]);

  useEffect(()=>{
    if(session&&session.user){
      reload();
      // Fetch user role
      const uid = session.user?.id || session.user;
      const email = getEmailFromSession(session);
      getUserRole(uid, email).then(r=>{
        setUserRole(r);
      });
    }
  },[session]);
  useEffect(()=>{ if(tab==='scanner'&&scanRef.current) scanRef.current.focus(); },[tab]);

  function handleLogin(data){ storeSession(data); setSession(data); }
  async function handleLogout(){
    try{ if(session) await sbSignOut(session.access_token); }catch(e){}
    clearSession(); setSession(null); setMembers([]); setBooks([]); setLoans([]); setHistory([]);
  }

  async function reload(){
    setLoading(true);
    try{
      const[m,b,l,h,rv]=await Promise.all([DB.getMembers(),DB.getBooks(),DB.getLoans(true),DB.getLoans(false),DB.getReservations()]);
      setMembers(m);setBooks(b);setLoans(l);setHistory(h);setReservations(rv);
    }catch(e){ toast(e.message,'err'); }
    finally{ setLoading(false); }
  }

  function toast(msg,cls='ok'){
    const id=gid();
    setToasts(p=>[...p,{id,msg,cls}]);
    setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),3600);
  }
  const close=()=>setModal(null);

  function saveCfg(s){ setCfg(s); localStorage.setItem('lib_cfg',JSON.stringify(s)); toast('Paramètres sauvegardés'); close(); }

  async function saveMember(){
    if(!mf.name||!mf.email){ toast('Nom et email requis','err'); return; }
    try{
      if(editM){ await DB.updateMember(editM.id,mf); toast('Membre mis à jour'); }
      else{
        const all=await DB.getMembers();
        const maxN=all.reduce((mx,m)=>Math.max(mx,parseInt((m.memberCode||'').replace('MBR-','')||0)),0);
        await DB.addMember({...mf,id:gid(),memberCode:`MBR-${String(maxN+1).padStart(4,'0')}`,joinDate:new Date().toISOString()});
        toast('Membre ajouté !');
      }
      setMf({name:'',email:'',phone:'',address:'',dateOfBirth:'',idNumber:'',photo:''});
      setEditM(null); close(); reload();
    }catch(e){ toast(e.message,'err'); }
  }
  async function delMember(id){
    if(!confirm('Supprimer ce membre ?')) return;
    if(loans.some(l=>l.memberId===id)){ toast('Membre avec prêts actifs','err'); return; }
    try{ await DB.deleteMember(id); toast('Membre supprimé'); reload(); }
    catch(e){ toast(e.message,'err'); }
  }
  function openEditM(m){ setMf({...m}); setEditM(m); setModal('member'); }

  async function saveBook(){
    if(!bf.title||!bf.author){ toast('Titre et auteur requis','err'); return; }
    try{
      const copies=parseInt(bf.copies)||1;
      if(editB){ await DB.updateBook(editB.id,{...bf,copies}); toast('Livre mis à jour'); }
      else{
        const all=await DB.getBooks();
        const maxN=all.reduce((mx,b)=>Math.max(mx,parseInt((b.barcode||'').replace('BOOK-','')||0)),0);
        await DB.addBook({...bf,copies,available:copies,id:gid(),barcode:`BOOK-${String(maxN+1).padStart(4,'0')}`,addedDate:new Date().toISOString()});
        toast('Livre ajouté !');
      }
      setBf({title:'',author:'',isbn:'',year:'',category:'Fiction',publisher:'',shelf:'',copies:1,description:''});
      setEditB(null); close(); reload();
    }catch(e){ toast(e.message,'err'); }
  }
  async function delBook(id){
    if(!confirm('Supprimer ce livre ?')) return;
    if(loans.some(l=>l.bookId===id)){ toast('Livre actuellement prêté','err'); return; }
    try{ await DB.deleteBook(id); toast('Livre supprimé'); reload(); }
    catch(e){ toast(e.message,'err'); }
  }
  function openEditB(b){ setBf({...b}); setEditB(b); setModal('book'); }

  async function createLoan(bookId,memberId){
    const bk=books.find(b=>b.id===bookId);
    if(!bk||bk.available<=0){ toast('Livre non disponible','err'); return; }
    try{
      const due=new Date(); due.setDate(due.getDate()+(cfg.loanDays||14));
      await DB.addLoan({id:gid(),bookId,memberId,loanDate:new Date().toISOString(),dueDate:due.toISOString(),returnDate:null});
      await DB.setAvail(bookId,-1);
      toast('Prêt créé !'); setScanVal(''); setScanSt('Prêt enregistré avec succès');
      setTimeout(()=>setScanSt(''),3000); reload();
    }catch(e){ toast(e.message,'err'); }
  }
  async function returnLoan(loanId){
    const loan=loans.find(l=>l.id===loanId); if(!loan) return;
    const now=new Date(),due=new Date(loan.dueDate);
    const daysLate=Math.max(0,Math.ceil((now-due)/86400000));
    const lateFee=daysLate*(cfg.feePerDay||10);
    try{
      await DB.returnLoan(loanId,daysLate,lateFee);
      await DB.setAvail(loan.bookId,+1);
      if(daysLate>0) toast(`${daysLate}j retard — ${lateFee} HTG`,'warn');
      else toast('Retour enregistré');
      reload();
    }catch(e){ toast(e.message,'err'); }
  }

  function handleScan(e){
    if(e.key!=='Enter'||!scanVal.trim()) return;
    const code=scanVal.trim().toUpperCase();
    if(code.startsWith('MBR-')){
      const m=members.find(x=>x.memberCode===code);
      if(m){ setScanItem({type:'member',data:m}); setScanSt(`Membre trouvé : ${m.name}`); }
      else setScanSt('Membre non trouvé');
    } else {
      const b=books.find(x=>x.barcode===code||x.isbn===code||(x.isbn||'').replace(/-/g,'')===code);
      if(b){
        if(scanItem&&scanItem.type==='member'){ createLoan(b.id,scanItem.data.id); setScanItem(null); }
        else{ setScanItem({type:'book',data:b}); setScanSt(`Livre trouvé : ${b.title}`); }
      } else setScanSt('Code non trouvé');
    }
    setScanVal('');
  }

  async function sendLateEmails(){
    const overdueLoans=loans.filter(l=>new Date(l.dueDate)<new Date());
    if(!overdueLoans.length){ toast('Aucun retard à notifier','warn'); return; }
    setEmailSending(true);
    let sent=0,failed=0;
    for(const loan of overdueLoans){
      const mb=members.find(m=>m.id===loan.memberId);
      const bk=books.find(b=>b.id===loan.bookId);
      if(!mb||!mb.email) continue;
      const daysLate=Math.ceil((new Date()-new Date(loan.dueDate))/86400000);
      try{
        const res=await fetch(`${SB_URL}/functions/v1/send-late-email`,{
          method:'POST',
          headers:{'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json'},
          body:JSON.stringify({to:mb.email,memberName:mb.name,bookTitle:bk?.title||'?',daysLate,fee:daysLate*(cfg.feePerDay||10),libraryName:cfg.libraryName})
        });
        if(res.ok) sent++; else failed++;
      }catch{ failed++; }
    }
    setEmailSending(false);
    if(sent>0) toast(`${sent} email(s) envoyé(s)`);
    if(failed>0) toast(`${failed} échec(s) — configurez la fonction Edge Supabase`,'warn');
  }

  async function exportCSV(){
    const bom='\ufeff';
    let csv=bom+'Type,Code,Nom/Titre,Email/Auteur,Tél/ISBN,Statut,Date\n';
    members.forEach(m=>{ csv+=`Membre,"${m.memberCode}","${m.name}","${m.email}","${m.phone||''}",Actif,${new Date(m.joinDate).toLocaleDateString('fr-FR')}\n`; });
    books.forEach(b=>{ csv+=`Livre,"${b.barcode}","${b.title}","${b.author}","${b.isbn||''}","${b.available}/${b.copies}",${new Date(b.addedDate).toLocaleDateString('fr-FR')}\n`; });
    history.forEach(l=>{
      const bk=books.find(x=>x.id===l.bookId),mb=members.find(x=>x.id===l.memberId);
      csv+=`Prêt,"${l.id}","${bk?.title||''}","${mb?.name||''}","${new Date(l.dueDate).toLocaleDateString('fr-FR')}","${l.returnDate?'Retourné':'En cours'}",${new Date(l.loanDate).toLocaleDateString('fr-FR')}\n`;
    });
    dlBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}),`bibliotheque-${today()}.csv`);
    toast('Export CSV téléchargé');
  }
  async function exportJSON(){
    const data={members,books,loans:history,settings:cfg,exportDate:new Date().toISOString()};
    dlBlob(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),`backup-${today()}.json`);
    toast('Sauvegarde téléchargée');
  }
  function importJSON(e){
    const file=e.target.files[0]; if(!file) return;
    const r=new FileReader();
    r.onload=ev=>{ try{
      const d=JSON.parse(ev.target.result);
      if(d.members) sd('lib_members',d.members);
      if(d.books) sd('lib_books',d.books);
      if(d.loans) sd('lib_loans',d.loans);
      if(d.settings) localStorage.setItem('lib_cfg',JSON.stringify(d.settings));
      reload(); toast('Données importées');
    }catch{ toast('Fichier invalide','err'); } };
    r.readAsText(file,'UTF-8'); e.target.value='';
  }

  function handleZFile(e){
    const file=e.target.files[0]; if(!file) return;
    setZst('Analyse en cours…'); setZp([]);
    const r=new FileReader();
    r.onload=ev=>{
      const txt=ev.target.result,ext=file.name.split('.').pop().toLowerCase();
      let parsed=[];
      if(ext==='bib') parsed=parseBib(txt);
      else if(ext==='ris') parsed=parseRIS(txt);
      else if(ext==='csv') parsed=parseCSV(txt);
      else{ setZst('Format non supporté (.bib, .ris, .csv)'); return; }
      if(!parsed.length) setZst('Aucune référence trouvée');
      else{ setZp(parsed.map((b,i)=>({...b,_s:true,_i:i}))); setZst(`${parsed.length} référence(s) trouvée(s)`); }
    };
    r.readAsText(file,'UTF-8'); e.target.value='';
  }
  async function doZotero(){
    const toImport=zp.filter(b=>b._s);
    if(!toImport.length){ toast('Sélectionnez au moins un livre','err'); return; }
    try{
      const all=await DB.getBooks();
      let maxN=all.reduce((mx,b)=>Math.max(mx,parseInt((b.barcode||'').replace('BOOK-','')||0)),0);
      let skip=0; const nb=[];
      toImport.forEach(b=>{
        if(all.find(x=>x.title?.toLowerCase()===b.title?.toLowerCase()&&x.author?.toLowerCase()===b.author?.toLowerCase())){ skip++; return; }
        maxN++;
        nb.push({title:b.title,author:b.author,isbn:b.isbn,publisher:b.publisher,year:b.year,category:b.category,description:b.description,shelf:'',copies:1,available:1,id:gid(),barcode:`BOOK-${String(maxN).padStart(4,'0')}`,addedDate:new Date().toISOString()});
      });
      if(nb.length) await DB.bulkAddBooks(nb);
      reload(); setZp([]); setZst(''); close();
      toast(skip>0?`${nb.length} importé(s), ${skip} doublon(s)`:`${nb.length} livre(s) importé(s)`,skip>0?'warn':'ok');
    }catch(e){ toast(e.message,'err'); }
  }

  // ── ISBN lookup ──────────────────────────────────────
  async function lookupISBN(isbn){
    if(!isbn||isbn.length<10){ toast('ISBN invalide','err'); return null; }
    setIsbnLoading(true);
    try{
      const r=await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
      const d=await r.json();
      const book=d[`ISBN:${isbn}`];
      if(!book){ toast('Livre non trouvé pour cet ISBN','warn'); return null; }
      return {
        title: book.title||'',
        author: (book.authors||[]).map(a=>a.name).join(', '),
        year: book.publish_date?(book.publish_date.match(/\d{4}/)||[''])[0]:'',
        publisher: (book.publishers||[]).map(p=>p.name).join(', '),
        isbn
      };
    }catch(e){ toast('Erreur de recherche ISBN','err'); return null; }
    finally{ setIsbnLoading(false); }
  }

  // ── Bulk delete books ─────────────────────────────────
  async function deleteBulkBooks(){
    if(!selectedBooks.size) return;
    if(!confirm(`Supprimer ${selectedBooks.size} livre(s) sélectionné(s) ?`)) return;
    try{
      await DB.deleteManyBooks([...selectedBooks]);
      toast(`${selectedBooks.size} livre(s) supprimé(s)`);
      setSelectedBooks(new Set());
      setSelectMode(false);
      reload();
    }catch(e){ toast(e.message,'err'); }
  }

  // ── Duplicate book ────────────────────────────────────
  async function duplicateBook(bk){
    const newBook={...bk, id:gid(), barcode:'BK-'+Date.now().toString(36).toUpperCase(), available:bk.copies, addedDate:new Date().toISOString()};
    try{ await DB.addBook(newBook); toast('Livre dupliqué !'); reload(); }
    catch(e){ toast(e.message,'err'); }
  }

  // ── Set availability manually ─────────────────────────
  async function setAvailManual(bookId, available, status){
    try{ await DB.setAvailManual(bookId, parseInt(available), status); toast('Disponibilité mise à jour'); reload(); }
    catch(e){ toast(e.message,'err'); }
  }

  // ── Send individual reminder ──────────────────────────
  async function sendReminderEmail(loan){
    const mb=members.find(m=>m.id===loan.memberId);
    const bk=books.find(b=>b.id===loan.bookId);
    if(!mb?.email){ toast('Membre sans email','err'); return; }
    const daysLeft=Math.ceil((new Date(loan.dueDate)-new Date())/86400000);
    const subject=`Rappel: retour de "${bk?.title||'livre'}"`;
    const body=`Bonjour ${mb.name},

Ce message est un rappel pour le retour du livre "${bk?.title||'?'}" emprunté à ${cfg.libraryName}.

Date de retour prévue : ${new Date(loan.dueDate).toLocaleDateString('fr-FR')}${daysLeft<0?' ('+Math.abs(daysLeft)+' jours de retard)':''}.

Merci.
${cfg.libraryName}`;
    const mailto=`mailto:${mb.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailto);
    toast('Client email ouvert');
  }

  // ── Save loan note ────────────────────────────────────
  async function saveLoanNote(loanId, note){
    try{ await DB.addLoanNote(loanId,note); toast('Note enregistrée'); setNoteModal(null); reload(); }
    catch(e){ toast(e.message,'err'); }
  }

  // ── Toggle widget on dashboard ────────────────────────
  function toggleWidget(key){
    const next=dashWidgets.includes(key)?dashWidgets.filter(w=>w!==key):[...dashWidgets,key];
    setDashWidgets(next);
    localStorage.setItem('lib_widgets',JSON.stringify(next));
  }

  // ── Renew loan ──────────────────────────────────────
  async function renewLoan(loanId){
    const loan=loans.find(l=>l.id===loanId); if(!loan) return;
    const newDue=new Date(loan.dueDate); newDue.setDate(newDue.getDate()+(cfg.loanDays||14));
    try{ await DB.renewLoan(loanId,newDue.toISOString()); toast('Prêt renouvelé jusqu\'au '+newDue.toLocaleDateString('fr-FR')); setRenewLoanId(null); reload(); }
    catch(e){ toast(e.message,'err'); }
  }
  async function payFine(loanId){
    try{ await DB.payFine(loanId); toast('Amende marquée payée !'); reload(); }
    catch(e){ toast(e.message,'err'); }
  }
  async function reserveBook(bookId,memberId){
    if(reservations.some(r=>r.bookId===bookId&&r.memberId===memberId)){ toast('Déjà réservé','err'); return; }
    try{ await DB.addReservation(bookId,memberId); toast('Réservation enregistrée !'); reload(); }
    catch(e){ toast(e.message,'err'); }
  }
  async function cancelReservation(id){
    try{ await DB.cancelReservation(id); toast('Réservation annulée'); reload(); }
    catch(e){ toast(e.message,'err'); }
  }
  function printBookBarcode(book){
    const bar=`https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(book.barcode)}&code=Code128&dpi=200&bgcolor=FFFFFF&fgcolor=000000`;
    const qr=`https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(book.barcode)}&bgcolor=ffffff&color=000000`;
    const thC=theme==='green'?'#14532d':theme==='blue'?'#0f1d35':'#111827';
    const acC=theme==='green'?'#4ade80':theme==='blue'?'#60a5fa':theme==='dark'?'#e8c97a':'#2563eb';
    const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>
@page{size:85.6mm 54mm landscape;margin:0}
*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;margin:0;padding:0;box-sizing:border-box}
html,body{width:85.6mm;height:54mm;overflow:hidden}
body{font-family:Arial,Helvetica,sans-serif}
.card{width:85.6mm;height:54mm;background:linear-gradient(135deg,${thC},#000);display:flex;flex-direction:column;overflow:hidden}
.top{padding:3mm 4mm 2.5mm;display:flex;align-items:center;border-bottom:0.3mm solid rgba(255,255,255,.12);flex-shrink:0;background:rgba(255,255,255,.07)}
.lib{font-size:2.8mm;font-weight:700;color:#fff}
.sub{font-size:1.7mm;color:rgba(255,255,255,.4);letter-spacing:.06em;text-transform:uppercase;margin-top:.3mm}
.body{display:flex;flex:1;padding:3mm 4mm;gap:3mm;overflow:hidden;align-items:center}
.info{flex:1;min-width:0}
.title{font-size:2.8mm;font-weight:700;color:#fff;line-height:1.3;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.author{font-size:2.1mm;color:rgba(255,255,255,.55);margin-top:1.5mm;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.cat{font-size:1.7mm;color:${acC};font-weight:600;margin-top:1.5mm;text-transform:uppercase;letter-spacing:.05em}
.code{font-size:2.2mm;font-weight:800;letter-spacing:1.5mm;color:${acC};font-family:'Courier New',monospace;margin-top:2mm;background:rgba(255,255,255,.07);padding:1mm 2mm;border-radius:.8mm}
.right{display:flex;flex-direction:column;align-items:center;gap:1.5mm;flex-shrink:0;width:22mm}
.qr-box{background:#fff;border-radius:1mm;padding:.8mm;line-height:0}
.bar-box{background:#fff;border-radius:.8mm;padding:.8mm 1mm;width:100%;line-height:0}
</style></head><body>
<div class="card">
  <div class="top"><div><div class="lib">${cfg.libraryName}</div><div class="sub">Étiquette livre</div></div></div>
  <div class="body">
    <div class="info">
      <div class="title">${book.title}</div>
      <div class="author">${book.author}</div>
      <div class="cat">${book.category}${book.shelf?' · '+book.shelf:''}</div>
      <div class="code">${book.barcode}</div>
    </div>
    <div class="right">
      <div class="qr-box"><img src="${qr}" width="20mm" height="20mm"></div>
      <div class="bar-box"><img src="${bar}" width="100%" height="7mm"></div>
    </div>
  </div>
</div></body></html>`;
    let iframe=document.getElementById('_pb');
    if(!iframe){ iframe=document.createElement('iframe'); iframe.id='_pb'; iframe.style.cssText='position:fixed;top:-9999px;left:-9999px;width:350px;height:230px;border:none;'; document.body.appendChild(iframe); }
    iframe.onload=()=>{ const imgs=iframe.contentDocument.querySelectorAll('img'); let done=0; const tryPrint=()=>{ if(++done>=imgs.length) setTimeout(()=>iframe.contentWindow.print(),500); }; if(!imgs.length) setTimeout(()=>iframe.contentWindow.print(),500); else imgs.forEach(img=>{ if(img.complete) tryPrint(); else{ img.onload=tryPrint; img.onerror=tryPrint; } }); };
    iframe.srcdoc=html;
  }
  function printMonthlyReport(){
    const now=new Date();
    const monthStart=new Date(now.getFullYear(),now.getMonth(),1);
    const monthName=now.toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
    const mLoans=history.filter(l=>new Date(l.loanDate)>=monthStart);
    const mReturns=history.filter(l=>l.returnDate&&new Date(l.returnDate)>=monthStart);
    const mLate=history.filter(l=>l.returnDate&&new Date(l.returnDate)>=monthStart&&l.daysLate>0);
    const totalFees=mLate.reduce((s,l)=>s+(l.lateFee||0),0);
    const activeMembers=[...new Set(mLoans.map(l=>l.memberId))].length;
    const topBooks=books.map(b=>({...b,cnt:history.filter(l=>l.bookId===b.id).length})).sort((a,b)=>b.cnt-a.cnt).slice(0,10);
    const thC=theme==='green'?'#14532d':theme==='blue'?'#0f1d35':'#111827';
    const acC=theme==='green'?'#16a34a':theme==='blue'?'#2563eb':theme==='dark'?'#c9a84c':'#2563eb';
    const rows=mLoans.slice(0,20).map(l=>{const mb=members.find(m=>m.id===l.memberId),bk=books.find(b=>b.id===l.bookId);return `<tr><td>${bk?.title||'?'}</td><td>${mb?.name||'?'}</td><td>${new Date(l.loanDate).toLocaleDateString('fr-FR')}</td><td>${l.returnDate?new Date(l.returnDate).toLocaleDateString('fr-FR'):'En cours'}</td><td style="color:${l.daysLate>0?'#dc2626':'#16a34a'}">${l.daysLate>0?l.daysLate+'j / '+l.lateFee+' HTG':'OK'}</td></tr>`;}).join('');
    const topRows=topBooks.filter(b=>b.cnt>0).map((b,i)=>`<tr><td>${i+1}</td><td>${b.title}</td><td>${b.author}</td><td>${b.cnt}</td></tr>`).join('');
    const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>
@page{size:A4;margin:18mm 15mm}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;color:#111;font-size:10pt;line-height:1.4;-webkit-print-color-adjust:exact!important}
.header{display:flex;justify-content:space-between;align-items:start;padding-bottom:8mm;border-bottom:0.5mm solid #e5e7eb;margin-bottom:8mm}
.lib-name{font-size:18pt;font-weight:700;color:${thC}}
.lib-sub{font-size:10pt;color:#6b7280;margin-top:1mm}
.report-title h1{font-size:14pt;color:${acC};font-weight:700;text-align:right}
.report-title p{font-size:9pt;color:#6b7280;margin-top:1mm;text-align:right}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:5mm;margin-bottom:8mm}
.stat{background:#f9fafb;border:0.3mm solid #e5e7eb;border-radius:2mm;padding:4mm;text-align:center}
.stat-n{font-size:20pt;font-weight:700;color:${acC};font-family:Georgia,serif}
.stat-l{font-size:8pt;color:#6b7280;margin-top:1mm;text-transform:uppercase;letter-spacing:.04em}
.section{margin-bottom:7mm}
.section h2{font-size:11pt;font-weight:700;color:${thC};margin-bottom:3mm;padding-bottom:1.5mm;border-bottom:0.3mm solid #e5e7eb}
table{width:100%;border-collapse:collapse;font-size:8.5pt}
th{background:#f3f4f6;padding:2.5mm 3mm;text-align:left;font-weight:600;border-bottom:0.3mm solid #d1d5db}
td{padding:2mm 3mm;border-bottom:0.2mm solid #f3f4f6}
tr:last-child td{border-bottom:none}
.footer{margin-top:10mm;padding-top:4mm;border-top:0.3mm solid #e5e7eb;font-size:8pt;color:#9ca3af;display:flex;justify-content:space-between}
</style></head><body>
<div class="header">
  <div><div class="lib-name">${cfg.libraryName}</div><div class="lib-sub">Rapport mensuel de bibliothèque</div></div>
  <div class="report-title"><h1>Rapport — ${monthName}</h1><p>Généré le ${now.toLocaleDateString('fr-FR')}</p></div>
</div>
<div class="stats-grid">
  <div class="stat"><div class="stat-n">${members.length}</div><div class="stat-l">Membres</div></div>
  <div class="stat"><div class="stat-n">${books.length}</div><div class="stat-l">Livres</div></div>
  <div class="stat"><div class="stat-n">${mLoans.length}</div><div class="stat-l">Prêts ce mois</div></div>
  <div class="stat"><div class="stat-n">${activeMembers}</div><div class="stat-l">Membres actifs</div></div>
  <div class="stat"><div class="stat-n">${mReturns.length}</div><div class="stat-l">Retours ce mois</div></div>
  <div class="stat"><div class="stat-n">${loans.length}</div><div class="stat-l">Prêts en cours</div></div>
  <div class="stat"><div class="stat-n">${mLate.length}</div><div class="stat-l">Retards</div></div>
  <div class="stat"><div class="stat-n">${totalFees} HTG</div><div class="stat-l">Amendes</div></div>
</div>
${rows?`<div class="section"><h2>Prêts du mois</h2><table><thead><tr><th>Livre</th><th>Membre</th><th>Prêt</th><th>Retour</th><th>Retard</th></tr></thead><tbody>${rows}</tbody></table></div>`:''}
${topRows?`<div class="section"><h2>Top livres empruntés</h2><table><thead><tr><th>#</th><th>Titre</th><th>Auteur</th><th>Prêts</th></tr></thead><tbody>${topRows}</tbody></table></div>`:''}
<div class="footer"><span>${cfg.libraryName} — Confidentiel</span><span>${now.toLocaleDateString('fr-FR')}</span></div>
</body></html>`;
    const w=window.open('','_blank','width=820,height=1100');
    if(!w){ toast('Autorisez les popups pour imprimer','warn'); return; }
    w.document.write(html); w.document.close(); setTimeout(()=>w.print(),800);
  }

  // ── Print card — format portrait CR80 (54×85.6mm) ──
  function printCard(member){
    const qr=`https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(member.memberCode)}&bgcolor=ffffff&color=000000`;
    const bar=`https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(member.memberCode)}&code=Code128&dpi=200&bgcolor=FFFFFF&fgcolor=000000`;
    const lib=cfg.libraryName;
    const thC=theme==='green'?'#14532d':theme==='blue'?'#0f1d35':'#111827';
    const acC=theme==='green'?'#4ade80':theme==='blue'?'#60a5fa':theme==='dark'?'#e8c97a':'#2563eb';
    const since=new Date(member.joinDate).toLocaleDateString('fr-FR');
    const html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
<style>
@page{size:54mm 85.6mm portrait;margin:0}
*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important;margin:0;padding:0;box-sizing:border-box}
html,body{width:54mm;height:85.6mm;overflow:hidden}
body{font-family:Arial,Helvetica,sans-serif}
.card{width:54mm;height:85.6mm;background:linear-gradient(170deg,${thC} 0%,#000 100%);display:flex;flex-direction:column;overflow:hidden;position:relative}
.header{padding:3.5mm 3.5mm 2.5mm;display:flex;align-items:center;gap:2mm;border-bottom:0.3mm solid rgba(255,255,255,.12);flex-shrink:0;background:rgba(255,255,255,.07)}
.logo-box{width:7mm;height:7mm;border-radius:1.5mm;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-size:4mm;flex-shrink:0}
.lib-name{font-size:2.8mm;font-weight:700;color:#fff;line-height:1;letter-spacing:.01em}
.lib-sub{font-size:1.7mm;color:rgba(255,255,255,.45);letter-spacing:.06em;text-transform:uppercase;margin-top:.4mm}
.photo-section{display:flex;justify-content:center;align-items:center;padding:4mm 3.5mm 3mm;flex-shrink:0}
.photo{width:22mm;height:22mm;border-radius:50%;border:0.6mm solid ${acC};object-fit:cover}
.no-photo{width:22mm;height:22mm;border-radius:50%;border:0.6mm solid rgba(255,255,255,.25);background:rgba(255,255,255,.09);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.4);font-size:10mm}
.info-section{flex:1;padding:0 3.5mm 2mm;display:flex;flex-direction:column;gap:2mm}
.field{display:flex;flex-direction:column;gap:.5mm}
.f-label{font-size:1.5mm;color:rgba(255,255,255,.38);text-transform:uppercase;letter-spacing:.06em}
.f-val{font-size:2.6mm;color:rgba(255,255,255,.92);font-weight:600;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:46mm}
.f-val.sm{font-size:2.1mm}
.code-section{padding:0 3mm 2.5mm;display:flex;flex-direction:column;gap:1.5mm;flex-shrink:0}
.member-code{background:rgba(255,255,255,.08);border:0.3mm solid rgba(255,255,255,.15);border-radius:1mm;padding:1.8mm 2.5mm;text-align:center}
.code-val{font-size:3.2mm;font-weight:800;letter-spacing:2.5mm;color:${acC};font-family:'Courier New',monospace}
.qr-section{display:flex;justify-content:center;padding:0 3mm 2mm;flex-shrink:0}
.qr-box{background:#fff;border-radius:1.5mm;padding:1mm;display:inline-block;line-height:0}
.bar-section{padding:0 3mm 2.5mm;flex-shrink:0}
.bar-box{background:#fff;border-radius:1mm;padding:.8mm 1mm;line-height:0}
.since{text-align:center;font-size:1.6mm;color:rgba(255,255,255,.28);padding-bottom:1.5mm;letter-spacing:.04em}
</style></head><body>
<div class="card">
  <div class="header">
    ${cfg.libraryLogo
      ?`<img src="${cfg.libraryLogo}" class="logo-box" style="object-fit:cover;border-radius:1.5mm">`
      :`<div class="logo-box">&#128218;</div>`}
    <div><div class="lib-name">${lib}</div><div class="lib-sub">Carte de membre</div></div>
  </div>
  <div class="photo-section">
    ${member.photo
      ?`<img src="${member.photo}" class="photo">`
      :`<div class="no-photo">&#128100;</div>`}
  </div>
  <div class="info-section">
    <div class="field"><span class="f-label">Nom complet</span><span class="f-val">${member.name}</span></div>
    <div class="field"><span class="f-label">Email</span><span class="f-val sm">${member.email}</span></div>
    ${member.phone?`<div class="field"><span class="f-label">Téléphone</span><span class="f-val">${member.phone}</span></div>`:''}
  </div>
  <div class="code-section">
    <div class="member-code"><span class="code-val">${member.memberCode}</span></div>
  </div>
  <div class="qr-section">
    <div class="qr-box"><img src="${qr}" width="28mm" height="28mm"></div>
  </div>
  <div class="bar-section">
    <div class="bar-box"><img src="${bar}" width="100%" height="8mm"></div>
  </div>
  <div class="since">Membre depuis ${since}</div>
</div>
</body></html>`;
    let iframe=document.getElementById('_pf');
    if(!iframe){
      iframe=document.createElement('iframe');
      iframe.id='_pf';
      iframe.style.cssText='position:fixed;top:-9999px;left:-9999px;width:220px;height:340px;border:none;';
      document.body.appendChild(iframe);
    }
    iframe.onload=()=>{
      const imgs=iframe.contentDocument.querySelectorAll('img');
      let done=0;
      const tryPrint=()=>{ if(++done>=imgs.length) setTimeout(()=>iframe.contentWindow.print(),500); };
      if(!imgs.length) setTimeout(()=>iframe.contentWindow.print(),500);
      else imgs.forEach(img=>{ if(img.complete) tryPrint(); else{ img.onload=tryPrint; img.onerror=tryPrint; } });
    };
    iframe.srcdoc=html;
  }


  // ── Helpers permissions ──
  const isAdmin = userRole === 'admin';
  const canEdit = userRole === 'admin' || userRole === 'librarian';

  async function loadTeam(){
    if(!isAdmin) return;
    try{ const t=await getTeamMembers(); setTeamMembers(t); }
    catch(e){}
  }
  useEffect(()=>{ if(isAdmin) loadTeam(); },[isAdmin]);

  // ── Global search ──
  const globalResults = globalSearch.length>=2 ? [
    ...members.filter(m=>(m.name||'').toLowerCase().includes(globalSearch.toLowerCase())||(m.email||'').toLowerCase().includes(globalSearch.toLowerCase())).map(m=>({type:'member',label:m.name,sub:m.email,action:()=>{setTab('members');setShowGlobalSearch(false);setSelectedMember(m);}})),
    ...books.filter(b=>(b.title||'').toLowerCase().includes(globalSearch.toLowerCase())||(b.author||'').toLowerCase().includes(globalSearch.toLowerCase())||(b.isbn||'').includes(globalSearch)||(b.barcode||'').includes(globalSearch)).map(b=>({type:'book',label:b.title,sub:b.author,action:()=>{setTab('books');setShowGlobalSearch(false);setSelectedBook(b);}})),
    ...loans.filter(l=>{const m=members.find(x=>x.id===l.memberId),b=books.find(x=>x.id===l.bookId);return(m?.name||'').toLowerCase().includes(globalSearch.toLowerCase())||(b?.title||'').toLowerCase().includes(globalSearch.toLowerCase());}).map(l=>{const m=members.find(x=>x.id===l.memberId),b=books.find(x=>x.id===l.bookId);return({type:'loan',label:b?.title||'?',sub:m?.name+' — en cours',action:()=>{setTab('loans');setShowGlobalSearch(false);}});})
  ].slice(0,12) : [];

  // ── Computed ──
  const fMembers=members.filter(m=>(m.name||'').toLowerCase().includes(search.toLowerCase())||(m.email||'').toLowerCase().includes(search.toLowerCase())||(m.memberCode||'').toLowerCase().includes(search.toLowerCase()));
  const fBooks=books.filter(b=>{
    const ms=(b.title||'').toLowerCase().includes(search.toLowerCase())||(b.author||'').toLowerCase().includes(search.toLowerCase())||(b.isbn||'').toLowerCase().includes(search.toLowerCase())||(b.barcode||'').toLowerCase().includes(search.toLowerCase());
    return ms&&(catF==='all'||b.category===catF);
  });
  const cStats=CATS.reduce((a,c)=>({...a,[c]:books.filter(b=>b.category===c).length}),{});
  const overdue=loans.filter(l=>new Date(l.dueDate)<new Date());
  const fHistory=[...history].reverse().filter(loan=>{
    if(!histSearch) return true;
    const mb=members.find(m=>m.id===loan.memberId);
    const bk=books.find(b=>b.id===loan.bookId);
    const q=histSearch.toLowerCase();
    return (mb?.name||'').toLowerCase().includes(q)||(bk?.title||'').toLowerCase().includes(q);
  });
  // Top borrowed books
  const bookBorrowCounts=books.map(b=>({...b,count:history.filter(l=>l.bookId===b.id).length})).sort((a,b)=>b.count-a.count).slice(0,5);
  const paidFines=history.filter(l=>l.daysLate>0&&l.finePaid);
  const totalFinesAmount=history.filter(l=>l.daysLate>0).reduce((s,l)=>s+(l.lateFee||0),0);
  const totalFinesPaid=paidFines.reduce((s,l)=>s+(l.lateFee||0),0);
  // Member loan stats
  const memberLoanCounts=members.map(m=>({...m,active:loans.filter(l=>l.memberId===m.id).length,total:history.filter(l=>l.memberId===m.id).length}));
  const maxLoans=cfg.maxLoansPerMember||0;
  const memberAtLimit=(mId)=>maxLoans>0&&loans.filter(l=>l.memberId===mId).length>=maxLoans;
  // New books this week
  const oneWeekAgo=new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate()-7);
  const isNewBook=(b)=>b.addedDate&&new Date(b.addedDate)>oneWeekAgo;

  if(!authReady) return null;
  if(!session) return <Login onLogin={handleLogin}/>;

  if(loading) return(
    <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100vh',gap:16,background:'var(--bg)'}}>
      <Icon name="library" size={40} color="var(--accent)"/>
      <div style={{display:'flex',alignItems:'center',gap:10,color:'var(--text3)',fontSize:'.88em'}}>
        <span className="spinner"/>Chargement…
      </div>
    </div>
  );

  const userEmail=session?.user?.email||'';
  const THEMES=[
    {id:'light',label:'Clair',bg:'#f7f8fa',accent:'#2563eb'},
    {id:'blue',label:'Bleu',bg:'#0f1d35',accent:'#60a5fa'},
    {id:'green',label:'Vert',bg:'#f0faf4',accent:'#16a34a'},
    {id:'dark',label:'Sombre',bg:'#0d0f14',accent:'#c9a84c'},
  ];

  return(
  <div className="shell">
    <Toasts list={toasts}/>

    {/* ── SIDEBAR ── */}
    <aside className="sidebar">
      <div className="sb-head">
        <div className="sb-logo-row">
          {cfg.libraryLogo
            ?<img src={cfg.libraryLogo} className="sb-logo" style={{display:'block'}} alt=""/>
            :<div className="sb-logo"><Icon name="library" size={18} color="var(--sb-accent)"/></div>
          }
          <div>
            <div className="sb-libname">{cfg.libraryName}</div>
            <div className="sb-status">
              <span className={`sb-status-dot${USE_SB?'':' off'}`}/>
              {USE_SB?'Supabase':'Local'}
            </div>
          </div>
        </div>
      </div>

      <nav className="sb-nav">
        <div className="sb-sec">Navigation</div>
        {[
          {k:'dashboard',i:'home',l:'Tableau de bord'},
          {k:'scanner',i:'scan',l:'Scanner'},
        ].map(item=>(
          <button key={item.k} className={`nbtn${tab===item.k?' active':''}`} onClick={()=>{setTab(item.k);setSearch('');setCatF('all');}}>
            <span className="ni"><Icon name={item.i} size={15}/></span>
            <span className="nl">{item.l}</span>
          </button>
        ))}
        <div className="sb-sec">Gestion</div>
        {[
          {k:'members',i:'users',l:'Membres',n:members.length},
          {k:'books',i:'book',l:'Livres',n:books.length},
          {k:'loans',i:'book-open',l:'Prêts actifs',n:loans.length},
          {k:'history',i:'history',l:'Historique',n:history.length},
          {k:'reservations',i:'book-marked',l:'Réservations',n:reservations.length},
          {k:'fines',i:'alert',l:'Amendes',n:history.filter(l=>l.daysLate>0&&!l.finePaid&&l.returnDate).length},
        ].map(item=>(
          <button key={item.k} className={`nbtn${tab===item.k?' active':''}`} onClick={()=>{setTab(item.k);setSearch('');setCatF('all');}}>
            <span className="ni"><Icon name={item.i} size={15}/></span>
            <span className="nl">{item.l}</span>
            <span className="nbadge">{item.n}</span>
          </button>
        ))}
        {isAdmin&&(
          <>
            <div className="sb-sec">Administration</div>
            <button className={`nbtn${tab==='team'?' active':''}`} onClick={()=>setTab('team')}>
              <span className="ni"><Icon name="users" size={15}/></span>
              <span className="nl">Équipe &amp; Accès</span>
              <span className="nbadge">{teamMembers.length}</span>
            </button>
          </>
        )}
      </nav>

      <div className="sb-foot">
        <div className="sb-foot-row">
          <button className="sfbtn" onClick={exportCSV}><Icon name="bar-chart" size={12}/>CSV</button>
          <button className="sfbtn" onClick={exportJSON}><Icon name="save" size={12}/>Backup</button>
          <input type="file" accept=".json" ref={importRef} style={{display:'none'}} onChange={importJSON}/>
          <button className="sfbtn" onClick={()=>importRef.current.click()}><Icon name="upload" size={12}/>Import</button>
        </div>
        <button className="sfbtn" onClick={printMonthlyReport} style={{width:'100%',background:'var(--accent-t)',color:'var(--sb-accent)',borderColor:'rgba(255,255,255,.1)'}}><Icon name="bar-chart" size={12}/>Rapport mensuel</button>
        <button className="sfbtn" onClick={()=>setModal('settings')} style={{width:'100%'}}><Icon name="settings" size={12}/>Paramètres</button>
        <button className="sfbtn zotero" onClick={()=>{setZp([]);setZst('');setModal('zotero');}} style={{width:'100%'}}><Icon name="download" size={12}/>Importer Zotero</button>
        <div className="sb-user">
          <span>{userEmail}</span>
          <span style={{marginLeft:6,padding:'1px 7px',borderRadius:20,fontSize:'.65em',fontWeight:700,background:'var(--accent-t)',color:'var(--sb-accent)',textTransform:'uppercase',letterSpacing:'.04em'}}>{ROLES[userRole]||userRole}</span>
        </div>
        <button className="sfbtn" onClick={()=>setShowGlobalSearch(s=>!s)} style={{width:'100%'}} title="Raccourci: /"><Icon name="search" size={12}/>Recherche globale</button>
        <button className="sfbtn logout" onClick={handleLogout} style={{width:'100%'}}><Icon name="log-out" size={12}/>Déconnexion</button>
      </div>
    </aside>

    {/* ── MAIN ── */}
    <main className="main">

      {/* DASHBOARD */}
      {tab==='fines'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Gestion des amendes</h1>
            <div style={{display:'flex',gap:8,flexWrap:'wrap',alignItems:'center'}}>
              <span className="b br">{history.filter(l=>l.daysLate>0&&!l.finePaid&&l.returnDate).length} impayée(s)</span>
              <span className="b bg">{paidFines.length} payée(s)</span>
              <span className="b ba">{totalFinesPaid} / {totalFinesAmount} HTG</span>
            </div>
          </div>
          <div className="stats au2" style={{marginBottom:20}}>
            <div className="sc c-red"><div className="sn">{history.filter(l=>l.daysLate>0&&!l.finePaid&&l.returnDate).length}</div><div className="sl">Amendes impayées</div></div>
            <div className="sc c-green"><div className="sn">{paidFines.length}</div><div className="sl">Amendes payées</div></div>
            <div className="sc c-orange"><div className="sn">{loans.filter(l=>new Date(l.dueDate)<new Date()).length}</div><div className="sl">Prêts en retard</div></div>
            <div className="sc c-accent"><div className="sn">{totalFinesPaid} HTG</div><div className="sl">Total encaissé</div></div>
          </div>
          {history.filter(l=>l.daysLate>0).length===0
            ?<div className="empty au3"><div className="empty-i"><Icon name="check" size={48}/></div><div>Aucune amende enregistrée</div></div>
            :<div className="grid au3">
              {[...history].filter(l=>l.daysLate>0).sort((a,b)=>(a.finePaid?1:0)-(b.finePaid?1:0)||b.daysLate-a.daysLate).map(loan=>{
                const mb=members.find(m=>m.id===loan.memberId),bk=books.find(b=>b.id===loan.bookId);
                return(<div key={loan.id} className={`card${!loan.finePaid&&loan.returnDate?' late':''}`}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:12}}>
                    <div style={{flex:1}}>
                      <div className="ct" style={{fontSize:'.97em'}}>{bk?.title||'?'}</div>
                      <div className="cs">{mb?.name||'?'} — {mb?.email}</div>
                      <div style={{display:'flex',gap:6,marginTop:6,flexWrap:'wrap',alignItems:'center'}}>
                        <span className="b br">{loan.daysLate}j retard</span>
                        <span style={{fontWeight:700,color:'var(--red)',fontSize:'.88em'}}>{loan.lateFee} HTG</span>
                        {loan.finePaid&&<span className="b bg">Payé {loan.finePaidDate?'le '+new Date(loan.finePaidDate).toLocaleDateString('fr-FR'):''}</span>}
                        {!loan.returnDate&&<span className="b bo">Livre non encore retourné</span>}
                      </div>
                    </div>
                    {!loan.finePaid&&loan.returnDate&&<button className="btn btn-success btn-sm" onClick={()=>payFine(loan.id)}><Icon name="check" size={12}/>Marquer payé</button>}
                  </div>
                </div>);
              })}
            </div>}
        </div>
      )}

      {tab==='team'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Équipe &amp; Accès</h1>
            <button className="btn btn-primary btn-sm" onClick={()=>setModal('invite')}><Icon name="plus" size={13}/>Inviter un utilisateur</button>
          </div>
          <div className="al al-i au2" style={{flexDirection:'column',alignItems:'start',gap:6}}>
            <div style={{fontWeight:700,fontSize:'.88em'}}>Gestion des accès</div>
            <div style={{fontSize:'.82em',lineHeight:1.7,color:'var(--text2)'}}>
              En tant qu'administrateur, vous contrôlez qui peut accéder à cette application.<br/>
              <strong>Administrateur</strong> : accès complet, gestion des utilisateurs, suppression de données.<br/>
              <strong>Bibliothécaire</strong> : peut ajouter, modifier, créer des prêts — ne peut pas supprimer ni gérer les accès.<br/>
              <strong>Lecture seule</strong> : consulte uniquement sans pouvoir modifier.
            </div>
          </div>
          <div style={{marginTop:16}} className="au3">
            <div className="card" style={{marginBottom:12}}>
              <div style={{display:'flex',alignItems:'center',gap:12}}>
                <div className="av"><Icon name="user" size={22}/></div>
                <div style={{flex:1}}>
                  <div className="ct" style={{fontSize:'.98em'}}>{session?.user?.email}</div>
                  <div className="cs">Votre compte</div>
                </div>
                <span className="b ba">Administrateur</span>
              </div>
            </div>
            {teamMembers.length===0&&<div className="empty" style={{padding:'32px 20px'}}><div className="empty-i" style={{marginBottom:8}}><Icon name="users" size={36}/></div><div>Aucun membre d'équipe pour l'instant</div><div style={{fontSize:'.8em',marginTop:6}}>Invitez des bibliothécaires pour collaborer</div></div>}
            <div className="grid">
              {teamMembers.filter(t=>t.user_id!==session?.user?.id).map(t=>(
                <div key={t.user_id} className="card">
                  <div style={{display:'flex',alignItems:'center',gap:12}}>
                    <div className="av"><Icon name="user" size={20}/></div>
                    <div style={{flex:1}}>
                      <div className="ct" style={{fontSize:'.95em'}}>{t.email||t.user_id}</div>
                      <div className="cs">Ajouté le {t.created_at?new Date(t.created_at).toLocaleDateString('fr-FR'):'-'}</div>
                    </div>
                    <select className="fsel" value={t.role} onChange={async e=>{
                      try{ await setUserRole(t.user_id,e.target.value); toast('Rôle mis à jour'); loadTeam(); }
                      catch(err){ toast(err.message,'err'); }
                    }} style={{fontSize:'.8em',padding:'5px 9px'}}>
                      <option value="admin">Administrateur</option>
                      <option value="librarian">Bibliothécaire</option>
                      <option value="readonly">Lecture seule</option>
                    </select>
                    <button className="btn btn-ghost btn-sm" style={{color:'var(--red)'}} onClick={async()=>{
                      if(!confirm('Révoquer cet accès ?')) return;
                      try{ await removeUserRole(t.user_id); toast('Accès révoqué'); loadTeam(); }
                      catch(err){ toast(err.message,'err'); }
                    }}><Icon name="trash" size={12}/></button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {tab==='dashboard'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Tableau de bord</h1>
            <div style={{display:'flex',gap:8,flexWrap:'wrap',alignItems:'center'}}>
              <div style={{display:'flex',gap:4}}>
              {overdue.length>0&&(
                <button className="btn btn-email btn-sm" onClick={sendLateEmails} disabled={emailSending}>
                  {emailSending?<span className="spinner"/>:<Icon name="mail" size={13}/>}
                  Notifier retards ({overdue.length})
                </button>
              )}
              <button className="btn btn-secondary btn-sm" onClick={reload}><Icon name="refresh" size={13}/>Actualiser</button>
            </div>
          </div>
          {dashWidgets.includes('overdue')&&overdue.length>0&&<div className="al al-w au2"><Icon name="alert" size={14}/><strong>{overdue.length} prêt(s) en retard</strong></div>}
          {dashWidgets.includes('stats')&&<div className="stats au2">
            <div className="sc c-blue"><div className="sn">{members.length}</div><div className="sl">Membres</div></div>
            <div className="sc c-accent"><div className="sn">{books.length}</div><div className="sl">Livres</div></div>
            <div className="sc c-purple"><div className="sn">{loans.length}</div><div className="sl">Prêts actifs</div></div>
            <div className="sc c-green"><div className="sn">{books.reduce((s,b)=>s+(b.available||0),0)}</div><div className="sl">Disponibles</div></div>
            <div className="sc c-red"><div className="sn">{overdue.length}</div><div className="sl">En retard</div></div>
            <div className="sc c-orange"><div className="sn">{history.length}</div><div className="sl">Total prêts</div></div>
          </div>}
          <h2 style={{fontFamily:"'Fraunces',serif",fontSize:'1.15em',fontWeight:400,marginBottom:12,color:'var(--text2)'}} className="au3">Par catégorie</h2>
          <div className="cg au3">
            {CATS.map(c=><div key={c} className="cc" onClick={()=>{setTab('books');setCatF(c);}}>
              <div className="cn">{cStats[c]||0}</div><div className="cl">{c}</div>
            </div>)}
          </div>
          {overdue.length>0&&<>
            <h2 style={{fontFamily:"'Fraunces',serif",fontSize:'1.15em',fontWeight:400,marginBottom:12,color:'var(--red)'}} className="au4">Prêts en retard</h2>
            <div className="grid au4">
              {overdue.map(loan=>{
                const mb=members.find(m=>m.id===loan.memberId),bk=books.find(b=>b.id===loan.bookId);
                const dl=Math.ceil((new Date()-new Date(loan.dueDate))/86400000);
                return(<div key={loan.id} className="card late">
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:12}}>
                    <div>
                      <div className="ct">{bk?.title||'?'}</div>
                      <div className="cs">{mb?.name} — {mb?.email}</div>
                      <div style={{color:'var(--red)',fontWeight:700,marginTop:5,fontSize:'.84em'}}>{dl}j de retard — {dl*(cfg.feePerDay||10)} HTG</div>
                    </div>
                    <button className="btn btn-success btn-sm" onClick={()=>returnLoan(loan.id)}><Icon name="check" size={13}/>Retourner</button>
                  </div>
                </div>);
              })}
            </div>
          </>}
          {bookBorrowCounts.some(b=>b.count>0)&&(
            <div className="au4">
              <h2 style={{fontFamily:"'Fraunces',serif",fontSize:'1.15em',fontWeight:400,marginBottom:12,color:'var(--text2)',marginTop:20}}>Livres les plus empruntés</h2>
              <div className="grid">
                {bookBorrowCounts.filter(b=>b.count>0).map((bk,i)=>(
                  <div key={bk.id} className="card" style={{padding:'14px 18px'}}>
                    <div style={{display:'flex',alignItems:'center',gap:12}}>
                      <div style={{width:28,height:28,borderRadius:'50%',background:'var(--accent-t)',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0,fontFamily:"'Fraunces',serif",fontWeight:700,fontSize:'1em',color:'var(--accent)'}}>{i+1}</div>
                      <div style={{flex:1}}>
                        <div className="ct" style={{fontSize:'.95em'}}>{bk.title}</div>
                        <div className="cs">{bk.author}</div>
                      </div>
                      <span className="b ba">{bk.count} prêt{bk.count>1?'s':''}</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {/* SCANNER */}
      {tab==='scanner'&&(
        <div>
          <div className="ph au"><h1 className="pt">Scanner USB</h1></div>
          <div className="scan-box au2">
            <div style={{display:'flex',alignItems:'center',gap:9,marginBottom:8}}>
              <Icon name="scan" size={18} color="var(--accent)"/>
              <h2 style={{fontSize:'1.05em',fontWeight:700,color:'var(--text)'}}>Zone de scan</h2>
            </div>
            <p style={{color:'var(--text3)',marginBottom:13,fontSize:'.84em'}}>Scannez la carte membre puis le livre pour créer un prêt</p>
            <input ref={scanRef} type="text" className="scan-in" value={scanVal} onChange={e=>setScanVal(e.target.value)} onKeyPress={handleScan} placeholder="Pointez votre scanner ici…" autoFocus/>
            {scanSt&&<div className="scan-st">{scanSt}</div>}
          </div>
          {scanItem&&<div className="al al-s au">
            <Icon name={scanItem.type==='member'?'user':'book'} size={14}/>
            <strong>{scanItem.type==='member'?scanItem.data.name:scanItem.data.title}</strong>
            — {scanItem.type==='member'?'Scannez maintenant un livre':'Scannez la carte membre'}
            <button className="btn btn-secondary btn-sm" style={{marginLeft:'auto'}} onClick={()=>setScanItem(null)}>Annuler</button>
          </div>}
          <div className="card au3">
            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:13}}>
              <Icon name="pencil" size={14} color="var(--text3)"/>
              <h3 style={{fontWeight:700,fontSize:'.86em',color:'var(--text2)',textTransform:'uppercase',letterSpacing:'.05em'}}>Prêt manuel</h3>
            </div>
            <div style={{display:'flex',gap:9,flexWrap:'wrap',alignItems:'center'}}>
              <select className="fsel" id="man-m" style={{flex:1}}>
                <option value="">Sélectionner un membre</option>
                {members.map(m=><option key={m.id} value={m.id}>{m.name} ({m.memberCode})</option>)}
              </select>
              <select className="fsel" id="man-b" style={{flex:1}}>
                <option value="">Sélectionner un livre disponible</option>
                {books.filter(b=>b.available>0).map(b=><option key={b.id} value={b.id}>{b.title} ({b.available} dispo)</option>)}
              </select>
              <button className="btn btn-primary" onClick={()=>{
                const mId=parseInt(document.getElementById('man-m').value);
                const bId=parseInt(document.getElementById('man-b').value);
                if(!mId||!bId){toast('Sélectionnez un membre et un livre','err');return;}
                createLoan(bId,mId);
              }}><Icon name="plus" size={14}/>Créer le prêt</button>
            </div>
          </div>
        </div>
      )}

      {/* MEMBERS */}
      {tab==='members'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Membres</h1>
            {canEdit&&<button className="btn btn-primary" onClick={()=>{setMf({name:'',email:'',phone:'',address:'',dateOfBirth:'',idNumber:'',photo:''});setEditM(null);setModal('member');}}><Icon name="plus" size={14}/>Nouveau membre</button>}
          </div>
          <div className="sw au2"><span className="sw-icon"><Icon name="search" size={14}/></span><input type="text" className="sbar" placeholder="Rechercher nom, email, code…" value={search} onChange={e=>setSearch(e.target.value)}/></div>
          {fMembers.length===0?<div className="empty au3"><div className="empty-i"><Icon name="users" size={48}/></div><div>Aucun membre</div></div>:
          <div className="grid au3">
            {fMembers.map(m=>{
              const ml=loans.filter(l=>l.memberId===m.id);
              return(<div key={m.id} className="card">
                <div style={{display:'flex',justifyContent:'space-between',gap:14}}>
                  <div style={{display:'flex',gap:12,alignItems:'center',flex:1}}>
                    {m.photo?<img src={m.photo} className="av" style={{display:'block'}} alt=""/>:<div className="av"><Icon name="user" size={22}/></div>}
                    <div style={{flex:1}}>
                      <div className="ct">{m.name}</div>
                      <div className="cs">{m.email}</div>
                      {m.phone&&<div className="cs">{m.phone}</div>}
                      <div className="cm">
                        <span className="b ba">{m.memberCode}</span>
                        {ml.length>0&&<span className="b bb">{ml.length} prêt{ml.length>1?'s':''} actif{ml.length>1?'s':''}</span>}
                        {(()=>{const stats=memberLoanCounts.find(x=>x.id===m.id);return stats&&stats.total>0?<span className="b bk">{stats.total} total</span>:null;})()}
                      </div>
                    </div>
                  </div>
                  <img src={`https://api.qrserver.com/v1/create-qr-code/?size=82x82&data=${encodeURIComponent(m.memberCode)}&bgcolor=ffffff`} className="qr" alt="QR"/>
                </div>
                <div className="ca">
                  <button className="btn btn-secondary btn-sm" onClick={()=>setSelectedMember(m)}><Icon name="user" size={12}/>Fiche</button>
                  <button className="btn btn-primary btn-sm" onClick={()=>printCard(m)}><Icon name="printer" size={12}/>Carte</button>
                  {canEdit&&<button className="btn btn-secondary btn-sm" onClick={()=>openEditM(m)}><Icon name="pencil" size={12}/>Modifier</button>}
                  {canEdit&&<button className="btn btn-ghost btn-sm" style={{marginLeft:'auto',color:'var(--red)'}} onClick={()=>delMember(m.id)}><Icon name="trash" size={12}/></button>}
                </div>
              </div>);
            })}
          </div>}
        </div>
      )}

      {/* BOOKS */}
      {tab==='books'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Livres</h1>
            <div style={{display:'flex',gap:8,flexWrap:'wrap',alignItems:'center'}}>
              {selectMode&&selectedBooks.size>0&&<button className="btn btn-danger btn-sm" onClick={deleteBulkBooks}><Icon name="trash" size={13}/>Supprimer ({selectedBooks.size})</button>}
              {selectMode&&<button className="btn btn-secondary btn-sm" onClick={()=>{setSelectMode(false);setSelectedBooks(new Set());}}><Icon name="x" size={13}/>Annuler</button>}
              {canEdit&&!selectMode&&<button className="btn btn-secondary btn-sm" onClick={()=>setSelectMode(true)}><Icon name="check" size={13}/>Sélectionner</button>}
              <button className="btn btn-secondary btn-sm" onClick={()=>{setZp([]);setZst('');setModal('zotero');}}><Icon name="download" size={13}/>Zotero</button>
              {canEdit&&<button className="btn btn-primary" onClick={()=>{setBf({title:'',author:'',isbn:'',year:'',category:'Fiction',publisher:'',shelf:'',copies:1,description:''});setEditB(null);setModal('book');}}><Icon name="plus" size={14}/>Nouveau livre</button>}
            </div>
          </div>
          <div className="fbar au2">
            <div className="sw" style={{flex:1,marginBottom:0}}>
              <span className="sw-icon"><Icon name="search" size={14}/></span>
              <input type="text" className="sbar" style={{marginBottom:0}} placeholder="Titre, auteur, ISBN, code-barres…" value={search} onChange={e=>setSearch(e.target.value)}/>
            </div>
            <select className="fsel" value={catF} onChange={e=>setCatF(e.target.value)}>
              <option value="all">Toutes catégories</option>
              {CATS.map(c=><option key={c} value={c}>{c} ({cStats[c]||0})</option>)}
            </select>
          </div>
          {fBooks.length===0?<div className="empty au3"><div className="empty-i"><Icon name="book" size={48}/></div><div>Aucun livre</div></div>:
          <div className="grid au3">
            {fBooks.map(bk=>(
              <div key={bk.id} className={`card${selectedBooks.has(bk.id)?' selected-card':''}`} style={{position:'relative',cursor:selectMode?'pointer':'default'}} onClick={selectMode?()=>setSelectedBooks(prev=>{const n=new Set(prev);n.has(bk.id)?n.delete(bk.id):n.add(bk.id);return n;}):undefined}>
                {selectMode&&<div style={{position:'absolute',top:8,left:8,zIndex:2}}><input type="checkbox" readOnly checked={selectedBooks.has(bk.id)} style={{width:16,height:16,accentColor:'var(--accent)'}}/></div>}
                <div style={{display:'flex',justifyContent:'space-between',gap:14}}>
                  <div style={{flex:1}}>
                    <div className="ct">{bk.title}</div>
                    <div className="cs">{bk.author}{bk.year?` · ${bk.year}`:''}</div>
                    {bk.isbn&&<div className="cs" style={{fontSize:'.78em'}}>ISBN: {bk.isbn}</div>}
                    <div className="cm">
                      {bk.category&&<span className="b bb">{bk.category}</span>}
                      {bk.shelf&&<span className="b bo">{bk.shelf}</span>}
                      <span className={`b ${bk.available>0?'bg':bk.status==='lost'?'br':'br'}`}>{bk.available}/{bk.copies} dispo{bk.status==='lost'?' 🔴 perdu':bk.status==='damaged'?' 🟡 abîmé':''}</span>
                      <span className="b bk">{bk.barcode}</span>
                    </div>
                    {bk.description&&<div style={{fontSize:'.8em',color:'var(--text3)',marginTop:7,lineHeight:1.5}}>{bk.description.substring(0,110)}{bk.description.length>110?'…':''}</div>}
                  </div>
                  <img src={`https://api.qrserver.com/v1/create-qr-code/?size=82x82&data=${encodeURIComponent(bk.barcode)}&bgcolor=ffffff`} className="qr" alt="QR"/>
                </div>
                <div className="ca">
                  {bk.available>0&&members.length>0&&(
                    <select className="fsel" style={{flex:1}} onChange={e=>{if(e.target.value){if(memberAtLimit(e.target.value)){if(!confirm(`Ce membre a atteint la limite de ${maxLoans} prêts. Continuer quand même ?`)){e.target.value='';return;}}createLoan(bk.id,e.target.value);e.target.value=''}}}>
                      <option value="">Prêter à…</option>
                      {members.map(m=><option key={m.id} value={m.id}>{m.name}{memberAtLimit(m.id)?' ⚠️ limite':''}</option>)}
                    </select>
                  )}
              {bk.available===0&&members.length>0&&(
                <select className="fsel" style={{flex:1,opacity:.85}} onChange={e=>{if(e.target.value){reserveBook(bk.id,e.target.value);e.target.value=''}}}>
                  <option value="">Réserver pour…</option>
                  {members.map(m=><option key={m.id} value={m.id}>{m.name}</option>)}
                </select>
              )}
                  <button className="btn btn-ghost btn-sm" onClick={()=>printBookBarcode(bk)} title="Imprimer étiquette"><Icon name="printer" size={12}/></button>
                  <button className="btn btn-ghost btn-sm" onClick={()=>setSelectedBook(bk)}><Icon name="book-open" size={12}/>Fiche</button>
                  {canEdit&&<button className="btn btn-secondary btn-sm" onClick={()=>openEditB(bk)}><Icon name="pencil" size={12}/></button>}
                  {canEdit&&<button className="btn btn-ghost btn-sm" title="Dupliquer" onClick={()=>duplicateBook(bk)}><Icon name="copy" size={12}/></button>}
                  {canEdit&&<button className="btn btn-ghost btn-sm" style={{color:'var(--red)'}} onClick={()=>delBook(bk.id)}><Icon name="trash" size={12}/></button>}
                </div>
              </div>
            ))}
          </div>}
        </div>
      )}

      {/* LOANS */}
      {tab==='loans'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Prêts actifs</h1>
            {overdue.length>0&&<span className="b br">{overdue.length} en retard</span>}
          </div>
          {loans.length===0?<div className="empty au2"><div className="empty-i"><Icon name="book-open" size={48}/></div><div>Aucun prêt actif</div></div>:
          <div className="grid au2">
            {loans.map(loan=>{
              const mb=members.find(m=>m.id===loan.memberId),bk=books.find(b=>b.id===loan.bookId);
              const dud=Math.ceil((new Date(loan.dueDate)-new Date())/86400000);
              const late=dud<0;
              return(<div key={loan.id} className={`card${late?' late':''}`}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'start',gap:12}}>
                  <div style={{flex:1}}>
                    <div className="ct">{bk?.title||'?'}</div>
                    <div className="cs">{mb?.name||'?'} — {mb?.email}</div>
                    <div className="cs">Prêt le {new Date(loan.loanDate).toLocaleDateString('fr-FR')}</div>
                    <div style={{marginTop:6,fontWeight:700,fontSize:'.84em',color:late?'var(--red)':'var(--green)'}}>
                      {late?`${Math.abs(dud)}j retard — ${Math.abs(dud)*(cfg.feePerDay||10)} HTG`:`Retour: ${new Date(loan.dueDate).toLocaleDateString('fr-FR')} (${dud}j)`}
                    </div>
                  </div>
                  <div style={{display:'flex',flexDirection:'column',gap:5,flexShrink:0}}>
                    <button className="btn btn-success btn-sm" onClick={()=>returnLoan(loan.id)}><Icon name="check" size={12}/>Retourner</button>
                    <button className="btn btn-secondary btn-sm" onClick={()=>setRenewLoanId(loan.id)}><Icon name="refresh" size={12}/>Renouveler</button>
                    <button className="btn btn-ghost btn-sm" onClick={()=>sendReminderEmail(loan)} title="Envoyer rappel"><Icon name="mail" size={12}/></button>
                    <button className="btn btn-ghost btn-sm" onClick={()=>setNoteModal(loan)} title="Ajouter note"><Icon name="pencil" size={12}/>{loan.note&&<span style={{width:6,height:6,borderRadius:'50%',background:'var(--accent)',display:'inline-block',marginLeft:3}}/>}</button>
                  </div>
                </div>
              </div>);
            })}
          </div>}
        </div>
      )}

      {/* HISTORY */}
      {tab==='reservations'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Réservations</h1>
            <span className="b ba">{reservations.length} en attente</span>
          </div>
          {reservations.length===0
            ?<div className="empty au2"><div className="empty-i"><Icon name="book-marked" size={48}/></div><div>Aucune réservation</div><div style={{fontSize:'.8em',marginTop:6}}>Utilisez le bouton "Réserver pour…" sur un livre indisponible</div></div>
            :<div className="grid au2">
              {reservations.map(res=>{
                const mb=members.find(m=>m.id===res.memberId),bk=books.find(b=>b.id===res.bookId);
                return(<div key={res.id} className="card">
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:12}}>
                    <div style={{flex:1}}>
                      <div className="ct">{bk?.title||'?'}</div>
                      <div className="cs">{mb?.name||'?'} — {mb?.email}</div>
                      <div className="cs">Réservé le {new Date(res.createdAt).toLocaleDateString('fr-FR')}</div>
                      <div className="cm"><span className={`b ${bk?.available>0?'bg':'br'}`}>{bk?.available>0?'Disponible maintenant !':'Indisponible'}</span></div>
                    </div>
                    <div style={{display:'flex',flexDirection:'column',gap:5}}>
                      {bk?.available>0&&mb&&<button className="btn btn-primary btn-sm" onClick={async()=>{await createLoan(bk.id,mb.id);cancelReservation(res.id);}}><Icon name="check" size={12}/>Prêter</button>}
                      <button className="btn btn-danger btn-sm" onClick={()=>cancelReservation(res.id)}><Icon name="x" size={12}/>Annuler</button>
                    </div>
                  </div>
                </div>);
              })}
            </div>}
          <div className="card au3" style={{marginTop:16}}>
            <div style={{fontWeight:700,fontSize:'.82em',color:'var(--text2)',textTransform:'uppercase',letterSpacing:'.05em',marginBottom:12}}>Nouvelle réservation manuelle</div>
            <div style={{display:'flex',gap:9,flexWrap:'wrap',alignItems:'center'}}>
              <select className="fsel" id="res-m" style={{flex:1}}><option value="">Sélectionner un membre</option>{members.map(m=><option key={m.id} value={m.id}>{m.name}</option>)}</select>
              <select className="fsel" id="res-b" style={{flex:1}}><option value="">Sélectionner un livre</option>{books.map(b=><option key={b.id} value={b.id}>{b.title} ({b.available} dispo)</option>)}</select>
              <button className="btn btn-primary" onClick={()=>{const mId=document.getElementById('res-m').value,bId=document.getElementById('res-b').value;if(!mId||!bId){toast('Sélectionnez membre et livre','err');return;}reserveBook(bId,mId);}}><Icon name="plus" size={14}/>Réserver</button>
            </div>
          </div>
        </div>
      )}

      {tab==='history'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Historique</h1>
            <div style={{display:'flex',gap:8}}>
              <span style={{alignSelf:'center',fontSize:'.82em',color:'var(--text3)'}}>{history.length} prêt{history.length!==1?'s':''}</span>
              <button className="btn btn-secondary btn-sm" onClick={exportCSV}><Icon name="bar-chart" size={13}/>Export CSV</button>
            </div>
          </div>
          <div className="sw au2"><span className="sw-icon"><Icon name="search" size={14}/></span><input type="text" className="sbar" placeholder="Rechercher membre ou titre…" value={histSearch} onChange={e=>setHistSearch(e.target.value)}/></div>
          {fHistory.length===0?<div className="empty au2"><div className="empty-i"><Icon name="history" size={48}/></div><div>Aucun résultat</div></div>:
          <div className="grid au2">
            {fHistory.map(loan=>{
              const mb=members.find(m=>m.id===loan.memberId),bk=books.find(b=>b.id===loan.bookId);
              return(<div key={loan.id} className="card">
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:12}}>
                  <div>
                    <div className="ct" style={{fontSize:'.98em'}}>{bk?.title||'?'}</div>
                    <div className="cs">{mb?.name||'?'}</div>
                    <div className="cs">{new Date(loan.loanDate).toLocaleDateString('fr-FR')}{loan.returnDate?' → '+new Date(loan.returnDate).toLocaleDateString('fr-FR'):''}</div>
                    {loan.daysLate>0&&<div style={{fontSize:'.8em',color:'var(--red)',fontWeight:600,marginTop:3}}>{loan.daysLate}j retard — {loan.lateFee} HTG</div>}
                  </div>
                  <span className={`b ${loan.returnDate?'bg':'bb'}`}>{loan.returnDate?'Retourné':'En cours'}</span>
                </div>
              </div>);
            })}
          </div>}
        </div>
      )}

    </main>

    {/* ════ MODALS ════ */}

    {/* Settings */}
    {modal==='settings'&&(
      <div className="ov" onClick={close}>
        <div className="mc" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">Paramètres</h2><button className="xb" onClick={close}><Icon name="x" size={14}/></button></div>
          <div className="ss">
            <h3>Thème</h3>
            <div className="theme-swatches">
              {THEMES.map(t=>(
                <div key={t.id} className="theme-swatch" onClick={()=>setTheme(t.id)} style={{background:t.bg,border:`2px solid ${theme===t.id?t.accent:'transparent'}`,boxShadow:theme===t.id?`0 0 0 1px ${t.accent}40`:'none'}}>
                  <div style={{width:10,height:10,borderRadius:'50%',background:t.accent,flexShrink:0}}/>
                  <span style={{fontSize:'.8em',fontWeight:600,color:theme===t.id?t.accent:'#888'}}>{t.label}</span>
                </div>
              ))}
            </div>
          </div>
          <div className="ss">
            <h3>Bibliothèque</h3>
            <div className="fg"><label className="fl">Nom</label><input className="fi" value={cfg.libraryName} onChange={e=>setCfg({...cfg,libraryName:e.target.value})}/></div>
            <div className="fg"><label className="fl">Logo</label>
              <input ref={logoRef} type="file" accept="image/*" style={{display:'none'}} onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onloadend=()=>setCfg(s=>({...s,libraryLogo:r.result}));r.readAsDataURL(f);}}/>
              <button className="btn btn-secondary" style={{width:'100%'}} onClick={()=>logoRef.current.click()}><Icon name="camera" size={13}/>Choisir logo</button>
              {cfg.libraryLogo&&<img src={cfg.libraryLogo} style={{width:64,height:64,borderRadius:'50%',objectFit:'cover',marginTop:10,border:'2px solid var(--accent)'}} alt=""/>}
            </div>
          </div>
          <div className="ss">
            <h3>Règles de prêt</h3>
            <div className="fgrid">
              <div className="fg"><label className="fl">Max prêts/membre (0=illimité)</label><input className="fi" type="number" min="0" max="20" value={cfg.maxLoansPerMember||0} onChange={e=>setCfg(f=>({...f,maxLoansPerMember:parseInt(e.target.value)||0}))}/></div>
            </div>
            <div className="fgrid">
              <div className="fg"><label className="fl">Durée (jours)</label><input className="fi" type="number" min="1" value={cfg.loanDays||14} onChange={e=>setCfg({...cfg,loanDays:parseInt(e.target.value)})}/></div>
              <div className="fg"><label className="fl">Pénalité/jour (HTG)</label><input className="fi" type="number" min="0" value={cfg.feePerDay||10} onChange={e=>setCfg({...cfg,feePerDay:parseInt(e.target.value)})}/></div>
            </div>
          </div>
          <div className="ss">
            <h3>Données</h3>
            <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
              <button className="btn btn-secondary btn-sm" onClick={exportJSON}><Icon name="save" size={12}/>Sauvegarder</button>
              <button className="btn btn-secondary btn-sm" onClick={()=>importRef.current.click()}><Icon name="upload" size={12}/>Restaurer</button>
              <button className="btn btn-danger btn-sm" style={{marginLeft:'auto'}} onClick={()=>{if(confirm('Supprimer TOUTES les données localStorage ?')){['lib_members','lib_books','lib_loans'].forEach(k=>localStorage.removeItem(k));reload();close();toast('Données effacées','warn');}}}><Icon name="trash" size={12}/>Effacer</button>
            </div>
          </div>
          <div className="fac">
            <button className="btn btn-primary" style={{flex:1}} onClick={()=>saveCfg(cfg)}><Icon name="save" size={13}/>Sauvegarder</button>
            <button className="btn btn-secondary" onClick={close}>Annuler</button>
          </div>
        </div>
      </div>
    )}

    {/* Member form */}
    {modal==='member'&&(
      <div className="ov" onClick={close}>
        <div className="mc" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">{editM?'Modifier membre':'Nouveau membre'}</h2><button className="xb" onClick={close}><Icon name="x" size={14}/></button></div>
          <div className="fg"><label className="fl">Photo</label>
            <input ref={photoRef} type="file" accept="image/*" style={{display:'none'}} onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onloadend=()=>setMf(prev=>({...prev,photo:r.result}));r.readAsDataURL(f);}}/>
            <div className="pu" onClick={()=>photoRef.current.click()}>
              {mf.photo?<img src={mf.photo} className="pp" alt=""/>:<><Icon name="camera" size={24} color="var(--text3)"/><div style={{color:'var(--text3)',fontSize:'.82em',marginTop:6}}>Cliquez pour ajouter une photo</div></>}
            </div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">Nom complet *</label><input className="fi" value={mf.name} onChange={e=>setMf({...mf,name:e.target.value})} placeholder="Jean Dupont"/></div>
            <div className="fg"><label className="fl">Email *</label><input className="fi" type="email" value={mf.email} onChange={e=>setMf({...mf,email:e.target.value})} placeholder="jean@email.com"/></div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">Téléphone</label><input className="fi" type="tel" value={mf.phone} onChange={e=>setMf({...mf,phone:e.target.value})} placeholder="+509 1234 5678"/></div>
            <div className="fg"><label className="fl">N° identité</label><input className="fi" value={mf.idNumber} onChange={e=>setMf({...mf,idNumber:e.target.value})} placeholder="CIN/NIF"/></div>
          </div>
          <div className="fg"><label className="fl">Adresse</label><textarea className="ft" value={mf.address} onChange={e=>setMf({...mf,address:e.target.value})} placeholder="Adresse"/></div>
          <div className="fg"><label className="fl">Date de naissance</label><input className="fi" type="date" value={mf.dateOfBirth} onChange={e=>setMf({...mf,dateOfBirth:e.target.value})}/></div>
          <div className="fac">
            <button className="btn btn-primary" style={{flex:1}} onClick={saveMember}><Icon name="check" size={13}/>Enregistrer</button>
            <button className="btn btn-secondary" onClick={close}>Annuler</button>
          </div>
        </div>
      </div>
    )}

    {/* Book form */}
    {modal==='book'&&(
      <div className="ov" onClick={close}>
        <div className="mc" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">{editB?'Modifier livre':'Nouveau livre'}</h2><button className="xb" onClick={close}><Icon name="x" size={14}/></button></div>
          <div className="fg">
            <label className="fl">Recherche ISBN automatique</label>
            <div style={{display:'flex',gap:8}}>
              <input className="fi" placeholder="Ex: 9782070360024" value={bf.isbn||''} onChange={e=>setBf(f=>({...f,isbn:e.target.value}))} style={{flex:1}}/>
              <button className="btn btn-secondary" disabled={isbnLoading} onClick={async()=>{const r=await lookupISBN(bf.isbn);if(r) setBf(f=>({...f,...r}));}} style={{flexShrink:0}}>
                {isbnLoading?<span className="spinner"/>:<Icon name="search" size={13}/>}Remplir
              </button>
            </div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">Titre *</label><input className="fi" value={bf.title} onChange={e=>setBf({...bf,title:e.target.value})} placeholder="Titre"/></div>
            <div className="fg"><label className="fl">Auteur *</label><input className="fi" value={bf.author} onChange={e=>setBf({...bf,author:e.target.value})} placeholder="Auteur"/></div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">ISBN</label><input className="fi" value={bf.isbn} onChange={e=>setBf({...bf,isbn:e.target.value})} placeholder="978-XXXXXXXXXX"/></div>
            <div className="fg"><label className="fl">Année</label><input className="fi" value={bf.year} onChange={e=>setBf({...bf,year:e.target.value})} placeholder="2024"/></div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">Catégorie</label>
              <select className="fsel fi" value={bf.category} onChange={e=>setBf({...bf,category:e.target.value})}>
                {CATS.map(c=><option key={c} value={c}>{c}</option>)}
              </select>
            </div>
            <div className="fg"><label className="fl">Cote</label><input className="fi" value={bf.shelf} onChange={e=>setBf({...bf,shelf:e.target.value})} placeholder="A-12"/></div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">Éditeur</label><input className="fi" value={bf.publisher} onChange={e=>setBf({...bf,publisher:e.target.value})} placeholder="Éditeur"/></div>
            <div className="fg"><label className="fl">Exemplaires</label><input className="fi" type="number" min="1" value={bf.copies} onChange={e=>setBf({...bf,copies:e.target.value})}/></div>
          </div>
          <div className="fg"><label className="fl">Description</label><textarea className="ft" value={bf.description} onChange={e=>setBf({...bf,description:e.target.value})} placeholder="Résumé…"/></div>
          <div className="fac">
            <button className="btn btn-primary" style={{flex:1}} onClick={saveBook}><Icon name="check" size={13}/>Enregistrer</button>
            <button className="btn btn-secondary" onClick={close}>Annuler</button>
          </div>
        </div>
      </div>
    )}

    {/* Member detail */}
    {selectedMember&&(
      <div className="ov" onClick={()=>setSelectedMember(null)}>
        <div className="mc wide" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">Fiche membre</h2><button className="xb" onClick={()=>setSelectedMember(null)}><Icon name="x" size={14}/></button></div>
          <div style={{display:'flex',gap:18,alignItems:'start',marginBottom:20,flexWrap:'wrap'}}>
            {selectedMember.photo?<img src={selectedMember.photo} style={{width:72,height:72,borderRadius:'50%',objectFit:'cover',border:'3px solid var(--accent)',flexShrink:0}} alt=""/>:<div className="av" style={{width:72,height:72}}><Icon name="user" size={32}/></div>}
            <div style={{flex:1}}>
              <div style={{fontSize:'1.35em',fontWeight:700,color:'var(--text)',fontFamily:"'Fraunces',serif"}}>{selectedMember.name}</div>
              <div style={{color:'var(--text2)',marginTop:3}}>{selectedMember.email}</div>
              {selectedMember.phone&&<div style={{color:'var(--text3)',fontSize:'.84em',marginTop:2}}>{selectedMember.phone}</div>}
              <div style={{display:'flex',gap:6,marginTop:8,flexWrap:'wrap'}}>
                <span className="b ba">{selectedMember.memberCode}</span>
                <span className="b bk">Depuis {new Date(selectedMember.joinDate).toLocaleDateString('fr-FR')}</span>
              </div>
            </div>
            <img src={`https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(selectedMember.memberCode)}&bgcolor=ffffff`} style={{width:72,height:72,borderRadius:8,border:'1px solid var(--border)',padding:3,background:'white',flexShrink:0}} alt="QR"/>
          </div>
          <div className="divider"/>
          {(()=>{
            const mL=loans.filter(l=>l.memberId===selectedMember.id);
            const mH=history.filter(l=>l.memberId===selectedMember.id);
            const mF=mH.filter(l=>l.daysLate>0&&!l.finePaid);
            const mR=reservations.filter(r=>r.memberId===selectedMember.id);
            return(<>
              <div className="stats" style={{marginBottom:14}}>
                <div className="sc c-blue"><div className="sn">{mL.length}</div><div className="sl">Prêts actifs</div></div>
                <div className="sc c-accent"><div className="sn">{mH.length}</div><div className="sl">Total prêts</div></div>
                <div className="sc c-red"><div className="sn">{mF.length}</div><div className="sl">Amendes dues</div></div>
                <div className="sc c-orange"><div className="sn">{mR.length}</div><div className="sl">Réservations</div></div>
              </div>
              {mL.length>0&&<><div style={{fontWeight:700,fontSize:'.78em',color:'var(--text2)',textTransform:'uppercase',letterSpacing:'.05em',marginBottom:7}}>Prêts en cours</div>
              {mL.map(l=>{const bk=books.find(b=>b.id===l.bookId);const d=Math.ceil((new Date(l.dueDate)-new Date())/86400000);return(
                <div key={l.id} className="card" style={{padding:'10px 14px',marginBottom:5}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:8}}>
                    <div><div style={{fontWeight:600,fontSize:'.88em'}}>{bk?.title||'?'}</div><div style={{fontSize:'.75em',color:'var(--text3)',marginTop:2}}>Retour: {new Date(l.dueDate).toLocaleDateString('fr-FR')}</div></div>
                    <span className={`b ${d<0?'br':d<=3?'bo':'bg'}`}>{d<0?Math.abs(d)+'j retard':d+'j restants'}</span>
                  </div>
                </div>);})}
              </>}
              {mH.length>0&&<><div style={{fontWeight:700,fontSize:'.78em',color:'var(--text2)',textTransform:'uppercase',letterSpacing:'.05em',margin:'10px 0 7px'}}>Historique ({mH.length})</div>
              <div style={{maxHeight:190,overflowY:'auto',border:'1px solid var(--border)',borderRadius:'var(--rs)'}}>
                {[...mH].reverse().map(l=>{const bk=books.find(b=>b.id===l.bookId);return(
                  <div key={l.id} style={{padding:'8px 12px',borderBottom:'1px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center',gap:8}}>
                    <div><div style={{fontSize:'.86em',fontWeight:600}}>{bk?.title||'?'}</div><div style={{fontSize:'.73em',color:'var(--text3)'}}>{new Date(l.loanDate).toLocaleDateString('fr-FR')}{l.returnDate?' → '+new Date(l.returnDate).toLocaleDateString('fr-FR'):''}</div></div>
                    <div style={{display:'flex',gap:4,alignItems:'center'}}>
                      {l.daysLate>0&&<span className="b br" style={{fontSize:'.68em'}}>{l.lateFee} HTG</span>}
                      <span className={`b ${l.returnDate?'bg':'bb'}`} style={{fontSize:'.68em'}}>{l.returnDate?'Rendu':'En cours'}</span>
                    </div>
                  </div>);})}
              </div></>}
            </>);
          })()}
          <div style={{marginTop:14,display:'flex',gap:8,flexWrap:'wrap'}}>
            <button className="btn btn-primary btn-sm" onClick={()=>printCard(selectedMember)}><Icon name="printer" size={12}/>Imprimer carte</button>
            {canEdit&&<button className="btn btn-secondary btn-sm" onClick={()=>{openEditM(selectedMember);setSelectedMember(null);}}><Icon name="pencil" size={12}/>Modifier</button>}
            <button className="btn btn-secondary btn-sm" style={{marginLeft:'auto'}} onClick={()=>setSelectedMember(null)}>Fermer</button>
          </div>
        </div>
      </div>
    )}

    {/* Book detail */}
    {selectedBook&&(
      <div className="ov" onClick={()=>setSelectedBook(null)}>
        <div className="mc wide" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">Fiche livre</h2><button className="xb" onClick={()=>setSelectedBook(null)}><Icon name="x" size={14}/></button></div>
          <div style={{display:'flex',gap:18,alignItems:'start',marginBottom:20,flexWrap:'wrap'}}>
            <div style={{flex:1}}>
              <div style={{fontSize:'1.3em',fontWeight:700,color:'var(--text)',fontFamily:"'Fraunces',serif",lineHeight:1.3}}>{selectedBook.title}</div>
              <div style={{color:'var(--text2)',marginTop:4,fontSize:'.92em'}}>{selectedBook.author}</div>
              <div style={{display:'flex',gap:6,marginTop:8,flexWrap:'wrap'}}>
                <span className="b bb">{selectedBook.category}</span>
                {selectedBook.shelf&&<span className="b bo">{selectedBook.shelf}</span>}
                {selectedBook.year&&<span className="b bk">{selectedBook.year}</span>}
                <span className={`b ${selectedBook.available>0?'bg':'br'}`}>{selectedBook.available}/{selectedBook.copies} dispo</span>
              </div>
              {selectedBook.isbn&&<div style={{fontSize:'.79em',color:'var(--text3)',marginTop:5}}>ISBN: {selectedBook.isbn}</div>}
              {selectedBook.description&&<div style={{fontSize:'.82em',color:'var(--text2)',marginTop:7,lineHeight:1.6}}>{selectedBook.description.substring(0,200)}{selectedBook.description.length>200?'…':''}</div>}
            </div>
            <div style={{display:'flex',flexDirection:'column',alignItems:'center',gap:6,flexShrink:0}}>
              <img src={`https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(selectedBook.barcode)}&bgcolor=ffffff`} style={{width:72,height:72,borderRadius:8,border:'1px solid var(--border)',padding:3,background:'white'}} alt="QR"/>
              <span className="b bk" style={{fontSize:'.68em'}}>{selectedBook.barcode}</span>
            </div>
          </div>
          <div className="divider"/>
          {(()=>{
            const bL=loans.filter(l=>l.bookId===selectedBook.id);
            const bH=history.filter(l=>l.bookId===selectedBook.id);
            const bR=reservations.filter(r=>r.bookId===selectedBook.id);
            return(<>
              <div className="stats" style={{marginBottom:14}}>
                <div className="sc c-blue"><div className="sn">{selectedBook.copies}</div><div className="sl">Exemplaires</div></div>
                <div className="sc c-green"><div className="sn">{selectedBook.available}</div><div className="sl">Disponibles</div></div>
                <div className="sc c-accent"><div className="sn">{bH.length}</div><div className="sl">Total prêts</div></div>
                <div className="sc c-orange"><div className="sn">{bR.length}</div><div className="sl">Réservations</div></div>
              </div>
              {bL.length>0&&<><div style={{fontWeight:700,fontSize:'.78em',color:'var(--text2)',textTransform:'uppercase',letterSpacing:'.05em',marginBottom:7}}>Actuellement emprunté par</div>
              {bL.map(l=>{const mb=members.find(m=>m.id===l.memberId);const d=Math.ceil((new Date(l.dueDate)-new Date())/86400000);return(
                <div key={l.id} className="card" style={{padding:'10px 14px',marginBottom:5}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:8}}>
                    <div><div style={{fontWeight:600,fontSize:'.88em'}}>{mb?.name||'?'}</div><div style={{fontSize:'.75em',color:'var(--text3)',marginTop:2}}>Retour: {new Date(l.dueDate).toLocaleDateString('fr-FR')}</div></div>
                    <div style={{display:'flex',gap:5,alignItems:'center'}}>
                      <span className={`b ${d<0?'br':d<=3?'bo':'bg'}`}>{d<0?Math.abs(d)+'j retard':d+'j'}</span>
                      <button className="btn btn-success btn-sm" onClick={()=>{returnLoan(l.id);setSelectedBook(null);}}><Icon name="check" size={12}/></button>
                    </div>
                  </div>
                </div>);})}
              </>}
              {bR.length>0&&<><div style={{fontWeight:700,fontSize:'.78em',color:'var(--text2)',textTransform:'uppercase',letterSpacing:'.05em',margin:'10px 0 7px'}}>Liste d'attente ({bR.length})</div>
              {bR.map((r,i)=>{const mb=members.find(m=>m.id===r.memberId);return(
                <div key={r.id} className="card" style={{padding:'9px 13px',marginBottom:5}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:8}}>
                    <div style={{display:'flex',gap:8,alignItems:'center'}}>
                      <span style={{width:20,height:20,borderRadius:'50%',background:'var(--accent-t)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'.72em',fontWeight:700,color:'var(--accent)',flexShrink:0}}>{i+1}</span>
                      <div><div style={{fontSize:'.86em',fontWeight:600}}>{mb?.name||'?'}</div><div style={{fontSize:'.72em',color:'var(--text3)'}}>{new Date(r.createdAt).toLocaleDateString('fr-FR')}</div></div>
                    </div>
                    <button className="btn btn-danger btn-sm" onClick={()=>cancelReservation(r.id)}><Icon name="x" size={12}/></button>
                  </div>
                </div>);})}
              </>}
              {bH.length>0&&<><div style={{fontWeight:700,fontSize:'.78em',color:'var(--text2)',textTransform:'uppercase',letterSpacing:'.05em',margin:'10px 0 7px'}}>Historique ({bH.length})</div>
              <div style={{maxHeight:170,overflowY:'auto',border:'1px solid var(--border)',borderRadius:'var(--rs)'}}>
                {[...bH].reverse().map(l=>{const mb=members.find(m=>m.id===l.memberId);return(
                  <div key={l.id} style={{padding:'7px 12px',borderBottom:'1px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center',gap:8}}>
                    <div><div style={{fontSize:'.84em',fontWeight:600}}>{mb?.name||'?'}</div><div style={{fontSize:'.72em',color:'var(--text3)'}}>{new Date(l.loanDate).toLocaleDateString('fr-FR')}{l.returnDate?' → '+new Date(l.returnDate).toLocaleDateString('fr-FR'):''}</div></div>
                    <span className={`b ${l.returnDate?'bg':'bb'}`} style={{fontSize:'.68em'}}>{l.returnDate?'Rendu':'En cours'}</span>
                  </div>);})}
              </div></>}
            </>);
          })()}
          <div style={{marginTop:14,display:'flex',gap:8,flexWrap:'wrap'}}>
            <button className="btn btn-primary btn-sm" onClick={()=>printBookBarcode(selectedBook)}><Icon name="printer" size={12}/>Étiquette</button>
            {canEdit&&<button className="btn btn-secondary btn-sm" onClick={()=>{openEditB(selectedBook);setSelectedBook(null);}}><Icon name="pencil" size={12}/>Modifier</button>}
            {canEdit&&<button className="btn btn-secondary btn-sm" onClick={()=>{const a=prompt(`Disponibilité (0-${selectedBook.copies}):`,selectedBook.available);const s=prompt('Statut (normal/lost/damaged):',selectedBook.status||'normal');if(a!==null) setAvailManual(selectedBook.id,a,s||'normal').then(()=>{setSelectedBook(bk=>({...bk,available:parseInt(a),status:s}));});}}><Icon name="settings" size={12}/>Dispo manuelle</button>}
            <button className="btn btn-secondary btn-sm" style={{marginLeft:'auto'}} onClick={()=>setSelectedBook(null)}>Fermer</button>
          </div>
        </div>
      </div>
    )}

    {/* Renew loan */}
    {renewLoanId&&(
      <div className="ov" onClick={()=>setRenewLoanId(null)}>
        <div className="mc" style={{maxWidth:420}} onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">Renouveler le prêt</h2><button className="xb" onClick={()=>setRenewLoanId(null)}><Icon name="x" size={14}/></button></div>
          {(()=>{
            const loan=loans.find(l=>l.id===renewLoanId);
            const bk=books.find(b=>b.id===loan?.bookId);
            const mb=members.find(m=>m.id===loan?.memberId);
            if(!loan) return <div className="al al-e">Prêt introuvable</div>;
            const newDue=new Date(loan.dueDate); newDue.setDate(newDue.getDate()+(cfg.loanDays||14));
            return(<>
              <div className="al al-i" style={{marginBottom:16,gap:10}}>
                <Icon name="book" size={16}/>
                <div><strong>{bk?.title}</strong><br/><span style={{fontSize:'.82em',color:'var(--text2)'}}>{mb?.name} — actuellement dû le {new Date(loan.dueDate).toLocaleDateString('fr-FR')}</span></div>
              </div>
              <div className="fg">
                <label className="fl">Nouvelle date de retour</label>
                <div className="al al-s" style={{marginBottom:8,fontSize:'.83em'}}>
                  <Icon name="check" size={13}/>Nouvelle date proposée : <strong>{newDue.toLocaleDateString('fr-FR')}</strong> (+{cfg.loanDays||14} jours)
                </div>
              </div>
              <div className="fac">
                <button className="btn btn-primary" style={{flex:1}} onClick={()=>renewLoan(renewLoanId)}><Icon name="check" size={13}/>Confirmer le renouvellement</button>
                <button className="btn btn-secondary" onClick={()=>setRenewLoanId(null)}>Annuler</button>
              </div>
            </>);
          })()}
        </div>
      </div>
    )}

    {/* Global search overlay */}
    {showGlobalSearch&&(
      <div className="ov" onClick={()=>setShowGlobalSearch(false)} style={{alignItems:'flex-start',paddingTop:80}}>
        <div style={{width:'100%',maxWidth:620,background:'var(--bg2)',borderRadius:'var(--r)',boxShadow:'var(--shadow-lg)',border:'1px solid var(--border)',overflow:'hidden'}} onClick={e=>e.stopPropagation()}>
          <div style={{display:'flex',alignItems:'center',gap:10,padding:'12px 16px',borderBottom:'1px solid var(--border)'}}>
            <Icon name="search" size={18} color="var(--text3)"/>
            <input autoFocus className="fi" style={{border:'none',background:'transparent',fontSize:'1em',flex:1,outline:'none',padding:0}} placeholder="Rechercher membres, livres, prêts…" value={globalSearch} onChange={e=>setGlobalSearch(e.target.value)}/>
            <span style={{fontSize:'.75em',color:'var(--text3)',background:'var(--bg3)',padding:'2px 6px',borderRadius:4}}>Échap pour fermer</span>
          </div>
          {globalSearch.length>=2&&globalResults.length===0&&<div style={{padding:'24px',textAlign:'center',color:'var(--text3)',fontSize:'.88em'}}>Aucun résultat pour "{globalSearch}"</div>}
          {globalResults.length>0&&<div>
            {['member','book','loan'].map(type=>{
              const items=globalResults.filter(r=>r.type===type);
              if(!items.length) return null;
              const labels={member:'Membres',book:'Livres',loan:'Prêts actifs'};
              const icons={member:'user',book:'book',loan:'book-open'};
              return(<div key={type}>
                <div style={{padding:'8px 16px 4px',fontSize:'.72em',fontWeight:700,color:'var(--text3)',textTransform:'uppercase',letterSpacing:'.06em'}}>{labels[type]}</div>
                {items.map((r,i)=>(
                  <div key={i} onClick={r.action} style={{padding:'10px 16px',cursor:'pointer',display:'flex',gap:10,alignItems:'center',borderBottom:'1px solid var(--border)'}} onMouseEnter={e=>e.currentTarget.style.background='var(--surf)'} onMouseLeave={e=>e.currentTarget.style.background=''}>
                    <Icon name={icons[type]} size={14} color="var(--accent)"/>
                    <div><div style={{fontWeight:600,fontSize:'.9em'}}>{r.label}</div><div style={{fontSize:'.78em',color:'var(--text3)',marginTop:1}}>{r.sub}</div></div>
                  </div>
                ))}
              </div>);
            })}
          </div>}
          {globalSearch.length<2&&<div style={{padding:'16px',display:'flex',gap:8,flexWrap:'wrap'}}>
            {[{key:'/',label:'Ouvrir/fermer'},{key:'M',label:'Membres'},{key:'B',label:'Livres'},{key:'L',label:'Prêts'},{key:'D',label:'Tableau de bord'},{key:'N',label:'Nouveau (Membres/Livres)'}].map(s=>(
              <div key={s.key} style={{display:'flex',gap:6,alignItems:'center',fontSize:'.8em',color:'var(--text2)'}}>
                <kbd style={{background:'var(--bg3)',border:'1px solid var(--border)',borderRadius:4,padding:'2px 6px',fontFamily:'monospace',fontSize:'.9em'}}>{s.key}</kbd>
                <span>{s.label}</span>
              </div>
            ))}
          </div>}
        </div>
      </div>
    )}

    {/* Loan note modal */}
    {noteModal&&(
      <div className="ov" onClick={()=>setNoteModal(null)}>
        <div className="mc" style={{maxWidth:440}} onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">Note sur le prêt</h2><button className="xb" onClick={()=>setNoteModal(null)}><Icon name="x" size={14}/></button></div>
          {(()=>{
            const bk=books.find(b=>b.id===noteModal.bookId);
            const mb=members.find(m=>m.id===noteModal.memberId);
            return(<>
              <div className="al al-i" style={{marginBottom:12,gap:8}}>
                <Icon name="book" size={14}/>
                <div style={{fontSize:'.88em'}}><strong>{bk?.title}</strong> — {mb?.name}</div>
              </div>
              <div className="fg">
                <label className="fl">Note (état du livre, remarque…)</label>
                <textarea className="ft" rows={3} defaultValue={noteModal.note||''} id="loan-note-input" placeholder="Ex: livre retourné avec une page cornée, couverture abîmée…"/>
              </div>
              <div className="fac">
                <button className="btn btn-primary" style={{flex:1}} onClick={()=>saveLoanNote(noteModal.id,document.getElementById('loan-note-input').value)}><Icon name="check" size={13}/>Enregistrer</button>
                <button className="btn btn-secondary" onClick={()=>setNoteModal(null)}>Annuler</button>
              </div>
            </>);
          })()}
        </div>
      </div>
    )}

    {/* Invite user */}
    {modal==='invite'&&isAdmin&&(
      <div className="ov" onClick={close}>
        <div className="mc" style={{maxWidth:460}} onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">Inviter un utilisateur</h2><button className="xb" onClick={close}><Icon name="x" size={14}/></button></div>
          <div className="al al-i" style={{marginBottom:16,flexDirection:'column',alignItems:'start',gap:8}}>
            <div style={{fontWeight:700,fontSize:'.88em'}}>Comment ça fonctionne :</div>
            <ol style={{paddingLeft:16,fontSize:'.82em',lineHeight:2.2,color:'var(--text2)'}}>
              <li>Partagez l'URL de l'application avec votre collaborateur</li>
              <li>Il crée un compte avec son email et mot de passe</li>
              <li>Vous revenez ici → vous verrez son compte apparaître</li>
              <li>Assignez-lui le rôle <strong>Bibliothécaire</strong></li>
            </ol>
            <div style={{fontSize:'.8em',color:'var(--text3)',paddingTop:4,borderTop:'1px solid var(--border)',marginTop:4,width:'100%'}}>
              Sans attribution de rôle, les nouveaux comptes sont en lecture seule.
            </div>
          </div>
          <div className="fg">
            <label className="fl">URL de l'application</label>
            <div style={{display:'flex',gap:8}}>
              <input className="fi" value={window.location.href} readOnly style={{fontSize:'.82em',flex:1}}/>
              <button className="btn btn-secondary" onClick={()=>{navigator.clipboard.writeText(window.location.href);toast('URL copiée !');}}>
                <Icon name="save" size={13}/>Copier
              </button>
            </div>
          </div>
          <div style={{marginTop:8}}>
            <button className="btn btn-primary" style={{width:'100%',justifyContent:'center'}} onClick={()=>{loadTeam();close();setTab('team');}}>
              <Icon name="refresh" size={13}/>Actualiser la liste d'équipe
            </button>
          </div>
        </div>
      </div>
    )}

    {/* Zotero */}
    {modal==='zotero'&&(
      <div className="ov" onClick={()=>{close();setZp([]);setZst('');}}>
        <div className="mc wide" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">Importer depuis Zotero</h2><button className="xb" onClick={()=>{close();setZp([]);setZst('');}}>×</button></div>
          <div className="al al-i" style={{flexDirection:'column',alignItems:'start',gap:6,marginBottom:14}}>
            <div style={{fontWeight:700,fontSize:'.86em'}}>Comment exporter depuis Zotero :</div>
            <ol style={{paddingLeft:16,fontSize:'.82em',lineHeight:2.1,color:'var(--text2)'}}>
              <li>Sélectionnez vos références (Ctrl+A pour tout)</li>
              <li>Clic droit → Exporter les éléments…</li>
              <li>Choisissez BibTeX, RIS ou CSV</li>
            </ol>
          </div>
          <input ref={zRef} type="file" accept=".bib,.ris,.csv" style={{display:'none'}} onChange={handleZFile}/>
          <div className="zdrop" onClick={()=>zRef.current.click()}>
            <Icon name="download" size={28} color="var(--accent)"/>
            <div style={{fontWeight:700,color:'var(--text)',marginTop:8,marginBottom:3}}>Cliquez pour choisir un fichier</div>
            <div style={{fontSize:'.78em',color:'var(--text3)'}}>Formats : .bib · .ris · .csv</div>
          </div>
          {zst&&<div className={`al ${zst.includes('Aucune')||zst.includes('non')?'al-w':'al-s'}`}>{zst}</div>}
          {zp.length>0&&<>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:9}}>
              <div style={{fontWeight:600,fontSize:'.86em',color:'var(--text2)'}}>{zp.filter(b=>b._s).length} / {zp.length} sélectionnée(s)</div>
              <div style={{display:'flex',gap:6}}>
                <button className="btn btn-secondary btn-sm" onClick={()=>setZp(p=>p.map(b=>({...b,_s:true})))}>Tout</button>
                <button className="btn btn-ghost btn-sm" onClick={()=>setZp(p=>p.map(b=>({...b,_s:false})))}>Aucun</button>
              </div>
            </div>
            <div className="zlist">
              {zp.map((bk,i)=>(
                <div key={i} className={`zrow${bk._s?' sel':''}`} onClick={()=>setZp(p=>p.map((b,j)=>j===i?{...b,_s:!b._s}:b))}>
                  <input type="checkbox" checked={bk._s} onChange={()=>{}} style={{width:14,height:14,marginTop:3,accentColor:'var(--accent)',flexShrink:0,cursor:'pointer'}} onClick={e=>e.stopPropagation()}/>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontWeight:600,color:'var(--text)',fontSize:'.88em',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{bk.title}</div>
                    <div style={{fontSize:'.76em',color:'var(--text3)',marginTop:2}}>{bk.author||'—'}{bk.year?` · ${bk.year}`:''}</div>
                  </div>
                  <select className="fsel" style={{width:115,padding:'4px 8px',fontSize:'.76em',flexShrink:0}} value={bk.category} onClick={e=>e.stopPropagation()} onChange={e=>setZp(p=>p.map((b,j)=>j===i?{...b,category:e.target.value}:b))}>
                    {CATS.map(c=><option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
              ))}
            </div>
            <div className="fac">
              <button className="btn btn-primary" style={{flex:1}} onClick={doZotero}><Icon name="download" size={13}/>Importer {zp.filter(b=>b._s).length} livre(s)</button>
              <button className="btn btn-secondary" onClick={()=>{setZp([]);setZst('');}}>Annuler</button>
            </div>
          </>}
        </div>
      </div>
    )}

  </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

</script>
</body>
</html>
