<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BibliothÃ¨que</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,300&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
:root {
  --bg:#0d0f14; --bg2:#13161e; --bg3:#1a1f2c;
  --surf:rgba(255,255,255,.04); --surf2:rgba(255,255,255,.07);
  --border:rgba(255,255,255,.08); --border2:rgba(255,255,255,.14);
  --gold:#c9a84c; --gold2:#e8c97a; --gold3:rgba(201,168,76,.12);
  --red:#e05252; --green:#4caf7d; --blue:#5b9cf6;
  --purple:#9b7af5; --orange:#f09040;
  --text:#eef0f6; --text2:#8b90a0; --text3:#555b6e;
  --r:14px; --rs:9px;
  --shadow:0 8px 32px rgba(0,0,0,.5);
  --glow:0 0 40px rgba(201,168,76,.08);
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{
  font-family:'Plus Jakarta Sans',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
}

/* â”€â”€ Animations â”€â”€ */
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(201,168,76,.35)}50%{box-shadow:0 0 0 7px rgba(201,168,76,0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes toastIn{from{transform:translateX(70px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes shimmer{0%{background-position:-200% center}100%{background-position:200% center}}

.au{animation:fadeUp .35s ease both}
.au2{animation:fadeUp .35s .07s ease both}
.au3{animation:fadeUp .35s .14s ease both}
.au4{animation:fadeUp .35s .21s ease both}

/* â”€â”€ Login Screen â”€â”€ */
.login-wrap{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:radial-gradient(ellipse 80% 60% at 50% -10%, rgba(201,168,76,.12), transparent);
  padding:20px;
}
.login-box{
  width:100%;
  max-width:420px;
  background:var(--bg2);
  border:1px solid var(--border2);
  border-radius:24px;
  padding:48px 40px;
  box-shadow:var(--shadow),var(--glow);
  animation:fadeUp .5s ease;
}
.login-logo{
  width:64px;height:64px;
  border-radius:18px;
  background:linear-gradient(135deg,rgba(201,168,76,.25),rgba(201,168,76,.06));
  border:1px solid rgba(201,168,76,.3);
  display:flex;align-items:center;justify-content:center;
  font-size:30px;margin:0 auto 24px;
}
.login-title{
  font-family:'Fraunces',serif;
  font-size:1.9em;
  text-align:center;
  color:var(--text);
  margin-bottom:6px;
}
.login-sub{font-size:.85em;color:var(--text3);text-align:center;margin-bottom:32px}
.login-tabs{display:flex;gap:8px;background:var(--surf);border-radius:var(--rs);padding:4px;margin-bottom:28px}
.login-tab{flex:1;padding:9px;border:none;background:none;color:var(--text2);font-size:.86em;font-weight:600;cursor:pointer;border-radius:7px;font-family:inherit;transition:all .2s}
.login-tab.active{background:var(--bg3);color:var(--gold2);box-shadow:0 2px 8px rgba(0,0,0,.3)}
.login-err{background:rgba(224,82,82,.12);border:1px solid rgba(224,82,82,.25);color:#f5a0a0;padding:11px 15px;border-radius:var(--rs);font-size:.84em;margin-bottom:16px;text-align:center}

/* â”€â”€ App Shell â”€â”€ */
.shell{display:flex;min-height:100vh}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar{
  width:260px;
  background:var(--bg2);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  position:fixed;height:100vh;z-index:100;
}
.sb-head{
  padding:24px 20px 18px;
  border-bottom:1px solid var(--border);
  position:relative;
}
.sb-head::after{
  content:'';position:absolute;
  bottom:-1px;left:20px;right:20px;height:1px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);
  opacity:.25;
}
.sb-logo-row{display:flex;align-items:center;gap:12px;margin-bottom:3px}
.sb-logo{
  width:42px;height:42px;border-radius:11px;
  background:linear-gradient(135deg,rgba(201,168,76,.2),rgba(201,168,76,.04));
  border:1px solid rgba(201,168,76,.22);
  display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;object-fit:cover;
}
.sb-libname{font-family:'Fraunces',serif;font-size:1.05em;font-weight:500;color:var(--text);line-height:1.2}
.sb-dot{display:inline-flex;align-items:center;gap:5px;font-size:.68em;color:var(--text3);margin-top:2px;font-weight:500}
.sb-dot span{width:5px;height:5px;border-radius:50%;background:var(--green);animation:pulse 2.5s infinite;flex-shrink:0}
.sb-dot span.off{background:var(--orange);animation:none}

.sb-nav{flex:1;padding:10px 8px;overflow-y:auto}
.sb-nav::-webkit-scrollbar{width:2px}
.sb-nav::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.sb-sec{font-size:.63em;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);padding:12px 12px 5px}

.nbtn{
  display:flex;align-items:center;gap:10px;width:100%;
  padding:9px 12px;background:none;border:none;
  color:var(--text2);font-size:.86em;font-weight:500;
  cursor:pointer;transition:all .16s;text-align:left;
  font-family:inherit;border-radius:var(--rs);margin-bottom:2px;
}
.nbtn:hover{background:var(--surf2);color:var(--text)}
.nbtn.active{
  background:linear-gradient(135deg,rgba(201,168,76,.14),rgba(201,168,76,.04));
  color:var(--gold2);border:1px solid rgba(201,168,76,.16);
}
.nbtn .ni{font-size:1.05em;width:20px;text-align:center;flex-shrink:0}
.nbtn .nl{flex:1}
.nbadge{
  background:rgba(255,255,255,.07);border-radius:20px;
  padding:2px 7px;font-size:.7em;font-weight:700;
  color:var(--text2);border:1px solid var(--border);
}
.nbtn.active .nbadge{background:rgba(201,168,76,.15);color:var(--gold);border-color:rgba(201,168,76,.2)}

.sb-foot{
  padding:14px 14px 20px;
  border-top:1px solid var(--border);
  display:flex;flex-direction:column;gap:7px;
}
.sb-foot-row{display:flex;gap:6px}
.sb-foot-btn{
  flex:1;padding:8px 6px;
  border:1px solid var(--border2);background:var(--surf);
  color:var(--text2);border-radius:var(--rs);
  font-size:.76em;cursor:pointer;font-family:inherit;
  transition:all .18s;text-align:center;font-weight:500;
}
.sb-foot-btn:hover{background:var(--surf2);color:var(--text);border-color:var(--border2)}
.sb-foot-btn.zotero{
  background:rgba(201,168,76,.08);border-color:rgba(201,168,76,.2);
  color:var(--gold);width:100%;
}
.sb-foot-btn.zotero:hover{background:rgba(201,168,76,.15);color:var(--gold2)}
.sb-foot-btn.logout{
  background:rgba(224,82,82,.08);border-color:rgba(224,82,82,.18);
  color:#e05252;
}
.sb-foot-btn.logout:hover{background:rgba(224,82,82,.15)}

/* â”€â”€ Main â”€â”€ */
.main{flex:1;margin-left:260px;padding:32px 32px 64px;max-width:calc(100vw - 260px)}

/* â”€â”€ Page header â”€â”€ */
.ph{display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;flex-wrap:wrap;gap:12px}
.pt{font-family:'Fraunces',serif;font-size:1.9em;font-weight:500;color:var(--text)}

/* â”€â”€ Stats â”€â”€ */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:28px}
.sc{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);padding:20px;
  position:relative;overflow:hidden;
  transition:border-color .2s,transform .2s;
}
.sc:hover{border-color:var(--border2);transform:translateY(-2px)}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.sc.blue::before{background:linear-gradient(90deg,var(--blue),transparent)}
.sc.green::before{background:linear-gradient(90deg,var(--green),transparent)}
.sc.purple::before{background:linear-gradient(90deg,var(--purple),transparent)}
.sc.orange::before{background:linear-gradient(90deg,var(--orange),transparent)}
.sc.red::before{background:linear-gradient(90deg,var(--red),transparent)}
.sc.gold::before{background:linear-gradient(90deg,var(--gold),transparent)}
.sn{font-size:2.5em;font-weight:700;color:var(--text);line-height:1;margin-bottom:5px;font-family:'Fraunces',serif}
.sl{font-size:.78em;color:var(--text3);font-weight:500;letter-spacing:.02em}

/* â”€â”€ Buttons â”€â”€ */
.btn{
  padding:10px 20px;border:none;border-radius:var(--rs);
  font-size:.88em;font-weight:600;cursor:pointer;
  transition:all .18s;display:inline-flex;align-items:center;gap:7px;
  font-family:inherit;letter-spacing:.01em;
}
.btn:active{transform:scale(.97)}
.btn-primary{
  background:linear-gradient(135deg,var(--gold),#a8842a);
  color:#0d0f14;box-shadow:0 3px 14px rgba(201,168,76,.28);
}
.btn-primary:hover{box-shadow:0 4px 20px rgba(201,168,76,.4);filter:brightness(1.08)}
.btn-success{background:rgba(76,175,125,.15);color:var(--green);border:1px solid rgba(76,175,125,.25)}
.btn-success:hover{background:rgba(76,175,125,.25)}
.btn-danger{background:rgba(224,82,82,.12);color:var(--red);border:1px solid rgba(224,82,82,.2)}
.btn-danger:hover{background:rgba(224,82,82,.22)}
.btn-secondary{background:var(--surf2);color:var(--text2);border:1px solid var(--border2)}
.btn-secondary:hover{background:var(--bg3);color:var(--text)}
.btn-ghost{background:transparent;color:var(--text3);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surf);color:var(--text2)}
.btn-sm{padding:6px 13px;font-size:.8em}
.btn-email{background:rgba(91,156,246,.12);color:var(--blue);border:1px solid rgba(91,156,246,.22)}
.btn-email:hover{background:rgba(91,156,246,.22)}

/* â”€â”€ Search / Filter â”€â”€ */
.sw{position:relative;margin-bottom:16px}
.sw-icon{position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none;font-size:.95em}
.sbar{
  width:100%;padding:10px 14px 10px 38px;
  border:1px solid var(--border);border-radius:var(--rs);
  font-size:.9em;background:var(--bg2);color:var(--text);
  font-family:inherit;transition:border-color .18s,box-shadow .18s;
}
.sbar:focus{outline:none;border-color:rgba(201,168,76,.4);box-shadow:0 0 0 3px rgba(201,168,76,.08)}
.fbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.fsel{
  padding:9px 13px;border:1px solid var(--border);border-radius:var(--rs);
  font-size:.86em;background:var(--bg2);color:var(--text2);
  cursor:pointer;font-family:inherit;transition:border-color .18s;
}
.fsel:focus{outline:none;border-color:rgba(201,168,76,.35)}

/* â”€â”€ Cards â”€â”€ */
.grid{display:grid;gap:13px}
.card{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);padding:20px;
  transition:border-color .2s,box-shadow .2s,transform .2s;
}
.card:hover{border-color:var(--border2);box-shadow:0 4px 20px rgba(0,0,0,.3);transform:translateY(-1px)}
.card.late{border-color:rgba(224,82,82,.25);background:rgba(224,82,82,.03)}
.ct{font-size:1.05em;font-weight:700;color:var(--text);margin-bottom:3px}
.cs{color:var(--text3);font-size:.85em;margin-bottom:2px;line-height:1.5}
.cm{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
.ca{display:flex;gap:7px;flex-wrap:wrap;margin-top:13px;padding-top:13px;border-top:1px solid var(--border)}

/* â”€â”€ Badges â”€â”€ */
.b{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:.74em;font-weight:600;gap:4px}
.bg{background:rgba(76,175,125,.12);color:var(--green);border:1px solid rgba(76,175,125,.2)}
.br{background:rgba(224,82,82,.12);color:var(--red);border:1px solid rgba(224,82,82,.2)}
.bp{background:rgba(155,122,245,.12);color:var(--purple);border:1px solid rgba(155,122,245,.2)}
.bb{background:rgba(91,156,246,.12);color:var(--blue);border:1px solid rgba(91,156,246,.2)}
.bo{background:rgba(240,144,64,.12);color:var(--orange);border:1px solid rgba(240,144,64,.2)}
.bk{background:var(--surf2);color:var(--text3);border:1px solid var(--border)}
.bgold{background:rgba(201,168,76,.1);color:var(--gold);border:1px solid rgba(201,168,76,.2)}

/* â”€â”€ Modals â”€â”€ */
.ov{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.7);backdrop-filter:blur(6px);
  display:flex;align-items:center;justify-content:center;
  z-index:1000;animation:fadeIn .15s;
}
.mc{
  background:var(--bg2);border:1px solid var(--border2);
  border-radius:20px;padding:32px;
  max-width:600px;width:93%;max-height:90vh;overflow-y:auto;
  animation:fadeUp .22s ease;box-shadow:var(--shadow);
}
.mc.wide{max-width:740px}
.mc::-webkit-scrollbar{width:3px}
.mc::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.mh{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.mt{font-family:'Fraunces',serif;font-size:1.5em;font-weight:500;color:var(--text)}
.xb{
  background:var(--surf2);border:none;font-size:1.1em;
  cursor:pointer;color:var(--text3);width:32px;height:32px;
  display:flex;align-items:center;justify-content:center;
  border-radius:50%;transition:all .18s;
}
.xb:hover{background:var(--bg3);color:var(--text)}

/* â”€â”€ Forms â”€â”€ */
.fg{margin-bottom:15px}
.fl{display:block;font-weight:600;color:var(--text2);margin-bottom:5px;font-size:.82em;letter-spacing:.02em;text-transform:uppercase}
.fi,.ft{
  width:100%;padding:10px 13px;
  border:1px solid var(--border);border-radius:var(--rs);
  font-size:.9em;background:var(--bg3);color:var(--text);
  font-family:inherit;transition:border-color .18s,box-shadow .18s;
}
.fi:focus,.ft:focus{outline:none;border-color:rgba(201,168,76,.4);box-shadow:0 0 0 3px rgba(201,168,76,.08)}
.ft{resize:vertical;min-height:80px}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fac{display:flex;gap:10px;margin-top:24px}
.fsel{background:var(--bg3);color:var(--text)}

/* â”€â”€ Photo upload â”€â”€ */
.pu{
  border:2px dashed var(--border2);border-radius:var(--r);
  padding:20px;text-align:center;cursor:pointer;
  transition:all .2s;background:var(--surf);
}
.pu:hover{border-color:rgba(201,168,76,.35);background:var(--gold3)}
.pp{width:110px;height:110px;border-radius:50%;object-fit:cover;border:3px solid rgba(201,168,76,.4);margin:12px auto;display:block}

/* â”€â”€ Scanner â”€â”€ */
.scan-box{
  background:linear-gradient(135deg,var(--bg2),var(--bg3));
  border:1px solid var(--border2);
  padding:24px;border-radius:var(--r);color:var(--text);margin-bottom:24px;
  box-shadow:var(--glow);
}
.scan-in{
  width:100%;padding:14px 18px;
  border:1px solid rgba(201,168,76,.25);border-radius:var(--rs);
  font-size:1.05em;font-weight:500;font-family:inherit;
  background:var(--bg);color:var(--text);
  transition:border-color .2s,box-shadow .2s;
}
.scan-in:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,.1)}
.scan-st{
  margin-top:12px;padding:10px 16px;
  background:rgba(255,255,255,.05);border-radius:var(--rs);
  font-size:.9em;border:1px solid var(--border);
}

/* â”€â”€ Cat grid â”€â”€ */
.cg{display:grid;grid-template-columns:repeat(auto-fill,minmax(148px,1fr));gap:12px;margin-bottom:28px}
.cc{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);padding:18px;text-align:center;cursor:pointer;
  transition:all .2s;
}
.cc:hover{border-color:rgba(201,168,76,.3);box-shadow:var(--glow);transform:translateY(-2px)}
.cn{font-size:2.2em;font-weight:700;color:var(--gold2);font-family:'Fraunces',serif}
.cl{font-size:.76em;color:var(--text3);margin-top:4px;font-weight:500;text-transform:uppercase;letter-spacing:.04em}

/* â”€â”€ Alerts â”€â”€ */
.al{padding:12px 16px;border-radius:var(--rs);margin-bottom:14px;display:flex;align-items:center;gap:10px;font-size:.87em;flex-wrap:wrap}
.al-w{background:rgba(240,144,64,.1);color:#f0b464;border:1px solid rgba(240,144,64,.2)}
.al-s{background:rgba(76,175,125,.1);color:var(--green);border:1px solid rgba(76,175,125,.2)}
.al-i{background:rgba(91,156,246,.1);color:var(--blue);border:1px solid rgba(91,156,246,.2)}
.al-e{background:rgba(224,82,82,.1);color:var(--red);border:1px solid rgba(224,82,82,.2)}

/* â”€â”€ Empty â”€â”€ */
.empty{text-align:center;padding:60px 20px;color:var(--text3)}
.empty-i{font-size:3.2em;margin-bottom:12px;opacity:.3}

/* â”€â”€ Settings section â”€â”€ */
.ss{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:16px}
.ss h3{font-size:.82em;font-weight:700;color:var(--text2);margin-bottom:14px;text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);padding-bottom:8px}

/* â”€â”€ QR â”€â”€ */
.qr{width:90px;height:90px;border-radius:var(--rs);flex-shrink:0;border:1px solid var(--border);background:white;padding:4px}

/* â”€â”€ Avatar â”€â”€ */
.av{
  width:58px;height:58px;border-radius:50%;
  object-fit:cover;border:2px solid var(--border2);flex-shrink:0;
  font-size:26px;display:flex;align-items:center;justify-content:center;
  background:var(--bg3);
}

/* â”€â”€ Toasts â”€â”€ */
.tc{position:fixed;bottom:24px;right:24px;display:flex;flex-direction:column;gap:8px;z-index:9999;pointer-events:none}
.toast{
  background:var(--bg2);color:var(--text);border:1px solid var(--border2);
  padding:12px 17px;border-radius:var(--rs);
  box-shadow:var(--shadow);font-size:.87em;font-weight:500;
  animation:toastIn .22s ease;min-width:220px;
  display:flex;align-items:center;gap:9px;
}
.toast.ok{border-color:rgba(76,175,125,.3);background:rgba(76,175,125,.08)}
.toast.err{border-color:rgba(224,82,82,.3);background:rgba(224,82,82,.08)}
.toast.warn{border-color:rgba(240,144,64,.3);background:rgba(240,144,64,.08)}

/* â”€â”€ Zotero â”€â”€ */
.zdrop{
  border:2px dashed var(--border2);border-radius:var(--r);
  padding:28px;text-align:center;cursor:pointer;
  background:var(--surf);transition:border-color .2s,background .2s;
  margin-bottom:16px;
}
.zdrop:hover{border-color:rgba(201,168,76,.35);background:var(--gold3)}
.zlist{max-height:320px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--rs);margin-bottom:16px}
.zlist::-webkit-scrollbar{width:3px}
.zlist::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.zrow{display:flex;align-items:start;gap:12px;padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .14s}
.zrow:last-child{border-bottom:none}
.zrow:hover,.zrow.sel{background:var(--gold3)}

/* â”€â”€ Divider â”€â”€ */
.divider{height:1px;background:var(--border);margin:20px 0}

/* â”€â”€ Spinner â”€â”€ */
.spinner{width:18px;height:18px;border:2px solid var(--border2);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}

/* â”€â”€ Responsive â”€â”€ */
@media(max-width:768px){
  .sidebar{width:100%;height:auto;position:relative}
  .main{margin-left:0;padding:18px;max-width:100%}
  .fgrid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL = 'https://kokwzdfbypjvvqduuovk.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtva3d6ZGZieXBqdnZxZHV1b3ZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MDI1NTYsImV4cCI6MjA4NzQ3ODU1Nn0.fhPdFPa3Ap6SM6RK5bAs46bIBko3t-tBFm2w_fnKMn4';

const CATS = ['Fiction','Science','Histoire','Biographie','Enfants','Religion','Technologie','Art','Cuisine','Autre'];
const USE_SB = !!(SB_URL && SB_KEY && SB_KEY.startsWith('eyJ'));

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gd(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch{ return []; } }
function sd(k,v){ localStorage.setItem(k,JSON.stringify(v)); }
function gsettings(){ try{ return JSON.parse(localStorage.getItem('lib_cfg')||'{}'); }catch{ return {}; } }
function gid(){ return Date.now()+Math.floor(Math.random()*9999); }
function today(){ return new Date().toISOString().split('T')[0]; }
function dlBlob(blob,name){ const u=URL.createObjectURL(blob),a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u); }

// â”€â”€ Supabase REST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sb(table, method='GET', body=null, qs='', token=null){
  const url=`${SB_URL}/rest/v1/${table}${qs}`;
  const h={
    'apikey':SB_KEY,
    'Authorization':`Bearer ${token||SB_KEY}`,
    'Content-Type':'application/json',
    'Prefer':'return=representation'
  };
  const r=await fetch(url,{method,headers:h,body:body?JSON.stringify(body):null});
  if(!r.ok){ const e=await r.text(); throw new Error(e); }
  const t=await r.text(); return t?JSON.parse(t):[];
}

// â”€â”€ Supabase Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sbSignIn(email, password){
  const r=await fetch(`${SB_URL}/auth/v1/token?grant_type=password`,{
    method:'POST',
    headers:{'apikey':SB_KEY,'Content-Type':'application/json'},
    body:JSON.stringify({email,password})
  });
  if(!r.ok){ const e=await r.json(); throw new Error(e.error_description||e.msg||'Erreur de connexion'); }
  return r.json();
}
async function sbSignUp(email, password){
  const r=await fetch(`${SB_URL}/auth/v1/signup`,{
    method:'POST',
    headers:{'apikey':SB_KEY,'Content-Type':'application/json'},
    body:JSON.stringify({email,password})
  });
  if(!r.ok){ const e=await r.json(); throw new Error(e.error_description||e.msg||'Erreur inscription'); }
  return r.json();
}
async function sbSignOut(token){
  await fetch(`${SB_URL}/auth/v1/logout`,{
    method:'POST',
    headers:{'apikey':SB_KEY,'Authorization':`Bearer ${token}`}
  });
}
function getStoredSession(){
  try{ return JSON.parse(localStorage.getItem('lib_session')||'null'); }catch{ return null; }
}
function storeSession(s){ localStorage.setItem('lib_session',JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem('lib_session'); }

// â”€â”€ Mappers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const toM = r=>({id:r.id,memberCode:r.member_code,name:r.name,email:r.email,phone:r.phone||'',address:r.address||'',dateOfBirth:r.date_of_birth||'',idNumber:r.id_number||'',photo:r.photo||'',joinDate:r.join_date});
const fromM = m=>{
  const o={member_code:m.memberCode,name:m.name,email:m.email};
  if(m.phone!==undefined) o.phone=m.phone||null;
  if(m.address!==undefined) o.address=m.address||null;
  if(m.photo!==undefined) o.photo=m.photo||null;
  if(m.dateOfBirth!==undefined) o.date_of_birth=m.dateOfBirth||null;
  if(m.idNumber!==undefined) o.id_number=m.idNumber||null;
  return o;
};
const toB = r=>({id:r.id,barcode:r.barcode,title:r.title,author:r.author,isbn:r.isbn||'',year:r.year||'',category:r.category||'Autre',publisher:r.publisher||'',shelf:r.shelf||'',copies:r.copies,available:r.available,description:r.description||'',addedDate:r.added_date});
const fromB = b=>({barcode:b.barcode,title:b.title,author:b.author,isbn:b.isbn||null,year:b.year||null,category:b.category,publisher:b.publisher||null,shelf:b.shelf||null,copies:b.copies,available:b.available,description:b.description||null});
const toL = r=>({id:r.id,bookId:r.book_id,memberId:r.member_id,loanDate:r.loan_date,dueDate:r.due_date,returnDate:r.return_date||null,daysLate:r.days_late||0,lateFee:r.late_fee||0});

// â”€â”€ DB layer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DB = {
  async getMembers(){
    if(!USE_SB) return gd('lib_members');
    return (await sb('members','GET',null,'?order=join_date.desc')).map(toM);
  },
  async getBooks(){
    if(!USE_SB) return gd('lib_books');
    return (await sb('books','GET',null,'?order=added_date.desc')).map(toB);
  },
  async getLoans(activeOnly=true){
    if(!USE_SB){
      const all=gd('lib_loans');
      return activeOnly?all.filter(l=>!l.returnDate):all;
    }
    const qs=activeOnly?'?return_date=is.null&order=loan_date.desc':'?order=loan_date.desc';
    return (await sb('loans','GET',null,qs)).map(toL);
  },
  async addMember(m){
    if(!USE_SB){ sd('lib_members',[...gd('lib_members'),m]); return m; }
    const r=await sb('members','POST',fromM(m));
    return toM(Array.isArray(r)?r[0]:r);
  },
  async updateMember(id,m){
    if(!USE_SB){ sd('lib_members',gd('lib_members').map(x=>x.id===id?{...x,...m}:x)); return; }
    await sb('members','PATCH',fromM(m),`?id=eq.${id}`);
  },
  async deleteMember(id){
    if(!USE_SB){ sd('lib_members',gd('lib_members').filter(x=>x.id!==id)); return; }
    await sb('members','DELETE',null,`?id=eq.${id}`);
  },
  async addBook(b){
    if(!USE_SB){ sd('lib_books',[...gd('lib_books'),b]); return b; }
    const r=await sb('books','POST',fromB(b));
    return toB(Array.isArray(r)?r[0]:r);
  },
  async updateBook(id,b){
    if(!USE_SB){ sd('lib_books',gd('lib_books').map(x=>x.id===id?{...x,...b}:x)); return; }
    await sb('books','PATCH',fromB(b),`?id=eq.${id}`);
  },
  async deleteBook(id){
    if(!USE_SB){ sd('lib_books',gd('lib_books').filter(x=>x.id!==id)); return; }
    await sb('books','DELETE',null,`?id=eq.${id}`);
  },
  async setAvail(id,delta){
    if(!USE_SB){
      const all=gd('lib_books'),b=all.find(x=>x.id===id);
      if(b){b.available=Math.min(b.copies,Math.max(0,b.available+delta));sd('lib_books',all);}
      return;
    }
    const rows=await sb('books','GET',null,`?id=eq.${id}&select=available,copies`);
    if(rows.length) await sb('books','PATCH',{available:Math.min(rows[0].copies,Math.max(0,rows[0].available+delta))},`?id=eq.${id}`);
  },
  async addLoan(l){
    if(!USE_SB){ sd('lib_loans',[...gd('lib_loans'),l]); return l; }
    const r=await sb('loans','POST',{book_id:l.bookId,member_id:l.memberId,loan_date:l.loanDate,due_date:l.dueDate});
    return toL(Array.isArray(r)?r[0]:r);
  },
  async returnLoan(id,daysLate,lateFee){
    if(!USE_SB){ sd('lib_loans',gd('lib_loans').map(l=>l.id===id?{...l,returnDate:new Date().toISOString(),daysLate,lateFee}:l)); return; }
    await sb('loans','PATCH',{return_date:new Date().toISOString(),days_late:daysLate,late_fee:lateFee},`?id=eq.${id}`);
  },
  async bulkAddBooks(arr){
    if(!USE_SB){ sd('lib_books',[...gd('lib_books'),...arr]); return arr; }
    const r=await sb('books','POST',arr.map(fromB));
    return (Array.isArray(r)?r:[r]).map(toB);
  }
};

// â”€â”€ BibTeX parser (no { } in regex) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseBib(txt){
  const res=[],lines=txt.split('\n');
  const cm={book:'Autre',article:'Science',inproceedings:'Science',phdthesis:'Science',mastersthesis:'Science',techreport:'Technologie',manual:'Technologie'};
  let cur=null;
  for(const raw of lines){
    const line=raw.trim();
    if(/^@\w+\s*\x7B/.test(line)){
      const t=(line.match(/^@(\w+)/)||[])[1]||'misc';
      cur={type:t.toLowerCase(),fields:{}};
      res.push(cur);
    } else if(cur&&line.includes('=')){
      const eq=line.indexOf('=');
      const key=line.slice(0,eq).trim().toLowerCase();
      let val=line.slice(eq+1).trim();
      if(val.charAt(0)==='\x7B') val=val.slice(1);
      if(val.slice(-2)==='\x7D,') val=val.slice(0,-2);
      else if(val.slice(-1)===',') val=val.slice(0,-1);
      else if(val.slice(-1)==='\x7D') val=val.slice(0,-1);
      if(key&&val) cur.fields[key]=(cur.fields[key]?cur.fields[key]+' ':'')+val.replace(/\s+/g,' ').trim();
    }
  }
  return res.filter(e=>e.fields.title).map(e=>{
    const f=e.fields;
    return {title:f.title||'',author:(f.author||f.editor||'').replace(/ and /gi,', '),isbn:f.isbn||f.isbn13||'',publisher:f.publisher||'',year:f.year||'',description:f.abstract||'',category:cm[e.type]||'Autre',shelf:'',copies:1};
  });
}
function parseRIS(txt){
  const res=[];
  txt.split(/\nER\s*-/).forEach(block=>{
    const f={};
    block.split('\n').forEach(line=>{const m=line.match(/^([A-Z][A-Z0-9])\s+-\s+(.+)$/);if(m){if(!f[m[1]])f[m[1]]=[];f[m[1]].push(m[2].trim());}});
    const title=(f['TI']||f['T1']||f['BT']||[''])[0];if(!title)return;
    const ty=(f['TY']||['BOOK'])[0];
    const cm={BOOK:'Autre',JOUR:'Science',CONF:'Science',THES:'Science',RPRT:'Technologie',COMP:'Technologie'};
    res.push({title,author:(f['AU']||f['A1']||[]).join(', '),year:((f['PY']||f['Y1']||[''])[0]).substring(0,4),isbn:(f['SN']||[''])[0],publisher:(f['PB']||[''])[0],description:(f['AB']||f['N2']||[''])[0],category:cm[ty]||'Autre',shelf:'',copies:1});
  });
  return res;
}
function parseCSV(txt){
  function pl(line){const res=[];let cur='',q=false;for(let i=0;i<line.length;i++){const c=line[i];if(c==='"'&&line[i+1]==='"'){cur+='"';i++;}else if(c==='"'){q=!q;}else if(c===','&&!q){res.push(cur);cur='';}else{cur+=c;}}res.push(cur);return res;}
  const lines=txt.split('\n').filter(l=>l.trim());if(lines.length<2)return[];
  const hdrs=pl(lines[0]).map(h=>h.trim().toLowerCase());
  const col=(...ns)=>{for(const n of ns){const i=hdrs.indexOf(n);if(i!==-1)return i;}return -1;};
  const res=[];
  for(let i=1;i<lines.length;i++){
    const v=pl(lines[i]);
    const g=(...ns)=>{const idx=col(...ns);return idx!==-1?(v[idx]||'').trim():'';};
    const title=g('title');if(!title)continue;
    const ty=g('item type','type','itemtype').toLowerCase().replace(/\s/g,'');
    const cm={book:'Autre',journalarticle:'Science',conferencepaper:'Science',thesis:'Science',report:'Technologie',computerprogram:'Technologie',artwork:'Art'};
    res.push({title,author:g('author','authors'),year:g('publication year','year','date').substring(0,4),isbn:g('isbn','isbn/issn'),publisher:g('publisher'),description:g('abstract note','abstract'),category:cm[ty]||'Autre',shelf:'',copies:1});
  }
  return res;
}

// â”€â”€ Toast component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Toasts({list}){
  return <div className="tc">{list.map(t=><div key={t.id} className={`toast ${t.cls}`}><span>{t.icon}</span><span>{t.msg}</span></div>)}</div>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIN COMPONENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Login({onLogin}){
  const [mode,setMode]=useState('login');
  const [email,setEmail]=useState('');
  const [pwd,setPwd]=useState('');
  const [loading,setLoading]=useState(false);
  const [err,setErr]=useState('');

  async function handle(){
    if(!email||!pwd){setErr('Email et mot de passe requis');return;}
    setLoading(true);setErr('');
    try{
      let data;
      if(mode==='login') data=await sbSignIn(email,pwd);
      else data=await sbSignUp(email,pwd);
      if(data.access_token){
        storeSession(data);
        onLogin(data);
      } else if(mode==='register'){
        setErr('Compte crÃ©Ã© ! VÃ©rifiez votre email pour confirmer, puis connectez-vous.');
        setMode('login');
      }
    }catch(e){ setErr(e.message); }
    finally{ setLoading(false); }
  }

  return(
    <div className="login-wrap">
      <div className="login-box">
        <div className="login-logo">ğŸ“š</div>
        <div className="login-title">BibliothÃ¨que</div>
        <div className="login-sub">SystÃ¨me de gestion professionnel</div>
        <div className="login-tabs">
          <button className={`login-tab${mode==='login'?' active':''}`} onClick={()=>{setMode('login');setErr('');}}>Connexion</button>
          <button className={`login-tab${mode==='register'?' active':''}`} onClick={()=>{setMode('register');setErr('');}}>Inscription</button>
        </div>
        {err&&<div className="login-err">{err}</div>}
        <div className="fg">
          <label className="fl">Email</label>
          <input className="fi" type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="admin@bibliotheque.com" onKeyPress={e=>e.key==='Enter'&&handle()}/>
        </div>
        <div className="fg">
          <label className="fl">Mot de passe</label>
          <input className="fi" type="password" value={pwd} onChange={e=>setPwd(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onKeyPress={e=>e.key==='Enter'&&handle()}/>
        </div>
        <button className="btn btn-primary" style={{width:'100%',justifyContent:'center',marginTop:8,padding:'13px'}} onClick={handle} disabled={loading}>
          {loading?<span className="spinner"/>:mode==='login'?'Se connecter â†’':'CrÃ©er le compte â†’'}
        </button>
        {mode==='login'&&<div style={{textAlign:'center',marginTop:16,fontSize:'.78em',color:'var(--text3)'}}>
          PremiÃ¨re utilisation ? CrÃ©ez un compte administrateur ci-dessus.
        </div>}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App(){
  const [session,setSession]=useState(null);
  const [authReady,setAuthReady]=useState(false);
  const [tab,setTab]=useState('dashboard');
  const [members,setMembers]=useState([]);
  const [books,setBooks]=useState([]);
  const [loans,setLoans]=useState([]);
  const [history,setHistory]=useState([]);
  const [loading,setLoading]=useState(true);
  const [modal,setModal]=useState(null);
  const [search,setSearch]=useState('');
  const [catF,setCatF]=useState('all');
  const [scanVal,setScanVal]=useState('');
  const [scanSt,setScanSt]=useState('');
  const [scanItem,setScanItem]=useState(null);
  const [toasts,setToasts]=useState([]);
  const [cfg,setCfg]=useState({libraryName:'Ma BibliothÃ¨que',libraryLogo:'',loanDays:14,feePerDay:10});
  const [mf,setMf]=useState({name:'',email:'',phone:'',address:'',dateOfBirth:'',idNumber:'',photo:''});
  const [bf,setBf]=useState({title:'',author:'',isbn:'',year:'',category:'Fiction',publisher:'',shelf:'',copies:1,description:''});
  const [editM,setEditM]=useState(null);
  const [editB,setEditB]=useState(null);
  const [zp,setZp]=useState([]);
  const [zst,setZst]=useState('');
  const [emailSending,setEmailSending]=useState(false);

  const scanRef=useRef(),logoRef=useRef(),photoRef=useRef(),importRef=useRef(),zRef=useRef();

  // â”€â”€ Auth init â”€â”€
  useEffect(()=>{
    const stored=getStoredSession();
    if(stored&&stored.access_token){
      setSession(stored);
    }
    setAuthReady(true);
    const s=gsettings(); if(s&&s.libraryName) setCfg(prev=>({...prev,...s}));
  },[]);

  useEffect(()=>{ if(session) reload(); },[session]);
  useEffect(()=>{ if(tab==='scanner'&&scanRef.current) scanRef.current.focus(); },[tab]);

  function handleLogin(data){ storeSession(data); setSession(data); }
  async function handleLogout(){
    try{ if(session) await sbSignOut(session.access_token); }catch(e){}
    clearSession(); setSession(null); setMembers([]); setBooks([]); setLoans([]); setHistory([]);
  }

  // â”€â”€ Reload â”€â”€
  async function reload(){
    setLoading(true);
    try{
      const[m,b,l,h]=await Promise.all([DB.getMembers(),DB.getBooks(),DB.getLoans(true),DB.getLoans(false)]);
      setMembers(m);setBooks(b);setLoans(l);setHistory(h);
    }catch(e){ toast(e.message,'err','âŒ'); }
    finally{ setLoading(false); }
  }

  // â”€â”€ Toast â”€â”€
  function toast(msg,cls='ok',icon='âœ…'){
    const id=gid();
    setToasts(p=>[...p,{id,msg,cls,icon}]);
    setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),3800);
  }
  const close=()=>setModal(null);

  // â”€â”€ Settings â”€â”€
  function saveCfg(s){ setCfg(s); localStorage.setItem('lib_cfg',JSON.stringify(s)); toast('ParamÃ¨tres sauvegardÃ©s'); close(); }

  // â”€â”€ Members â”€â”€
  async function saveMember(){
    if(!mf.name||!mf.email){ toast('Nom et email requis','err','âš ï¸'); return; }
    try{
      if(editM){ await DB.updateMember(editM.id,mf); toast('Membre mis Ã  jour'); }
      else{
        const all=await DB.getMembers();
        const maxN=all.reduce((mx,m)=>Math.max(mx,parseInt((m.memberCode||'').replace('MBR-','')||0)),0);
        await DB.addMember({...mf,id:gid(),memberCode:`MBR-${String(maxN+1).padStart(4,'0')}`,joinDate:new Date().toISOString()});
        toast('Membre ajoutÃ© !');
      }
      setMf({name:'',email:'',phone:'',address:'',dateOfBirth:'',idNumber:'',photo:''});
      setEditM(null); close(); reload();
    }catch(e){ toast(e.message,'err','âŒ'); }
  }
  async function delMember(id){
    if(!confirm('Supprimer ce membre ?')) return;
    if(loans.some(l=>l.memberId===id)){ toast('Membre avec prÃªts actifs','err','âŒ'); return; }
    try{ await DB.deleteMember(id); toast('Membre supprimÃ©'); reload(); }
    catch(e){ toast(e.message,'err','âŒ'); }
  }
  function openEditM(m){ setMf({...m}); setEditM(m); setModal('member'); }

  // â”€â”€ Books â”€â”€
  async function saveBook(){
    if(!bf.title||!bf.author){ toast('Titre et auteur requis','err','âš ï¸'); return; }
    try{
      const copies=parseInt(bf.copies)||1;
      if(editB){ await DB.updateBook(editB.id,{...bf,copies}); toast('Livre mis Ã  jour'); }
      else{
        const all=await DB.getBooks();
        const maxN=all.reduce((mx,b)=>Math.max(mx,parseInt((b.barcode||'').replace('BOOK-','')||0)),0);
        await DB.addBook({...bf,copies,available:copies,id:gid(),barcode:`BOOK-${String(maxN+1).padStart(4,'0')}`,addedDate:new Date().toISOString()});
        toast('Livre ajoutÃ© !');
      }
      setBf({title:'',author:'',isbn:'',year:'',category:'Fiction',publisher:'',shelf:'',copies:1,description:''});
      setEditB(null); close(); reload();
    }catch(e){ toast(e.message,'err','âŒ'); }
  }
  async function delBook(id){
    if(!confirm('Supprimer ce livre ?')) return;
    if(loans.some(l=>l.bookId===id)){ toast('Livre actuellement prÃªtÃ©','err','âŒ'); return; }
    try{ await DB.deleteBook(id); toast('Livre supprimÃ©'); reload(); }
    catch(e){ toast(e.message,'err','âŒ'); }
  }
  function openEditB(b){ setBf({...b}); setEditB(b); setModal('book'); }

  // â”€â”€ Loans â”€â”€
  async function createLoan(bookId,memberId){
    const bk=books.find(b=>b.id===bookId);
    if(!bk||bk.available<=0){ toast('Livre non disponible','err','âŒ'); return; }
    try{
      const due=new Date(); due.setDate(due.getDate()+(cfg.loanDays||14));
      await DB.addLoan({id:gid(),bookId,memberId,loanDate:new Date().toISOString(),dueDate:due.toISOString(),returnDate:null});
      await DB.setAvail(bookId,-1);
      toast('PrÃªt crÃ©Ã© !'); setScanVal(''); setScanSt('âœ… PrÃªt enregistrÃ© !');
      setTimeout(()=>setScanSt(''),3000); reload();
    }catch(e){ toast(e.message,'err','âŒ'); }
  }
  async function returnLoan(loanId){
    const loan=loans.find(l=>l.id===loanId); if(!loan) return;
    const now=new Date(),due=new Date(loan.dueDate);
    const daysLate=Math.max(0,Math.ceil((now-due)/86400000));
    const lateFee=daysLate*(cfg.feePerDay||10);
    try{
      await DB.returnLoan(loanId,daysLate,lateFee);
      await DB.setAvail(loan.bookId,+1);
      if(daysLate>0) toast(`${daysLate}j retard â€” ${lateFee} HTG`,'warn','âš ï¸');
      else toast('Retour enregistrÃ© !');
      reload();
    }catch(e){ toast(e.message,'err','âŒ'); }
  }

  // â”€â”€ Scanner â”€â”€
  function handleScan(e){
    if(e.key!=='Enter'||!scanVal.trim()) return;
    const code=scanVal.trim().toUpperCase();
    if(code.startsWith('MBR-')){
      const m=members.find(x=>x.memberCode===code);
      if(m){ setScanItem({type:'member',data:m}); setScanSt(`âœ… Membre: ${m.name}`); }
      else setScanSt('âŒ Membre non trouvÃ©');
    } else {
      const b=books.find(x=>x.barcode===code||x.isbn===code||(x.isbn||'').replace(/-/g,'')===code);
      if(b){
        if(scanItem&&scanItem.type==='member'){ createLoan(b.id,scanItem.data.id); setScanItem(null); }
        else{ setScanItem({type:'book',data:b}); setScanSt(`âœ… Livre: ${b.title}`); }
      } else setScanSt('âŒ Code non trouvÃ©');
    }
    setScanVal('');
  }

  // â”€â”€ Email notifications â”€â”€
  async function sendLateEmails(){
    const overdueLoans=loans.filter(l=>new Date(l.dueDate)<new Date());
    if(!overdueLoans.length){ toast('Aucun retard Ã  notifier','warn','â„¹ï¸'); return; }
    setEmailSending(true);
    let sent=0,failed=0;
    for(const loan of overdueLoans){
      const mb=members.find(m=>m.id===loan.memberId);
      const bk=books.find(b=>b.id===loan.bookId);
      if(!mb||!mb.email) continue;
      const daysLate=Math.ceil((new Date()-new Date(loan.dueDate))/86400000);
      const fee=daysLate*(cfg.feePerDay||10);
      try{
        const res=await fetch(`${SB_URL}/functions/v1/send-late-email`,{
          method:'POST',
          headers:{'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json'},
          body:JSON.stringify({
            to:mb.email,
            memberName:mb.name,
            bookTitle:bk?.title||'?',
            daysLate,
            fee,
            libraryName:cfg.libraryName
          })
        });
        if(res.ok) sent++;
        else failed++;
      }catch(err){ failed++; }
    }
    setEmailSending(false);
    if(sent>0) toast(`${sent} email(s) envoyÃ©(s) !`,'ok','ğŸ“§');
    if(failed>0) toast(`${failed} Ã©chec(s) â€” configurez la fonction Edge`,'warn','âš ï¸');
  }

  // â”€â”€ Export â”€â”€
  async function exportCSV(){
    const bom='\ufeff';
    let csv=bom+'Type,Code,Nom/Titre,Email/Auteur,TÃ©l/ISBN,Statut,Date\n';
    members.forEach(m=>{ csv+=`Membre,"${m.memberCode}","${m.name}","${m.email}","${m.phone||''}",Actif,${new Date(m.joinDate).toLocaleDateString('fr-FR')}\n`; });
    books.forEach(b=>{ csv+=`Livre,"${b.barcode}","${b.title}","${b.author}","${b.isbn||''}","${b.available}/${b.copies}",${new Date(b.addedDate).toLocaleDateString('fr-FR')}\n`; });
    history.forEach(l=>{
      const bk=books.find(x=>x.id===l.bookId),mb=members.find(x=>x.id===l.memberId);
      csv+=`PrÃªt,"${l.id}","${bk?.title||''}","${mb?.name||''}","${new Date(l.dueDate).toLocaleDateString('fr-FR')}","${l.returnDate?'RetournÃ©':'En cours'}",${new Date(l.loanDate).toLocaleDateString('fr-FR')}\n`;
    });
    dlBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}),`bibliotheque-${today()}.csv`);
    toast('Export CSV tÃ©lÃ©chargÃ© !');
  }
  async function exportJSON(){
    const data={members,books,loans:history,settings:cfg,exportDate:new Date().toISOString()};
    dlBlob(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),`backup-${today()}.json`);
    toast('Sauvegarde tÃ©lÃ©chargÃ©e !');
  }
  function importJSON(e){
    const file=e.target.files[0]; if(!file) return;
    const r=new FileReader();
    r.onload=ev=>{ try{
      const d=JSON.parse(ev.target.result);
      if(d.members) sd('lib_members',d.members);
      if(d.books) sd('lib_books',d.books);
      if(d.loans) sd('lib_loans',d.loans);
      if(d.settings) localStorage.setItem('lib_cfg',JSON.stringify(d.settings));
      reload(); toast('DonnÃ©es importÃ©es !');
    }catch{ toast('Fichier invalide','err','âŒ'); } };
    r.readAsText(file,'UTF-8'); e.target.value='';
  }

  // â”€â”€ Zotero â”€â”€
  function handleZFile(e){
    const file=e.target.files[0]; if(!file) return;
    setZst('Analyse en cours...'); setZp([]);
    const r=new FileReader();
    r.onload=ev=>{
      const txt=ev.target.result,ext=file.name.split('.').pop().toLowerCase();
      let parsed=[];
      if(ext==='bib') parsed=parseBib(txt);
      else if(ext==='ris') parsed=parseRIS(txt);
      else if(ext==='csv') parsed=parseCSV(txt);
      else{ setZst('âŒ Format non supportÃ© (.bib, .ris, .csv)'); return; }
      if(!parsed.length) setZst('âŒ Aucune rÃ©fÃ©rence trouvÃ©e.');
      else{ setZp(parsed.map((b,i)=>({...b,_s:true,_i:i}))); setZst(`âœ… ${parsed.length} rÃ©fÃ©rence(s) trouvÃ©e(s)`); }
    };
    r.readAsText(file,'UTF-8'); e.target.value='';
  }
  async function doZotero(){
    const toImport=zp.filter(b=>b._s);
    if(!toImport.length){ toast('SÃ©lectionnez au moins un livre','err','âš ï¸'); return; }
    try{
      const all=await DB.getBooks();
      let maxN=all.reduce((mx,b)=>Math.max(mx,parseInt((b.barcode||'').replace('BOOK-','')||0)),0);
      let skip=0; const nb=[];
      toImport.forEach(b=>{
        if(all.find(x=>x.title?.toLowerCase()===b.title?.toLowerCase()&&x.author?.toLowerCase()===b.author?.toLowerCase())){ skip++; return; }
        maxN++;
        nb.push({title:b.title,author:b.author,isbn:b.isbn,publisher:b.publisher,year:b.year,category:b.category,description:b.description,shelf:'',copies:1,available:1,id:gid(),barcode:`BOOK-${String(maxN).padStart(4,'0')}`,addedDate:new Date().toISOString()});
      });
      if(nb.length) await DB.bulkAddBooks(nb);
      reload(); setZp([]); setZst(''); close();
      toast(skip>0?`${nb.length} importÃ©(s), ${skip} doublon(s)`:`${nb.length} livre(s) importÃ©(s) !`,skip>0?'warn':'ok','ğŸ“š');
    }catch(e){ toast(e.message,'err','âŒ'); }
  }

  // â”€â”€ Print card (iframe â€” identique Ã  l'aperÃ§u) â”€â”€
  function printCard(member){
    const qr=`https://api.qrserver.com/v1/create-qr-code/?size=130x130&data=${encodeURIComponent(member.memberCode)}&bgcolor=ffffff&color=000000`;
    const bar=`https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(member.memberCode)}&code=Code128&dpi=200&bgcolor=FFFFFF`;
    const lib=cfg.libraryName;
    const html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
<style>
*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important;margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#1a1f2c;display:flex;justify-content:center;padding:30px;min-height:100vh}
@page{size:90mm 145mm;margin:0}
@media print{body{background:#1a1f2c!important;padding:6mm}}
</style></head><body>
<div style="width:340px;background:linear-gradient(145deg,#1a1f2c,#0d0f14);border-radius:18px;overflow:hidden;box-shadow:0 16px 48px rgba(0,0,0,.6);border:1px solid rgba(201,168,76,.2)">
  <div style="background:linear-gradient(135deg,rgba(201,168,76,.18),rgba(201,168,76,.06));padding:18px 22px;display:flex;align-items:center;gap:14px;border-bottom:1px solid rgba(201,168,76,.15)">
    ${cfg.libraryLogo
      ?`<img src="${cfg.libraryLogo}" style="width:46px;height:46px;border-radius:10px;object-fit:cover;border:1px solid rgba(201,168,76,.3)">`
      :`<div style="width:46px;height:46px;border-radius:10px;background:rgba(201,168,76,.15);display:flex;align-items:center;justify-content:center;font-size:22px;border:1px solid rgba(201,168,76,.25)">ğŸ“š</div>`
    }
    <div>
      <div style="font-size:16px;font-weight:700;color:#e8c97a;letter-spacing:.02em">${lib}</div>
      <div style="font-size:10px;color:rgba(255,255,255,.45);margin-top:2px;letter-spacing:.08em;text-transform:uppercase">Carte de Membre</div>
    </div>
  </div>
  <div style="padding:20px 22px">
    <div style="display:flex;gap:16px;align-items:center;margin-bottom:18px">
      ${member.photo
        ?`<img src="${member.photo}" style="width:88px;height:88px;border-radius:50%;border:3px solid rgba(201,168,76,.4);object-fit:cover;flex-shrink:0">`
        :`<div style="width:88px;height:88px;border-radius:50%;border:3px solid rgba(201,168,76,.3);background:rgba(255,255,255,.07);display:flex;align-items:center;justify-content:center;font-size:38px;flex-shrink:0">ğŸ‘¤</div>`
      }
      <div style="flex:1;background:white;border-radius:10px;padding:8px;text-align:center">
        <img src="${qr}" style="width:100px;height:100px;display:block;margin:0 auto">
        <div style="font-size:9px;color:#555;margin-top:4px;letter-spacing:.04em">SCAN RAPIDE</div>
      </div>
    </div>
    <div style="background:rgba(255,255,255,.06);border-radius:10px;padding:12px 15px;margin-bottom:14px;border:1px solid rgba(255,255,255,.08)">
      <div style="font-size:13px;margin:5px 0;color:rgba(255,255,255,.9)"><span style="color:rgba(201,168,76,.8);font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.05em">Nom</span><br>${member.name}</div>
      <div style="font-size:12px;margin:5px 0;color:rgba(255,255,255,.65)"><span style="color:rgba(201,168,76,.7);font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.05em">Email</span><br>${member.email}</div>
      ${member.phone?`<div style="font-size:12px;margin:5px 0;color:rgba(255,255,255,.65)"><span style="color:rgba(201,168,76,.7);font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.05em">TÃ©l</span><br>${member.phone}</div>`:''}
      <div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:6px">Membre depuis ${new Date(member.joinDate).toLocaleDateString('fr-FR')}</div>
    </div>
    <div style="text-align:center;font-size:17px;font-weight:700;letter-spacing:4px;padding:11px;background:linear-gradient(135deg,rgba(201,168,76,.2),rgba(201,168,76,.08));border-radius:9px;border:1px solid rgba(201,168,76,.25);color:#e8c97a;margin-bottom:12px">${member.memberCode}</div>
    <div style="background:white;border-radius:9px;padding:10px;text-align:center">
      <img src="${bar}" style="height:50px;max-width:100%;display:block;margin:0 auto">
      <div style="font-size:9px;color:#666;margin-top:4px;letter-spacing:3px">${member.memberCode}</div>
    </div>
  </div>
</div>
</body></html>`;
    let iframe=document.getElementById('_pf');
    if(!iframe){
      iframe=document.createElement('iframe');
      iframe.id='_pf';
      iframe.style.cssText='position:fixed;top:-9999px;left:-9999px;width:480px;height:700px;border:none;';
      document.body.appendChild(iframe);
    }
    iframe.onload=()=>{
      const imgs=iframe.contentDocument.querySelectorAll('img');
      let done=0;
      const tryPrint=()=>{ if(++done>=imgs.length) setTimeout(()=>iframe.contentWindow.print(),300); };
      if(!imgs.length) setTimeout(()=>iframe.contentWindow.print(),300);
      else imgs.forEach(img=>{ if(img.complete) tryPrint(); else{ img.onload=tryPrint; img.onerror=tryPrint; } });
    };
    iframe.srcdoc=html;
  }

  // â”€â”€ Computed â”€â”€
  const fMembers=members.filter(m=>(m.name||'').toLowerCase().includes(search.toLowerCase())||(m.email||'').toLowerCase().includes(search.toLowerCase())||(m.memberCode||'').toLowerCase().includes(search.toLowerCase()));
  const fBooks=books.filter(b=>{
    const ms=(b.title||'').toLowerCase().includes(search.toLowerCase())||(b.author||'').toLowerCase().includes(search.toLowerCase())||(b.isbn||'').toLowerCase().includes(search.toLowerCase())||(b.barcode||'').toLowerCase().includes(search.toLowerCase());
    return ms&&(catF==='all'||b.category===catF);
  });
  const cStats=CATS.reduce((a,c)=>({...a,[c]:books.filter(b=>b.category===c).length}),{});
  const overdue=loans.filter(l=>new Date(l.dueDate)<new Date());

  // â”€â”€ Auth gate â”€â”€
  if(!authReady) return null;
  if(!session) return <Login onLogin={handleLogin}/>;

  // â”€â”€ Loading â”€â”€
  if(loading) return(
    <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100vh',gap:18,background:'var(--bg)'}}>
      <div style={{fontSize:'2.8em'}}>ğŸ“š</div>
      <div style={{display:'flex',alignItems:'center',gap:12,color:'var(--text3)',fontSize:'.9em'}}>
        <span className="spinner"/>Chargement{USE_SB?' depuis Supabase':''}â€¦
      </div>
    </div>
  );

  const userEmail=session?.user?.email||'Admin';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  return(
  <div className="shell">
    <Toasts list={toasts}/>

    {/* â”€â”€ Sidebar â”€â”€ */}
    <aside className="sidebar">
      <div className="sb-head">
        <div className="sb-logo-row">
          {cfg.libraryLogo
            ?<img src={cfg.libraryLogo} className="sb-logo" style={{display:'block'}} alt=""/>
            :<div className="sb-logo">ğŸ“š</div>
          }
          <div>
            <div className="sb-libname">{cfg.libraryName}</div>
            <div className="sb-dot">
              <span className={USE_SB?'':'off'}/>
              {USE_SB?'Cloud Supabase':'Mode local'}
            </div>
          </div>
        </div>
      </div>

      <nav className="sb-nav">
        <div className="sb-sec">Navigation</div>
        {[
          {k:'dashboard',i:'ğŸ“Š',l:'Tableau de bord'},
          {k:'scanner',i:'ğŸ”',l:'Scanner USB'},
        ].map(item=>(
          <button key={item.k} className={`nbtn${tab===item.k?' active':''}`} onClick={()=>{setTab(item.k);setSearch('');setCatF('all');}}>
            <span className="ni">{item.i}</span><span className="nl">{item.l}</span>
          </button>
        ))}
        <div className="sb-sec">Gestion</div>
        {[
          {k:'members',i:'ğŸ‘¥',l:'Membres',n:members.length},
          {k:'books',i:'ğŸ“š',l:'Livres',n:books.length},
          {k:'loans',i:'ğŸ“–',l:'PrÃªts actifs',n:loans.length},
          {k:'history',i:'ğŸ—‚ï¸',l:'Historique',n:history.length},
        ].map(item=>(
          <button key={item.k} className={`nbtn${tab===item.k?' active':''}`} onClick={()=>{setTab(item.k);setSearch('');setCatF('all');}}>
            <span className="ni">{item.i}</span>
            <span className="nl">{item.l}</span>
            <span className={`nbadge${tab===item.k?' active':''}`}>{item.n}</span>
          </button>
        ))}
      </nav>

      <div className="sb-foot">
        <div className="sb-foot-row">
          <button className="sb-foot-btn" onClick={exportCSV}>ğŸ“Š CSV</button>
          <button className="sb-foot-btn" onClick={exportJSON}>ğŸ’¾ Backup</button>
          <input type="file" accept=".json" ref={importRef} style={{display:'none'}} onChange={importJSON}/>
          <button className="sb-foot-btn" onClick={()=>importRef.current.click()}>ğŸ“¥</button>
        </div>
        <button className="sb-foot-btn" onClick={()=>setModal('settings')}>âš™ï¸ ParamÃ¨tres</button>
        <button className="sb-foot-btn zotero" onClick={()=>{setZp([]);setZst('');setModal('zotero');}}>ğŸ“¥ Importer depuis Zotero</button>
        <div style={{fontSize:'.7em',color:'var(--text3)',textAlign:'center',padding:'4px 0'}}>
          {userEmail}
        </div>
        <button className="sb-foot-btn logout" onClick={handleLogout}>ğŸšª DÃ©connexion</button>
      </div>
    </aside>

    {/* â”€â”€ Main â”€â”€ */}
    <main className="main">

      {/* â”€â”€ DASHBOARD â”€â”€ */}
      {tab==='dashboard'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Tableau de bord</h1>
            <div style={{display:'flex',gap:9}}>
              {overdue.length>0&&<button className={`btn btn-email btn-sm${emailSending?' disabled':''}`} onClick={sendLateEmails} disabled={emailSending}>
                {emailSending?<span className="spinner"/>:'ğŸ“§'} Notifier retards ({overdue.length})
              </button>}
              <button className="btn btn-secondary btn-sm" onClick={reload}>ğŸ”„ Actualiser</button>
            </div>
          </div>
          {overdue.length>0&&<div className="al al-w au2">âš ï¸ <strong>{overdue.length} prÃªt(s) en retard</strong> â€” cliquez "Notifier retards" pour envoyer des emails</div>}
          <div className="stats au2">
            <div className="sc blue"><div className="sn">{members.length}</div><div className="sl">Membres</div></div>
            <div className="sc green"><div className="sn">{books.length}</div><div className="sl">Livres</div></div>
            <div className="sc purple"><div className="sn">{loans.length}</div><div className="sl">PrÃªts actifs</div></div>
            <div className="sc orange"><div className="sn">{books.reduce((s,b)=>s+(b.available||0),0)}</div><div className="sl">Disponibles</div></div>
            <div className="sc red"><div className="sn">{overdue.length}</div><div className="sl">En retard</div></div>
            <div className="sc gold"><div className="sn">{history.length}</div><div className="sl">Total prÃªts</div></div>
          </div>
          <h2 style={{fontFamily:"'Fraunces',serif",fontSize:'1.25em',marginBottom:14,color:'var(--text2)',fontWeight:400}} className="au3">Par catÃ©gorie</h2>
          <div className="cg au3">
            {CATS.map(c=><div key={c} className="cc" onClick={()=>{setTab('books');setCatF(c);}}>
              <div className="cn">{cStats[c]||0}</div><div className="cl">{c}</div>
            </div>)}
          </div>
          {overdue.length>0&&<>
            <h2 style={{fontFamily:"'Fraunces',serif",fontSize:'1.25em',marginBottom:14,color:'var(--red)',fontWeight:400}} className="au4">âš ï¸ PrÃªts en retard</h2>
            <div className="grid au4">
              {overdue.map(loan=>{
                const mb=members.find(m=>m.id===loan.memberId),bk=books.find(b=>b.id===loan.bookId);
                const dl=Math.ceil((new Date()-new Date(loan.dueDate))/86400000);
                return(<div key={loan.id} className="card late">
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:14}}>
                    <div>
                      <div className="ct">{bk?.title||'?'}</div>
                      <div className="cs">ğŸ‘¤ {mb?.name} â€” {mb?.email}</div>
                      <div style={{color:'var(--red)',fontWeight:700,marginTop:6,fontSize:'.88em'}}>âš ï¸ {dl}j de retard â€” {dl*(cfg.feePerDay||10)} HTG</div>
                    </div>
                    <button className="btn btn-success btn-sm" onClick={()=>returnLoan(loan.id)}>âœ“ Retourner</button>
                  </div>
                </div>);
              })}
            </div>
          </>}
        </div>
      )}

      {/* â”€â”€ SCANNER â”€â”€ */}
      {tab==='scanner'&&(
        <div>
          <div className="ph au"><h1 className="pt">Scanner USB</h1></div>
          <div className="scan-box au2">
            <h2 style={{fontSize:'1.2em',marginBottom:8,color:'var(--gold2)'}}>ğŸ” Zone de scan</h2>
            <p style={{color:'var(--text3)',marginBottom:14,fontSize:'.87em'}}>Scannez la carte membre puis le livre pour crÃ©er un prÃªt automatiquement</p>
            <input ref={scanRef} type="text" className="scan-in" value={scanVal} onChange={e=>setScanVal(e.target.value)} onKeyPress={handleScan} placeholder="Pointez votre scanner ici et appuyez EntrÃ©eâ€¦" autoFocus/>
            {scanSt&&<div className="scan-st">{scanSt}</div>}
          </div>
          {scanItem&&<div className="al al-s au">
            {scanItem.type==='member'
              ?<><strong>ğŸ‘¤ {scanItem.data.name}</strong> â€” Scannez maintenant un livre</>
              :<><strong>ğŸ“š {scanItem.data.title}</strong> â€” Scannez la carte membre</>
            }
            <button className="btn btn-secondary btn-sm" style={{marginLeft:'auto'}} onClick={()=>setScanItem(null)}>Annuler</button>
          </div>}
          <div className="card au3">
            <h3 style={{fontWeight:700,marginBottom:14,color:'var(--text2)',fontSize:'.9em',textTransform:'uppercase',letterSpacing:'.05em'}}>ğŸ’¡ PrÃªt manuel</h3>
            <div style={{display:'flex',gap:10,flexWrap:'wrap',alignItems:'center'}}>
              <select className="fsel" id="man-m" style={{flex:1}}>
                <option value="">â€” SÃ©lectionner un membre â€”</option>
                {members.map(m=><option key={m.id} value={m.id}>{m.name} ({m.memberCode})</option>)}
              </select>
              <select className="fsel" id="man-b" style={{flex:1}}>
                <option value="">â€” SÃ©lectionner un livre disponible â€”</option>
                {books.filter(b=>b.available>0).map(b=><option key={b.id} value={b.id}>{b.title} ({b.available} dispo)</option>)}
              </select>
              <button className="btn btn-primary" onClick={()=>{
                const mId=parseInt(document.getElementById('man-m').value);
                const bId=parseInt(document.getElementById('man-b').value);
                if(!mId||!bId){toast('SÃ©lectionnez un membre et un livre','err','âš ï¸');return;}
                createLoan(bId,mId);
              }}>ğŸ“– CrÃ©er le prÃªt</button>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ MEMBERS â”€â”€ */}
      {tab==='members'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Membres</h1>
            <button className="btn btn-primary" onClick={()=>{setMf({name:'',email:'',phone:'',address:'',dateOfBirth:'',idNumber:'',photo:''});setEditM(null);setModal('member');}}>â• Nouveau membre</button>
          </div>
          <div className="sw au2"><span className="sw-icon">ğŸ”</span><input type="text" className="sbar" placeholder="Rechercher nom, email, codeâ€¦" value={search} onChange={e=>setSearch(e.target.value)}/></div>
          {fMembers.length===0?<div className="empty au3"><div className="empty-i">ğŸ‘¥</div><div>Aucun membre trouvÃ©</div></div>:
          <div className="grid au3">
            {fMembers.map(m=>{
              const ml=loans.filter(l=>l.memberId===m.id);
              return(<div key={m.id} className="card">
                <div style={{display:'flex',justifyContent:'space-between',gap:16}}>
                  <div style={{display:'flex',gap:14,alignItems:'center',flex:1}}>
                    {m.photo?<img src={m.photo} className="av" style={{display:'block'}} alt=""/>:<div className="av">ğŸ‘¤</div>}
                    <div style={{flex:1}}>
                      <div className="ct">{m.name}</div>
                      <div className="cs">ğŸ“§ {m.email}</div>
                      {m.phone&&<div className="cs">ğŸ“ {m.phone}</div>}
                      <div className="cm">
                        <span className="b bgold">{m.memberCode}</span>
                        {ml.length>0&&<span className="b bb">{ml.length} prÃªt(s)</span>}
                      </div>
                    </div>
                  </div>
                  <img src={`https://api.qrserver.com/v1/create-qr-code/?size=90x90&data=${encodeURIComponent(m.memberCode)}&bgcolor=ffffff`} className="qr" alt="QR"/>
                </div>
                <div className="ca">
                  <button className="btn btn-primary btn-sm" onClick={()=>printCard(m)}>ğŸ–¨ï¸ Carte</button>
                  <button className="btn btn-secondary btn-sm" onClick={()=>openEditM(m)}>âœï¸ Modifier</button>
                  <button className="btn btn-ghost btn-sm" style={{marginLeft:'auto',color:'var(--red)'}} onClick={()=>delMember(m.id)}>ğŸ—‘ï¸</button>
                </div>
              </div>);
            })}
          </div>}
        </div>
      )}

      {/* â”€â”€ BOOKS â”€â”€ */}
      {tab==='books'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Livres</h1>
            <div style={{display:'flex',gap:9}}>
              <button className="btn btn-secondary" onClick={()=>{setZp([]);setZst('');setModal('zotero');}}>ğŸ“¥ Zotero</button>
              <button className="btn btn-primary" onClick={()=>{setBf({title:'',author:'',isbn:'',year:'',category:'Fiction',publisher:'',shelf:'',copies:1,description:''});setEditB(null);setModal('book');}}>â• Nouveau livre</button>
            </div>
          </div>
          <div className="fbar au2">
            <div className="sw" style={{flex:1,marginBottom:0}}>
              <span className="sw-icon">ğŸ”</span>
              <input type="text" className="sbar" style={{marginBottom:0}} placeholder="Titre, auteur, ISBN, code-barresâ€¦" value={search} onChange={e=>setSearch(e.target.value)}/>
            </div>
            <select className="fsel" value={catF} onChange={e=>setCatF(e.target.value)}>
              <option value="all">ğŸ·ï¸ Toutes catÃ©gories</option>
              {CATS.map(c=><option key={c} value={c}>{c} ({cStats[c]||0})</option>)}
            </select>
          </div>
          {fBooks.length===0?<div className="empty au3"><div className="empty-i">ğŸ“š</div><div>Aucun livre trouvÃ©</div></div>:
          <div className="grid au3">
            {fBooks.map(bk=>(
              <div key={bk.id} className="card">
                <div style={{display:'flex',justifyContent:'space-between',gap:16}}>
                  <div style={{flex:1}}>
                    <div className="ct">{bk.title}</div>
                    <div className="cs">âœï¸ {bk.author}{bk.year?` Â· ${bk.year}`:''}</div>
                    {bk.isbn&&<div className="cs">ISBN: {bk.isbn}</div>}
                    <div className="cm">
                      {bk.category&&<span className="b bb">{bk.category}</span>}
                      {bk.shelf&&<span className="b bo">ğŸ“ {bk.shelf}</span>}
                      <span className={`b ${bk.available>0?'bg':'br'}`}>{bk.available}/{bk.copies} dispo</span>
                      <span className="b bk">{bk.barcode}</span>
                    </div>
                    {bk.description&&<div style={{fontSize:'.82em',color:'var(--text3)',marginTop:8,lineHeight:1.5}}>{bk.description.substring(0,110)}{bk.description.length>110?'â€¦':''}</div>}
                  </div>
                  <img src={`https://api.qrserver.com/v1/create-qr-code/?size=90x90&data=${encodeURIComponent(bk.barcode)}&bgcolor=ffffff`} className="qr" alt="QR"/>
                </div>
                <div className="ca">
                  {bk.available>0&&members.length>0&&(
                    <select className="fsel" style={{flex:1}} onChange={e=>{if(e.target.value){createLoan(bk.id,parseInt(e.target.value));e.target.value=''}}}>
                      <option value="">ğŸ“– PrÃªter Ã â€¦</option>
                      {members.map(m=><option key={m.id} value={m.id}>{m.name}</option>)}
                    </select>
                  )}
                  <button className="btn btn-secondary btn-sm" onClick={()=>openEditB(bk)}>âœï¸</button>
                  <button className="btn btn-ghost btn-sm" style={{color:'var(--red)'}} onClick={()=>delBook(bk.id)}>ğŸ—‘ï¸</button>
                </div>
              </div>
            ))}
          </div>}
        </div>
      )}

      {/* â”€â”€ LOANS â”€â”€ */}
      {tab==='loans'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">PrÃªts actifs</h1>
            {overdue.length>0&&<span className="b br" style={{fontSize:'.9em',padding:'6px 14px'}}>âš ï¸ {overdue.length} en retard</span>}
          </div>
          {loans.length===0?<div className="empty au2"><div className="empty-i">ğŸ“–</div><div>Aucun prÃªt actif</div></div>:
          <div className="grid au2">
            {loans.map(loan=>{
              const mb=members.find(m=>m.id===loan.memberId),bk=books.find(b=>b.id===loan.bookId);
              const dud=Math.ceil((new Date(loan.dueDate)-new Date())/86400000);
              const late=dud<0;
              return(<div key={loan.id} className={`card${late?' late':''}`}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'start',gap:14}}>
                  <div style={{flex:1}}>
                    <div className="ct">{bk?.title||'?'}</div>
                    <div className="cs">ğŸ‘¤ {mb?.name||'?'} â€” {mb?.email}</div>
                    <div className="cs">ğŸ“… PrÃªt: {new Date(loan.loanDate).toLocaleDateString('fr-FR')}</div>
                    <div style={{marginTop:7,fontWeight:700,fontSize:'.88em',color:late?'var(--red)':'var(--green)'}}>
                      {late?`âš ï¸ ${Math.abs(dud)}j retard â€” ${Math.abs(dud)*(cfg.feePerDay||10)} HTG`:`âœ… Retour: ${new Date(loan.dueDate).toLocaleDateString('fr-FR')} (${dud}j restants)`}
                    </div>
                  </div>
                  <button className="btn btn-success" onClick={()=>returnLoan(loan.id)}>âœ“ Retourner</button>
                </div>
              </div>);
            })}
          </div>}
        </div>
      )}

      {/* â”€â”€ HISTORY â”€â”€ */}
      {tab==='history'&&(
        <div>
          <div className="ph au">
            <h1 className="pt">Historique</h1>
            <button className="btn btn-secondary" onClick={exportCSV}>ğŸ“Š Export CSV</button>
          </div>
          {history.length===0?<div className="empty au2"><div className="empty-i">ğŸ—‚ï¸</div><div>Aucun historique</div></div>:
          <div className="grid au2">
            {[...history].reverse().map(loan=>{
              const mb=members.find(m=>m.id===loan.memberId),bk=books.find(b=>b.id===loan.bookId);
              return(<div key={loan.id} className="card">
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',gap:14}}>
                  <div>
                    <div className="ct" style={{fontSize:'1em'}}>{bk?.title||'?'}</div>
                    <div className="cs">ğŸ‘¤ {mb?.name||'?'}</div>
                    <div className="cs">ğŸ“… {new Date(loan.loanDate).toLocaleDateString('fr-FR')}{loan.returnDate?` â†’ ${new Date(loan.returnDate).toLocaleDateString('fr-FR')}`:''}</div>
                    {loan.daysLate>0&&<div style={{fontSize:'.82em',color:'var(--red)',fontWeight:600,marginTop:4}}>{loan.daysLate}j retard â€” {loan.lateFee} HTG</div>}
                  </div>
                  <span className={`b ${loan.returnDate?'bg':'bb'}`}>{loan.returnDate?'âœ“ RetournÃ©':'ğŸ“– En cours'}</span>
                </div>
              </div>);
            })}
          </div>}
        </div>
      )}

    </main>

    {/* â•â•â•â• MODALS â•â•â•â• */}

    {/* Settings */}
    {modal==='settings'&&(
      <div className="ov" onClick={close}>
        <div className="mc" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">âš™ï¸ ParamÃ¨tres</h2><button className="xb" onClick={close}>Ã—</button></div>
          <div className="ss">
            <h3>ğŸ›ï¸ BibliothÃ¨que</h3>
            <div className="fg"><label className="fl">Nom</label><input className="fi" value={cfg.libraryName} onChange={e=>setCfg({...cfg,libraryName:e.target.value})}/></div>
            <div className="fg"><label className="fl">Logo</label>
              <input ref={logoRef} type="file" accept="image/*" style={{display:'none'}} onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onloadend=()=>setCfg(s=>({...s,libraryLogo:r.result}));r.readAsDataURL(f);}}/>
              <button className="btn btn-secondary" style={{width:'100%'}} onClick={()=>logoRef.current.click()}>ğŸ“· Choisir logo</button>
              {cfg.libraryLogo&&<img src={cfg.libraryLogo} style={{width:70,height:70,borderRadius:'50%',objectFit:'cover',marginTop:10,border:'2px solid rgba(201,168,76,.4)'}} alt=""/>}
            </div>
          </div>
          <div className="ss">
            <h3>ğŸ“– RÃ¨gles de prÃªt</h3>
            <div className="fgrid">
              <div className="fg"><label className="fl">DurÃ©e (jours)</label><input className="fi" type="number" min="1" value={cfg.loanDays||14} onChange={e=>setCfg({...cfg,loanDays:parseInt(e.target.value)})}/></div>
              <div className="fg"><label className="fl">PÃ©nalitÃ©/jour (HTG)</label><input className="fi" type="number" min="0" value={cfg.feePerDay||10} onChange={e=>setCfg({...cfg,feePerDay:parseInt(e.target.value)})}/></div>
            </div>
          </div>
          <div className="ss">
            <h3>â˜ï¸ Base de donnÃ©es</h3>
            <div style={{padding:'10px 14px',background:USE_SB?'rgba(76,175,125,.08)':'rgba(240,144,64,.08)',border:`1px solid ${USE_SB?'rgba(76,175,125,.2)':'rgba(240,144,64,.2)'}`,borderRadius:'var(--rs)',marginBottom:13,fontSize:'.85em',color:USE_SB?'var(--green)':'var(--orange)'}}>
              {USE_SB?'ğŸŸ¢ Supabase connectÃ© â€” donnÃ©es dans le cloud':'ğŸŸ¡ Mode local (localStorage)'}
            </div>
            <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
              <button className="btn btn-secondary btn-sm" onClick={exportJSON}>ğŸ’¾ Sauvegarder</button>
              <button className="btn btn-secondary btn-sm" onClick={()=>importRef.current.click()}>ğŸ“¥ Restaurer</button>
              <button className="btn btn-danger btn-sm" style={{marginLeft:'auto'}} onClick={()=>{if(confirm('Supprimer TOUTES les donnÃ©es ?')){['lib_members','lib_books','lib_loans'].forEach(k=>localStorage.removeItem(k));reload();close();toast('DonnÃ©es effacÃ©es','warn','ğŸ—‘ï¸');}}}>ğŸ—‘ï¸ Tout effacer</button>
            </div>
          </div>
          <div className="ss">
            <h3>ğŸ“§ Notifications email</h3>
            <div style={{fontSize:'.83em',color:'var(--text3)',lineHeight:1.6,marginBottom:12}}>
              Pour activer les emails automatiques, configurez une <strong style={{color:'var(--text2)'}}>Edge Function Supabase</strong> nommÃ©e <code style={{background:'var(--surf2)',padding:'1px 6px',borderRadius:4,color:'var(--blue)'}}>send-late-email</code> avec Resend ou SendGrid.
              <br/>Le bouton "Notifier retards" sur le tableau de bord fonctionne manuellement dÃ¨s maintenant.
            </div>
            <button className="btn btn-email btn-sm" onClick={()=>{close();sendLateEmails();}}>ğŸ“§ Tester l'envoi d'emails</button>
          </div>
          <div className="fac">
            <button className="btn btn-primary" style={{flex:1}} onClick={()=>saveCfg(cfg)}>ğŸ’¾ Sauvegarder</button>
            <button className="btn btn-secondary" onClick={close}>Annuler</button>
          </div>
        </div>
      </div>
    )}

    {/* Member form */}
    {modal==='member'&&(
      <div className="ov" onClick={close}>
        <div className="mc" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">{editM?'âœï¸ Modifier membre':'â• Nouveau membre'}</h2><button className="xb" onClick={close}>Ã—</button></div>
          <div className="fg"><label className="fl">Photo</label>
            <input ref={photoRef} type="file" accept="image/*" style={{display:'none'}} onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onloadend=()=>setMf(prev=>({...prev,photo:r.result}));r.readAsDataURL(f);}}/>
            <div className="pu" onClick={()=>photoRef.current.click()}>
              {mf.photo?<img src={mf.photo} className="pp" alt=""/>:<><div style={{fontSize:'2em',marginBottom:7}}>ğŸ“·</div><div style={{color:'var(--text3)',fontSize:'.84em'}}>Cliquez pour ajouter une photo</div></>}
            </div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">Nom complet *</label><input className="fi" value={mf.name} onChange={e=>setMf({...mf,name:e.target.value})} placeholder="Jean Dupont"/></div>
            <div className="fg"><label className="fl">Email *</label><input className="fi" type="email" value={mf.email} onChange={e=>setMf({...mf,email:e.target.value})} placeholder="jean@email.com"/></div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">TÃ©lÃ©phone</label><input className="fi" type="tel" value={mf.phone} onChange={e=>setMf({...mf,phone:e.target.value})} placeholder="+509 1234 5678"/></div>
            <div className="fg"><label className="fl">NÂ° d'identitÃ©</label><input className="fi" value={mf.idNumber} onChange={e=>setMf({...mf,idNumber:e.target.value})} placeholder="CIN/NIF"/></div>
          </div>
          <div className="fg"><label className="fl">Adresse</label><textarea className="ft" value={mf.address} onChange={e=>setMf({...mf,address:e.target.value})} placeholder="123 Rue Example"/></div>
          <div className="fg"><label className="fl">Date de naissance</label><input className="fi" type="date" value={mf.dateOfBirth} onChange={e=>setMf({...mf,dateOfBirth:e.target.value})}/></div>
          <div className="fac">
            <button className="btn btn-primary" style={{flex:1}} onClick={saveMember}>âœ“ Enregistrer</button>
            <button className="btn btn-secondary" onClick={close}>Annuler</button>
          </div>
        </div>
      </div>
    )}

    {/* Book form */}
    {modal==='book'&&(
      <div className="ov" onClick={close}>
        <div className="mc" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">{editB?'âœï¸ Modifier livre':'â• Nouveau livre'}</h2><button className="xb" onClick={close}>Ã—</button></div>
          <div className="fgrid">
            <div className="fg"><label className="fl">Titre *</label><input className="fi" value={bf.title} onChange={e=>setBf({...bf,title:e.target.value})} placeholder="Titre du livre"/></div>
            <div className="fg"><label className="fl">Auteur *</label><input className="fi" value={bf.author} onChange={e=>setBf({...bf,author:e.target.value})} placeholder="Auteur"/></div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">ISBN</label><input className="fi" value={bf.isbn} onChange={e=>setBf({...bf,isbn:e.target.value})} placeholder="978-XXXXXXXXXX"/></div>
            <div className="fg"><label className="fl">AnnÃ©e</label><input className="fi" value={bf.year} onChange={e=>setBf({...bf,year:e.target.value})} placeholder="2024"/></div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">CatÃ©gorie</label>
              <select className="fsel fi" value={bf.category} onChange={e=>setBf({...bf,category:e.target.value})}>
                {CATS.map(c=><option key={c} value={c}>{c}</option>)}
              </select>
            </div>
            <div className="fg"><label className="fl">Cote</label><input className="fi" value={bf.shelf} onChange={e=>setBf({...bf,shelf:e.target.value})} placeholder="A-12"/></div>
          </div>
          <div className="fgrid">
            <div className="fg"><label className="fl">Ã‰diteur</label><input className="fi" value={bf.publisher} onChange={e=>setBf({...bf,publisher:e.target.value})} placeholder="Ã‰diteur"/></div>
            <div className="fg"><label className="fl">Exemplaires</label><input className="fi" type="number" min="1" value={bf.copies} onChange={e=>setBf({...bf,copies:e.target.value})}/></div>
          </div>
          <div className="fg"><label className="fl">Description</label><textarea className="ft" value={bf.description} onChange={e=>setBf({...bf,description:e.target.value})} placeholder="RÃ©sumÃ© du livreâ€¦"/></div>
          <div className="fac">
            <button className="btn btn-primary" style={{flex:1}} onClick={saveBook}>âœ“ Enregistrer</button>
            <button className="btn btn-secondary" onClick={close}>Annuler</button>
          </div>
        </div>
      </div>
    )}

    {/* Zotero */}
    {modal==='zotero'&&(
      <div className="ov" onClick={()=>{close();setZp([]);setZst('');}}>
        <div className="mc wide" onClick={e=>e.stopPropagation()}>
          <div className="mh"><h2 className="mt">ğŸ“¥ Importer depuis Zotero</h2><button className="xb" onClick={()=>{close();setZp([]);setZst('');}}>Ã—</button></div>
          <div className="al al-i" style={{flexDirection:'column',alignItems:'start',gap:7}}>
            <div style={{fontWeight:700,fontSize:'.9em'}}>Comment exporter depuis Zotero :</div>
            <ol style={{paddingLeft:18,fontSize:'.83em',lineHeight:2.2,color:'var(--text2)'}}>
              <li>SÃ©lectionnez vos rÃ©fÃ©rences (<strong>Ctrl+A</strong> pour tout)</li>
              <li>Clic droit â†’ <strong>Exporter les Ã©lÃ©mentsâ€¦</strong></li>
              <li>Choisissez <strong>BibTeX</strong>, <strong>RIS</strong> ou <strong>CSV</strong></li>
              <li>Importez le fichier ici</li>
            </ol>
          </div>
          <input ref={zRef} type="file" accept=".bib,.ris,.csv" style={{display:'none'}} onChange={handleZFile}/>
          <div className="zdrop" onClick={()=>zRef.current.click()}>
            <div style={{fontSize:'2.4em',marginBottom:8}}>ğŸ“‚</div>
            <div style={{fontWeight:700,color:'var(--text)',marginBottom:3}}>Cliquez pour choisir un fichier</div>
            <div style={{fontSize:'.8em',color:'var(--text3)'}}>Formats acceptÃ©s : .bib Â· .ris Â· .csv</div>
          </div>
          {zst&&<div className={`al ${zst.startsWith('âŒ')?'al-w':'al-s'}`}>{zst}</div>}
          {zp.length>0&&<>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
              <div style={{fontWeight:700,fontSize:'.9em',color:'var(--text2)'}}>{zp.filter(b=>b._s).length} / {zp.length} sÃ©lectionnÃ©e(s)</div>
              <div style={{display:'flex',gap:7}}>
                <button className="btn btn-secondary btn-sm" onClick={()=>setZp(p=>p.map(b=>({...b,_s:true})))}>Tout</button>
                <button className="btn btn-ghost btn-sm" onClick={()=>setZp(p=>p.map(b=>({...b,_s:false})))}>Aucun</button>
              </div>
            </div>
            <div className="zlist">
              {zp.map((bk,i)=>(
                <div key={i} className={`zrow${bk._s?' sel':''}`} onClick={()=>setZp(p=>p.map((b,j)=>j===i?{...b,_s:!b._s}:b))}>
                  <input type="checkbox" checked={bk._s} onChange={()=>{}} style={{width:15,height:15,marginTop:3,accentColor:'var(--gold)',flexShrink:0,cursor:'pointer'}} onClick={e=>e.stopPropagation()}/>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontWeight:600,color:'var(--text)',fontSize:'.9em',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{bk.title}</div>
                    <div style={{fontSize:'.78em',color:'var(--text3)',marginTop:2}}>{bk.author||'â€”'}{bk.year?` Â· ${bk.year}`:''}</div>
                    <div style={{marginTop:4,display:'flex',gap:5}}><span className="b bb" style={{fontSize:'.7em'}}>{bk.category}</span></div>
                  </div>
                  <select className="fsel" style={{width:120,padding:'4px 8px',fontSize:'.78em',flexShrink:0}} value={bk.category} onClick={e=>e.stopPropagation()} onChange={e=>setZp(p=>p.map((b,j)=>j===i?{...b,category:e.target.value}:b))}>
                    {CATS.map(c=><option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
              ))}
            </div>
            <div className="fac">
              <button className="btn btn-primary" style={{flex:1}} onClick={doZotero}>ğŸ“¥ Importer {zp.filter(b=>b._s).length} livre(s)</button>
              <button className="btn btn-secondary" onClick={()=>{setZp([]);setZst('');}}>Annuler</button>
            </div>
          </>}
        </div>
      </div>
    )}

  </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
